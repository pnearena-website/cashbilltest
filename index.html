<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNE Arena - Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4a6cf7;
            --primary-dark: #2c3e8f;
            --secondary: #f8f9fa;
            --text: #333;
            --border: #eaeaea;
            --success: #2e7d32;
            --warning: #ff8f00;
            --danger: #c62828;
            --admin: #e53935;
            --white: #ffffff;
            --light-gray: #f5f7fa;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --transition: all 0.3s ease;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: var(--white);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        /* Loading Screen */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Login Page - White Clean Theme */
        .login-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background-color: var(--white);
            background-image: linear-gradient(120deg, #f8f9fa 0%, #e9ecef 100%);
        }
        .login-card {
            background-color: var(--white);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 50px 40px;
            width: 100%;
            max-width: 420px;
            text-align: center;
            border: 1px solid var(--border);
        }
        .login-logo {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
        }
        .login-title {
            font-size: 26px;
            margin-bottom: 35px;
            color: var(--text);
            font-weight: 600;
        }
        .form-group {
            margin-bottom: 22px;
            text-align: left;
        }
        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text);
        }
        .form-input {
            width: 100%;
            padding: 14px 18px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
            background-color: var(--white);
        }
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.2);
        }
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-primary {
            background-color: var(--primary);
            color: var(--white);
        }
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        .btn-danger {
            background-color: var(--admin);
            color: var(--white);
        }
        .btn-danger:hover {
            background-color: #c62828;
        }
        .btn-success {
            background-color: var(--success);
            color: var(--white);
        }
        .btn-success:hover {
            background-color: #1b5e20;
        }
        .btn-block {
            width: 100%;
        }
        .alert {
            padding: 14px 18px;
            border-radius: 8px;
            margin-bottom: 22px;
            text-align: left;
        }
        .alert-danger {
            background-color: #ffebee;
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }
        /* Main App Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            display: none;
        }
        /* Top Navigation */
        .top-nav {
            background-color: var(--white);
            box-shadow: var(--shadow);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .nav-logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }
        .nav-toggle {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text);
            cursor: pointer;
        }
        .nav-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-info {
            text-align: right;
        }
        .user-name {
            font-weight: 600;
        }
        .user-role {
            font-size: 14px;
            color: #666;
        }
        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--white);
            box-shadow: var(--shadow);
            position: fixed;
            top: 70px;
            left: 0;
            bottom: 0;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 50;
        }
        .sidebar.hidden {
            transform: translateX(-100%);
        }
        .sidebar-menu {
            padding: 20px 0;
        }
        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--text);
            text-decoration: none;
            transition: var(--transition);
            border-left: 3px solid transparent;
        }
        .menu-item:hover {
            background-color: var(--secondary);
        }
        .menu-item.active {
            background-color: rgba(74, 108, 247, 0.1);
            border-left-color: var(--primary);
            color: var(--primary);
        }
        .menu-item i {
            margin-right: 12px;
            font-size: 18px;
            width: 20px;
            text-align: center;
        }
        .menu-item.admin-only {
            color: var(--admin);
        }
        .menu-item.admin-only:hover {
            background-color: rgba(229, 57, 53, 0.1);
        }
        .menu-item.admin-only.active {
            border-left-color: var(--admin);
            color: var(--admin);
        }
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            margin-left: 250px;
            transition: margin-left 0.3s ease;
            background-color: var(--light-gray);
        }
        .main-content.expanded {
            margin-left: 0;
        }
        .content-header {
            margin-bottom: 20px;
        }
        .content-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .content-subtitle {
            color: #666;
            font-size: 16px;
        }
        .card {
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        .card-title {
            font-size: 20px;
            font-weight: 600;
        }
        /* Dashboard Styles */
        .dashboard-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .info-card {
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 20px;
            text-align: center;
        }
        .info-icon {
            font-size: 32px;
            color: var(--primary);
            margin-bottom: 10px;
        }
        .info-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        .info-value {
            font-size: 24px;
            font-weight: 600;
        }
        .punch-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        .punch-btn {
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            min-width: 150px;
        }
        /* Table Styles */
        .table-container {
            overflow-x: auto;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .data-table th {
            background-color: var(--secondary);
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        .data-table tr:hover {
            background-color: rgba(74, 108, 247, 0.05);
        }
        /* Form Styles */
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-col {
            flex: 1;
            min-width: 250px;
        }
        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-active {
            background-color: #e8f5e9;
            color: var(--success);
        }
        .status-inactive {
            background-color: #ffebee;
            color: var(--danger);
        }
        .status-warning {
            background-color: #fff8e1;
            color: var(--warning);
        }
        /* Schedule Table Styles */
        .schedule-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .week-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .week-btn {
            background-color: var(--white);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            transition: var(--transition);
        }
        .week-btn:hover {
            background-color: var(--secondary);
        }
        .date-picker-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .schedule-table th,
        .schedule-table td {
            padding: 12px;
            border: 1px solid var(--border);
            text-align: center;
            vertical-align: middle;
        }
        .schedule-table th {
            background-color: var(--primary);
            color: var(--white);
            font-weight: 600;
        }
        .schedule-table .employee-info {
            text-align: left;
            padding: 15px;
            width: 200px;
        }
        .schedule-table .day-header {
            background-color: var(--secondary);
            color: var(--text);
            position: sticky;
            top: 0;
        }
        .schedule-cell {
            min-width: 120px;
            height: 100px;
            position: relative;
        }
        .schedule-status {
            padding: 6px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .schedule-working {
            background-color: #e8f5e9;
            color: var(--success);
        }
        .schedule-off {
            background-color: #ffebee;
            color: var(--danger);
        }
        .schedule-leave {
            background-color: #fff8e1;
            color: var(--warning);
        }
        .schedule-cell input, .schedule-cell select {
            margin-bottom: 5px;
            width: 100%;
        }
        .schedule-filters {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            background-color: var(--white);
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }
        .filter-btn.active {
            background-color: var(--primary);
            color: var(--white);
        }
        .schedule-legend {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        .no-schedule {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
        /* Modal Styles - Increased size */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            width: 95%;
            max-width: 800px;
            max-height: 95vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title {
            font-size: 24px;
            font-weight: 600;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
        }
        .modal-body {
            padding: 25px;
        }
        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        /* Activity Log Styles */
        .activity-log-table {
            width: 100%;
            border-collapse: collapse;
        }
        .activity-log-table th,
        .activity-log-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .activity-log-table th {
            background-color: var(--secondary);
            font-weight: 600;
        }
        .activity-log-table tr:hover {
            background-color: rgba(74, 108, 247, 0.05);
        }
        .log-type {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .log-punch-in {
            background-color: #e8f5e9;
            color: var(--success);
        }
        .log-punch-out {
            background-color: #ffebee;
            color: var(--danger);
        }
        .log-break {
            background-color: #fff8e1;
            color: var(--warning);
        }
        .log-late {
            background-color: #e1f5fe;
            color: #0288d1;
        }
        .log-overbreak {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }
        /* Attendance Management Styles */
        .attendance-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .date-filter {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .attendance-table {
            width: 100%;
            border-collapse: collapse;
        }
        .attendance-table th,
        .attendance-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .attendance-table th {
            background-color: var(--secondary);
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        .attendance-table tr:hover {
            background-color: rgba(74, 108, 247, 0.05);
        }
        .attendance-actions {
            display: flex;
            gap: 8px;
        }
        /* Stock Receiving Styles */
        .receiving-item {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background-color: var(--secondary);
        }
        .receiving-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .receiving-item-details {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        .receiving-summary {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                max-width: 300px;
            }
            .main-content {
                margin-left: 0;
            }
            .main-content.expanded {
                margin-left: 0;
            }
            .dashboard-info {
                grid-template-columns: 1fr;
            }
            .form-row {
                flex-direction: column;
            }
            .schedule-controls {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            .attendance-controls {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            .modal-content {
                width: 98%;
                max-width: none;
            }
            .receiving-item-details {
                grid-template-columns: 1fr;
            }
        }
        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            max-width: 400px;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 1000;
        }
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        .notification-icon {
            font-size: 24px;
        }
        .notification-success .notification-icon {
            color: var(--success);
        }
        .notification-error .notification-icon {
            color: var(--danger);
        }
        .notification-message {
            flex: 1;
        }
        .notification-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
        }
        /* Time Input Styles */
        .time-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .time-input {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            width: 100px;
        }
        .time-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
        }
        .status-normal {
            background-color: #e8f5e9;
            color: var(--success);
        }
        .status-late {
            background-color: #e1f5fe;
            color: #0288d1;
        }
        .status-overbreak {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Login Page -->
    <div class="login-container" id="loginPage">
        <div class="login-card">
            <div class="login-logo">PNE ARENA</div>
            <h2 class="login-title">Login to Your Account</h2>
            
            <div id="loginAlert" class="alert alert-danger" style="display: none;"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="userId">User ID</label>
                    <input type="text" class="form-input" id="userId" placeholder="Enter your User ID" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="password">Password</label>
                    <input type="password" class="form-input" id="password" placeholder="Enter your password" required>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
        </div>
    </div>
    
    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <!-- Top Navigation -->
        <nav class="top-nav">
            <div class="nav-left">
                <button class="nav-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="nav-logo">PNE ARENA</div>
            </div>
            
            <div class="nav-user">
                <div class="user-info">
                    <div class="user-name" id="userName">User Name</div>
                    <div class="user-role" id="userRole">User Role</div>
                </div>
                <button class="btn btn-danger" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </nav>
        
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-menu">
                <a href="#" class="menu-item active" data-page="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="#" class="menu-item" data-page="cashbill">
                    <i class="fas fa-file-invoice-dollar"></i> Cashbill
                </a>
                <a href="#" class="menu-item" data-page="logbook">
                    <i class="fas fa-book"></i> Logbook
                </a>
                <a href="#" class="menu-item" data-page="quotation">
                    <i class="fas fa-file-contract"></i> Quotation
                </a>
                <a href="#" class="menu-item" data-page="schedule">
                    <i class="fas fa-calendar-alt"></i> Schedule Timetable
                </a>
                <a href="#" class="menu-item" data-page="orders">
                    <i class="fas fa-shopping-cart"></i> Online Orders
                </a>
                <a href="#" class="menu-item" data-page="activity">
                    <i class="fas fa-history"></i> Activity Logs
                </a>
                <a href="#" class="menu-item admin-only" data-page="attendance">
                    <i class="fas fa-user-clock"></i> Attendance Management
                </a>
                <a href="#" class="menu-item admin-only" data-page="crew">
                    <i class="fas fa-users"></i> Crew Management
                </a>
                <a href="#" class="menu-item" data-page="stock">
                    <i class="fas fa-boxes"></i> Stock Management
                </a>
                <a href="#" class="menu-item admin-only" data-page="stock-receiving">
                    <i class="fas fa-truck-loading"></i> Stock Receiving
                </a>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page">
                <div class="content-header">
                    <h1 class="content-title">Dashboard</h1>
                    <p class="content-subtitle">Welcome back! Here's what's happening today.</p>
                </div>
                
                <div class="dashboard-info">
                    <div class="info-card">
                        <div class="info-icon">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                        <div class="info-label">Today's Date</div>
                        <div class="info-value" id="currentDate">--</div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="info-label">Current Time</div>
                        <div class="info-value" id="currentTime">--:--:--</div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-icon">
                            <i class="fas fa-store"></i>
                        </div>
                        <div class="info-label">Outlet</div>
                        <div class="info-value" id="userOutlet">--</div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="info-label">Current Schedule</div>
                        <div class="info-value" id="currentSchedule">--</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Time Tracking</h2>
                    </div>
                    
                    <div id="scheduleMessage" class="no-schedule" style="display: none;">
                        No schedule found for you today.
                    </div>
                    
                    <div id="punchSection" class="punch-section">
                        <button class="btn btn-success punch-btn" id="punchInBtn">
                            <i class="fas fa-sign-in-alt"></i> Punch In
                        </button>
                        <button class="btn btn-danger punch-btn" id="punchOutBtn" disabled>
                            <i class="fas fa-sign-out-alt"></i> Punch Out
                        </button>
                        <button class="btn btn-warning punch-btn" id="breakBtn" disabled>
                            <i class="fas fa-pause"></i> Break
                        </button>
                        <button class="btn btn-primary punch-btn" id="resumeBtn" style="display: none;">
                            <i class="fas fa-play"></i> Resume
                        </button>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h2 class="card-title">Recent Activities</h2>
                        <a href="#" class="btn btn-sm btn-primary" onclick="navigateTo('activity')">View All</a>
                    </div>
                    
                    <div class="table-container">
                        <table class="activity-log-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>User</th>
                                    <th>Activity</th>
                                </tr>
                            </thead>
                            <tbody id="dashboardActivityTableBody">
                                <tr>
                                    <td colspan="3" class="no-schedule">No recent activities</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Cashbill Page -->
            <div id="cashbillPage" class="page" style="display: none;">
                <div class="content-header">
                    <h1 class="content-title">Cashbill Management</h1>
                    <p class="content-subtitle">Create and manage cashbills</p>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Cashbills</h2>
                        <button class="btn btn-primary" id="createCashbillBtn">
                            <i class="fas fa-plus"></i> Create Cashbill
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Invoice No</th>
                                    <th>Date</th>
                                    <th>Customer Name</th>
                                    <th>Phone No</th>
                                    <th>Total Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="cashbillTableBody">
                                <tr>
                                    <td colspan="7" class="no-schedule">No cashbills found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Logbook Page -->
            <div id="logbookPage" class="page" style="display: none;">
                <div class="content-header">
                    <h1 class="content-title">Logbook</h1>
                    <p class="content-subtitle">Record and view daily activities</p>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Log Entries</h2>
                        <button class="btn btn-primary" id="createLogBtn">
                            <i class="fas fa-plus"></i> Create Log Entry
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Crew Involved</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="logbookTableBody">
                                <tr>
                                    <td colspan="5" class="no-schedule">No log entries found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Quotation Page -->
            <div id="quotationPage" class="page" style="display: none;">
                <div class="content-header">
                    <h1 class="content-title">Quotation Management</h1>
                    <p class="content-subtitle">Create and manage quotations</p>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Quotations</h2>
                        <button class="btn btn-primary" id="createQuotationBtn">
                            <i class="fas fa-plus"></i> Create Quotation
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Quote No</th>
                                    <th>Date</th>
                                    <th>Client Name</th>
                                    <th>Services</th>
                                    <th>Total Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="quotationTableBody">
                                <tr>
                                    <td colspan="7" class="no-schedule">No quotations found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Schedule Page -->
            <div id="schedulePage" class="page" style="display: none;">
                <div class="content-header">
                    <h1 class="content-title">Schedule Timetable</h1>
                    <p class="content-subtitle">View and manage weekly schedules</p>
                </div>
                
                <div class="card">
                    <div class="schedule-controls">
                        <div class="week-nav">
                            <button class="week-btn" id="prevWeekBtn">
                                <i class="fas fa-chevron-left"></i> Previous Week
                            </button>
                            <span id="currentWeek">--</span>
                            <button class="week-btn" id="nextWeekBtn">
                                Next Week <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        
                        <div class="date-picker-container">
                            <label for="weekPicker">Select Week:</label>
                            <input type="week" id="weekPicker" class="form-input">
                        </div>
                        
                        <div id="scheduleAdminControls" style="display: none;">
                            <button class="btn btn-danger" id="createScheduleBtn">
                                <i class="fas fa-plus"></i> Create Schedule
                            </button>
                            <button class="btn btn-success" id="saveScheduleBtn" style="display: none;">
                                <i class="fas fa-save"></i> Save Schedule
                            </button>
                        </div>
                    </div>
                    
                    <!-- Schedule filters -->
                    <div class="schedule-filters">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="hq">HQ</button>
                        <button class="filter-btn" data-filter="blm">BLM</button>
                        <button class="filter-btn" data-filter="working">Working</button>
                        <button class="filter-btn" data-filter="off">Off/Leave</button>
                    </div>
                    
                    <!-- Schedule legend -->
                    <div class="schedule-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #e8f5e9;"></div>
                            <span>Working</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #ffebee;"></div>
                            <span>Off</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #fff8e1;"></div>
                            <span>Leave</span>
                        </div>
                    </div>
                    
                    <div id="scheduleTableContainer">
                        <div class="no-schedule" id="noScheduleMessage">
                            This week schedule is not yet available
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Online Orders Page -->
            <div id="ordersPage" class="page" style="display: none;">
                <div class="content-header">
                    <h1 class="content-title">Online Orders</h1>
                    <p class="content-subtitle">Manage online orders</p>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Orders</h2>
                        <button class="btn btn-primary" id="createOrderBtn">
                            <i class="fas fa-plus"></i> Create Order
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Outlet</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <tr>
                                    <td colspan="8" class="no-schedule">No orders found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Activity Logs Page -->
            <div id="activityPage" class="page" style="display: none;">
                <div class="content-header">
                    <h1 class="content-title">Activity Logs</h1>
                    <p class="content-subtitle">View punch in/out and break activities</p>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Recent Activities</h2>
                        <div>
                            <select id="activityFilter" class="form-input">
                                <option value="all">All Activities</option>
                                <option value="punch-in">Punch In</option>
                                <option value="punch-out">Punch Out</option>
                                <option value="break">Break</option>
                                <option value="resume">Resume</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="activity-log-table">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>User</th>
                                    <th>Activity Type</th>
                                    <th>Duration</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody id="activityTableBody">
                                <tr>
                                    <td colspan="5" class="no-schedule">No activity logs found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Attendance Management Page -->
            <div id="attendancePage" class="page" style="display: none;">
                <div class="content-header">
                    <h1 class="content-title">Attendance Management</h1>
                    <p class="content-subtitle">Manage and amend crew attendance records</p>
                </div>
                
                <div class="card">
                    <div class="attendance-controls">
                        <div class="date-filter">
                            <label for="attendanceDate">Date:</label>
                            <input type="date" id="attendanceDate" class="form-input">
                        </div>
                        <div>
                            <select id="crewFilter" class="form-input">
                                <option value="">All Crew</option>
                            </select>
                        </div>
                        <div>
                            <button class="btn btn-primary" id="refreshAttendanceBtn">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="attendance-table">
                            <thead>
                                <tr>
                                    <th>Crew ID</th>
                                    <th>Name</th>
                                    <th>Scheduled Time</th>
                                    <th>Punch In</th>
                                    <th>Punch Out</th>
                                    <th>Break Start</th>
                                    <th>Break End</th>
                                    <th>Break Duration</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody">
                                <tr>
                                    <td colspan="10" class="no-schedule">No attendance records found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Crew Management Page -->
            <div id="crewPage" class="page" style="display: none;">
                <div class="content-header">
                    <h1 class="content-title">Crew Management</h1>
                    <p class="content-subtitle">Manage crew members (Admin Only)</p>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Crew Members</h2>
                        <button class="btn btn-danger" id="addCrewBtn">
                            <i class="fas fa-plus"></i> Add Crew
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Role</th>
                                    <th>Outlet</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="crewTableBody">
                                <tr>
                                    <td colspan="6" class="no-schedule">No crew members found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Stock Management Page -->
            <div id="stockPage" class="page" style="display: none;">
                <div class="content-header">
                    <h1 class="content-title">Stock Management</h1>
                    <p class="content-subtitle">Manage inventory and stock</p>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Stock Items</h2>
                        <button class="btn btn-danger admin-only" id="addStockBtn" style="display: none;">
                            <i class="fas fa-plus"></i> Add Stock
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Item Code</th>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Outlet</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="stockTableBody">
                                <tr>
                                    <td colspan="7" class="no-schedule">No stock items found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Stock Receiving Page -->
            <div id="stockReceivingPage" class="page" style="display: none;">
                <div class="content-header">
                    <h1 class="content-title">Stock Receiving</h1>
                    <p class="content-subtitle">Record received stock items and update inventory</p>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Receive New Stock</h2>
                    </div>
                    
                    <form id="stockReceivingForm">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="receivingDate">Date</label>
                                    <input type="date" class="form-input" id="receivingDate" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="supplierName">Supplier</label>
                                    <input type="text" class="form-input" id="supplierName" placeholder="Supplier name" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="invoiceNumber">Invoice #</label>
                                    <input type="text" class="form-input" id="invoiceNumber" placeholder="Invoice number">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Items Received</label>
                            <div id="receivingItems">
                                <div class="form-row receiving-item">
                                    <div class="form-col">
                                        <div class="form-group">
                                            <select class="form-input item-select" required>
                                                <option value="">Select Item</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-col">
                                        <div class="form-group">
                                            <input type="number" class="form-input item-quantity" placeholder="Quantity" min="1" value="1" required>
                                        </div>
                                    </div>
                                    <div class="form-col">
                                        <div class="form-group">
                                            <input type="number" class="form-input item-cost" placeholder="Cost (RM)" step="0.01" required>
                                        </div>
                                    </div>
                                    <div class="form-col" style="display: flex; align-items: end;">
                                        <button type="button" class="btn btn-danger remove-receiving-item" style="display: none;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary" id="addReceivingItemBtn">
                                <i class="fas fa-plus"></i> Add Item
                            </button>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="totalCost">Total Cost (RM)</label>
                                    <input type="number" class="form-input" id="totalCost" step="0.01" readonly>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="receivedBy">Received By</label>
                                    <input type="text" class="form-input" id="receivedBy" value="" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="receivingNotes">Notes</label>
                            <textarea class="form-input" id="receivingNotes" rows="3" placeholder="Any additional notes"></textarea>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button type="button" class="btn btn-primary" id="previewReceivingBtn">Preview</button>
                            <button type="button" class="btn btn-success" id="saveReceivingBtn">Save & Update Stock</button>
                        </div>
                    </form>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h2 class="card-title">Recent Stock Receiving Records</h2>
                        <div>
                            <select id="receivingFilter" class="form-input">
                                <option value="all">All Records</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Invoice #</th>
                                    <th>Supplier</th>
                                    <th>Items</th>
                                    <th>Total Cost</th>
                                    <th>Received By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="receivingTableBody">
                                <tr>
                                    <td colspan="7" class="no-schedule">No receiving records found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Cashbill Modal -->
    <div class="modal" id="cashbillModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="cashbillModalTitle">Create Cashbill</h3>
                <button class="modal-close" id="closeCashbillModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="cashbillForm">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="customerName">Customer Name</label>
                                <input type="text" class="form-input" id="customerName" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="customerPhone">Phone No</label>
                                <input type="tel" class="form-input" id="customerPhone" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="cashbillDate">Date</label>
                                <input type="date" class="form-input" id="cashbillDate" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="invoiceNo">Invoice No</label>
                                <input type="text" class="form-input" id="invoiceNo" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Items</label>
                        <div id="cashbillItems">
                            <div class="form-row cashbill-item">
                                <div class="form-col">
                                    <div class="form-group">
                                        <select class="form-input item-select" required>
                                            <option value="">Select Item</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <input type="number" class="form-input item-quantity" placeholder="Quantity" min="1" value="1" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <input type="number" class="form-input item-price" placeholder="Price" step="0.01" readonly>
                                    </div>
                                </div>
                                <div class="form-col" style="display: flex; align-items: end;">
                                    <button type="button" class="btn btn-danger remove-item" style="display: none;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" id="addItemBtn">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="totalAmount">Total Amount (RM)</label>
                                <input type="number" class="form-input" id="totalAmount" step="0.01" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" id="priceAdjustmentGroup" style="display: none;">
                        <label class="form-label" for="priceAdjustment">Price Adjustment (Admin Only)</label>
                        <input type="number" class="form-input" id="priceAdjustment" step="0.01" placeholder="Enter adjustment amount">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="draftCashbillBtn">Draft</button>
                <button type="button" class="btn btn-primary" id="commitCashbillBtn">Commit</button>
                <button type="button" class="btn btn-success" id="printCashbillBtn" style="display: none;">Print</button>
            </div>
        </div>
    </div>
    
    <!-- Logbook Modal -->
    <div class="modal" id="logbookModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="logbookModalTitle">Create Log Entry</h3>
                <button class="modal-close" id="closeLogbookModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="logbookForm">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="logDate">Date</label>
                                <input type="date" class="form-input" id="logDate" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="logDescription">Description</label>
                        <textarea class="form-input" id="logDescription" rows="4" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="logCrew">Crew Involved</label>
                        <select class="form-input" id="logCrew" multiple>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="draftLogBtn">Draft</button>
                <button type="button" class="btn btn-primary" id="commitLogBtn">Commit</button>
            </div>
        </div>
    </div>
    
    <!-- Quotation Modal -->
    <div class="modal" id="quotationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="quotationModalTitle">Create Quotation</h3>
                <button class="modal-close" id="closeQuotationModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="quotationForm">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="clientName">Client Name</label>
                                <input type="text" class="form-input" id="clientName" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="clientEmail">Email</label>
                                <input type="email" class="form-input" id="clientEmail">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="clientPhone">Phone</label>
                                <input type="tel" class="form-input" id="clientPhone">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="quoteDate">Date</label>
                                <input type="date" class="form-input" id="quoteDate" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Services</label>
                        <div id="quotationServices">
                            <div class="form-row quotation-service">
                                <div class="form-col">
                                    <div class="form-group">
                                        <input type="text" class="form-input service-name" placeholder="Service Name" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <input type="number" class="form-input service-price" placeholder="Price (RM)" step="0.01" required>
                                    </div>
                                </div>
                                <div class="form-col" style="display: flex; align-items: end;">
                                    <button type="button" class="btn btn-danger remove-service" style="display: none;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" id="addServiceBtn">
                            <i class="fas fa-plus"></i> Add Service
                        </button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="quoteTotal">Total Amount (RM)</label>
                                <input type="number" class="form-input" id="quoteTotal" step="0.01" readonly>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="saveQuoteBtn">Save</button>
                <button type="button" class="btn btn-primary" id="downloadQuoteBtn">Download PDF</button>
                <button type="button" class="btn btn-success" id="emailQuoteBtn">Send Email</button>
            </div>
        </div>
    </div>
    
    <!-- Order Modal -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="orderModalTitle">Create Order</h3>
                <button class="modal-close" id="closeOrderModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="orderForm">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="orderCustomer">Customer Name</label>
                                <input type="text" class="form-input" id="orderCustomer" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="orderPhone">Phone</label>
                                <input type="tel" class="form-input" id="orderPhone" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="orderDate">Date</label>
                                <input type="date" class="form-input" id="orderDate" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="orderOutlet">Outlet</label>
                                <select class="form-input" id="orderOutlet" required>
                                    <option value="">Select Outlet</option>
                                    <option value="HQ">HQ</option>
                                    <option value="BLM">BLM</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Items</label>
                        <div id="orderItems">
                            <div class="form-row order-item">
                                <div class="form-col">
                                    <div class="form-group">
                                        <select class="form-input order-item-select" required>
                                            <option value="">Select Item</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <input type="number" class="form-input order-item-quantity" placeholder="Quantity" min="1" value="1" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <input type="number" class="form-input order-item-price" placeholder="Price (RM)" step="0.01" readonly>
                                    </div>
                                </div>
                                <div class="form-col" style="display: flex; align-items: end;">
                                    <button type="button" class="btn btn-danger remove-order-item" style="display: none;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" id="addOrderItemBtn">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="orderTotal">Total Amount (RM)</label>
                                <input type="number" class="form-input" id="orderTotal" step="0.01" readonly>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="cancelOrderBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveOrderBtn">Save Order</button>
            </div>
        </div>
    </div>
    
    <!-- Assign Order Modal -->
    <div class="modal" id="assignOrderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Assign Order</h3>
                <button class="modal-close" id="closeAssignOrderModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="assignOrderForm">
                    <div class="form-group">
                        <label class="form-label" for="assignOrderOutlet">Select Outlet</label>
                        <select class="form-input" id="assignOrderOutlet" required>
                            <option value="">Select Outlet</option>
                            <option value="HQ">HQ</option>
                            <option value="BLM">BLM</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="assignOrderCrew">Assign to Crew</label>
                        <select class="form-input" id="assignOrderCrew">
                            <option value="">Select Crew Member</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="cancelAssignOrderBtn">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAssignOrderBtn">Assign</button>
            </div>
        </div>
    </div>
    
    <!-- Crew Modal -->
    <div class="modal" id="crewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="crewModalTitle">Add Crew Member</h3>
                <button class="modal-close" id="closeCrewModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="crewForm">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="crewId">ID</label>
                                <input type="text" class="form-input" id="crewId" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="crewName">Name</label>
                                <input type="text" class="form-input" id="crewName" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="crewRole">Role</label>
                                <select class="form-input" id="crewRole" required>
                                    <option value="">Select Role</option>
                                    <option value="Admin">Admin</option>
                                    <option value="Manager">Manager</option>
                                    <option value="Staff">Staff</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="crewOutlet">Outlet</label>
                                <select class="form-input" id="crewOutlet" required>
                                    <option value="">Select Outlet</option>
                                    <option value="HQ">HQ</option>
                                    <option value="BLM">BLM</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="cancelCrewBtn">Cancel</button>
                <button type="button" class="btn btn-danger" id="saveCrewBtn">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Stock Modal -->
    <div class="modal" id="stockModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="stockModalTitle">Add Stock Item</h3>
                <button class="modal-close" id="closeStockModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="stockForm">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="itemCode">Item Code</label>
                                <input type="text" class="form-input" id="itemCode" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="itemName">Name</label>
                                <input type="text" class="form-input" id="itemName" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="itemDescription">Description</label>
                        <textarea class="form-input" id="itemDescription" rows="2"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="itemPrice">Price (RM)</label>
                                <input type="number" class="form-input" id="itemPrice" step="0.01" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="itemQuantity">Quantity</label>
                                <input type="number" class="form-input" id="itemQuantity" min="0" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="itemOutlet">Outlet</label>
                                <select class="form-input" id="itemOutlet" required>
                                    <option value="">Select Outlet</option>
                                    <option value="HQ">HQ</option>
                                    <option value="BLM">BLM</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="cancelStockBtn">Cancel</button>
                <button type="button" class="btn btn-danger" id="saveStockBtn">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Attendance Edit Modal -->
    <div class="modal" id="attendanceEditModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Attendance Record</h3>
                <button class="modal-close" id="closeAttendanceEditModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="attendanceEditForm">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">Crew Member</label>
                                <input type="text" class="form-input" id="editCrewName" readonly>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-input" id="editAttendanceDate" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">Scheduled Time</label>
                                <input type="text" class="form-input" id="editScheduledTime" readonly>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">Punch In Time</label>
                                <div class="time-input-group">
                                    <input type="time" class="time-input" id="editPunchInTime">
                                    <span id="punchInStatus" class="time-status status-normal">Normal</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">Punch Out Time</label>
                                <input type="time" class="time-input" id="editPunchOutTime">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">Break Start Time</label>
                                <input type="time" class="time-input" id="editBreakStartTime">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">Break End Time</label>
                                <div class="time-input-group">
                                    <input type="time" class="time-input" id="editBreakEndTime">
                                    <span id="breakStatus" class="time-status status-normal">Normal</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">Notes</label>
                                <input type="text" class="form-input" id="editAttendanceNotes" placeholder="Add notes for this amendment">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="cancelAttendanceEditBtn">Cancel</button>
                <button type="button" class="btn btn-danger" id="saveAttendanceEditBtn">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="notification-message" id="notificationMessage">
            Notification message
        </div>
        <button class="notification-close" id="notificationClose">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <script>
        // App State
        const app = {
            user: null,
            currentPage: 'dashboard',
            sidebarVisible: true,
            cashbills: [],
            logEntries: [],
            quotations: [],
            orders: [],
            crewMembers: [],
            stockItems: [],
            schedules: {},
            currentWeek: null,
            punchStatus: 'out', // 'in', 'out', 'break'
            scheduleEditMode: false,
            activityLogs: [],
            attendanceRecords: [],
            stockReceivingRecords: []
        };
        
        // DOM Elements
        const elements = {
            loginPage: document.getElementById('loginPage'),
            appContainer: document.getElementById('appContainer'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            loginForm: document.getElementById('loginForm'),
            loginAlert: document.getElementById('loginAlert'),
            sidebar: document.getElementById('sidebar'),
            sidebarToggle: document.getElementById('sidebarToggle'),
            mainContent: document.getElementById('mainContent'),
            userName: document.getElementById('userName'),
            userRole: document.getElementById('userRole'),
            userOutlet: document.getElementById('userOutlet'),
            logoutBtn: document.getElementById('logoutBtn'),
            notification: document.getElementById('notification'),
            notificationMessage: document.getElementById('notificationMessage'),
            notificationClose: document.getElementById('notificationClose'),
            currentDate: document.getElementById('currentDate'),
            currentTime: document.getElementById('currentTime'),
            currentSchedule: document.getElementById('currentSchedule'),
            scheduleMessage: document.getElementById('scheduleMessage'),
            punchSection: document.getElementById('punchSection'),
            punchInBtn: document.getElementById('punchInBtn'),
            punchOutBtn: document.getElementById('punchOutBtn'),
            breakBtn: document.getElementById('breakBtn'),
            resumeBtn: document.getElementById('resumeBtn'),
            cashbillModal: document.getElementById('cashbillModal'),
            cashbillForm: document.getElementById('cashbillForm'),
            logbookModal: document.getElementById('logbookModal'),
            logbookForm: document.getElementById('logbookForm'),
            quotationModal: document.getElementById('quotationModal'),
            quotationForm: document.getElementById('quotationForm'),
            orderModal: document.getElementById('orderModal'),
            orderForm: document.getElementById('orderForm'),
            assignOrderModal: document.getElementById('assignOrderModal'),
            assignOrderForm: document.getElementById('assignOrderForm'),
            crewModal: document.getElementById('crewModal'),
            crewForm: document.getElementById('crewForm'),
            stockModal: document.getElementById('stockModal'),
            stockForm: document.getElementById('stockForm'),
            weekPicker: document.getElementById('weekPicker'),
            activityFilter: document.getElementById('activityFilter'),
            attendanceDate: document.getElementById('attendanceDate'),
            crewFilter: document.getElementById('crewFilter'),
            refreshAttendanceBtn: document.getElementById('refreshAttendanceBtn'),
            attendanceEditModal: document.getElementById('attendanceEditModal'),
            attendanceEditForm: document.getElementById('attendanceEditForm'),
            editPunchInTime: document.getElementById('editPunchInTime'),
            editPunchOutTime: document.getElementById('editPunchOutTime'),
            editBreakStartTime: document.getElementById('editBreakStartTime'),
            editBreakEndTime: document.getElementById('editBreakEndTime'),
            punchInStatus: document.getElementById('punchInStatus'),
            breakStatus: document.getElementById('breakStatus'),
            // Stock Receiving elements
            receivingDate: document.getElementById('receivingDate'),
            supplierName: document.getElementById('supplierName'),
            invoiceNumber: document.getElementById('invoiceNumber'),
            receivingItems: document.getElementById('receivingItems'),
            totalCost: document.getElementById('totalCost'),
            receivedBy: document.getElementById('receivedBy'),
            receivingNotes: document.getElementById('receivingNotes'),
            receivingFilter: document.getElementById('receivingFilter')
        };
        
        // Initialize App
        function initApp() {
            // Check if user is logged in
            const savedUser = localStorage.getItem('pneUser');
            if (savedUser) {
                app.user = JSON.parse(savedUser);
                showApp();
            } else {
                showLogin();
            }
            
            // Load data from localStorage
            loadData();
            
            // Set up event listeners
            setupEventListeners();
            
            // Update date and time
            updateDateTime();
            setInterval(updateDateTime, 1000);
        }
        
        // Show login page
        function showLogin() {
            elements.loginPage.style.display = 'flex';
            elements.appContainer.style.display = 'none';
        }
        
        // Show app
        function showApp() {
            elements.loginPage.style.display = 'none';
            elements.appContainer.style.display = 'flex';
            
            // Update user info
            elements.userName.textContent = app.user.name;
            elements.userRole.textContent = app.user.role;
            elements.userOutlet.textContent = app.user.outlet;
            
            // Show/hide admin features
            updateAdminFeatures();
            
            // Load current page
            navigateTo(app.currentPage || 'dashboard');
            
            // Check today's schedule
            checkTodaySchedule();
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Login form
            elements.loginForm.addEventListener('submit', handleLogin);
            
            // Sidebar toggle
            elements.sidebarToggle.addEventListener('click', toggleSidebar);
            
            // Logout
            elements.logoutBtn.addEventListener('click', handleLogout);
            
            // Menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = item.getAttribute('data-page');
                    navigateTo(page);
                });
            });
            
            // Dashboard punch buttons
            elements.punchInBtn.addEventListener('click', () => handlePunch('in'));
            elements.punchOutBtn.addEventListener('click', () => handlePunch('out'));
            elements.breakBtn.addEventListener('click', () => handlePunch('break'));
            elements.resumeBtn.addEventListener('click', () => handlePunch('resume'));
            
            // Cashbill
            document.getElementById('createCashbillBtn').addEventListener('click', openCashbillModal);
            document.getElementById('closeCashbillModal').addEventListener('click', closeCashbillModal);
            document.getElementById('addItemBtn').addEventListener('click', addCashbillItem);
            document.getElementById('draftCashbillBtn').addEventListener('click', () => saveCashbill('draft'));
            document.getElementById('commitCashbillBtn').addEventListener('click', () => saveCashbill('commit'));
            document.getElementById('printCashbillBtn').addEventListener('click', printCashbill);
            
            // Logbook
            document.getElementById('createLogBtn').addEventListener('click', openLogbookModal);
            document.getElementById('closeLogbookModal').addEventListener('click', closeLogbookModal);
            document.getElementById('draftLogBtn').addEventListener('click', () => saveLogEntry('draft'));
            document.getElementById('commitLogBtn').addEventListener('click', () => saveLogEntry('commit'));
            
            // Quotation
            document.getElementById('createQuotationBtn').addEventListener('click', openQuotationModal);
            document.getElementById('closeQuotationModal').addEventListener('click', closeQuotationModal);
            document.getElementById('addServiceBtn').addEventListener('click', addQuotationService);
            document.getElementById('saveQuoteBtn').addEventListener('click', saveQuotation);
            document.getElementById('downloadQuoteBtn').addEventListener('click', downloadQuotation);
            document.getElementById('emailQuoteBtn').addEventListener('click', emailQuotation);
            
            // Orders
            document.getElementById('createOrderBtn').addEventListener('click', openOrderModal);
            document.getElementById('closeOrderModal').addEventListener('click', closeOrderModal);
            document.getElementById('addOrderItemBtn').addEventListener('click', addOrderItem);
            document.getElementById('cancelOrderBtn').addEventListener('click', closeOrderModal);
            document.getElementById('saveOrderBtn').addEventListener('click', saveOrder);
            
            // Assign Order
            document.getElementById('closeAssignOrderModal').addEventListener('click', closeAssignOrderModal);
            document.getElementById('cancelAssignOrderBtn').addEventListener('click', closeAssignOrderModal);
            document.getElementById('confirmAssignOrderBtn').addEventListener('click', confirmAssignOrder);
            
            // Schedule
            document.getElementById('prevWeekBtn').addEventListener('click', () => changeWeek(-1));
            document.getElementById('nextWeekBtn').addEventListener('click', () => changeWeek(1));
            elements.weekPicker.addEventListener('change', handleWeekPickerChange);
            document.getElementById('createScheduleBtn').addEventListener('click', createSchedule);
            document.getElementById('saveScheduleBtn').addEventListener('click', saveSchedule);
            
            // Activity Logs
            elements.activityFilter.addEventListener('change', filterActivityLogs);
            
            // Attendance Management
            elements.attendanceDate.addEventListener('change', loadAttendanceRecords);
            elements.crewFilter.addEventListener('change', loadAttendanceRecords);
            elements.refreshAttendanceBtn.addEventListener('click', loadAttendanceRecords);
            
            // Attendance Edit Modal
            document.getElementById('closeAttendanceEditModal').addEventListener('click', closeAttendanceEditModal);
            document.getElementById('cancelAttendanceEditBtn').addEventListener('click', closeAttendanceEditModal);
            document.getElementById('saveAttendanceEditBtn').addEventListener('click', saveAttendanceEdit);
            
            // Time input change listeners for status updates
            elements.editPunchInTime.addEventListener('change', updatePunchInStatus);
            elements.editBreakEndTime.addEventListener('change', updateBreakStatus);
            
            // Crew Management
            document.getElementById('addCrewBtn').addEventListener('click', openCrewModal);
            document.getElementById('closeCrewModal').addEventListener('click', closeCrewModal);
            document.getElementById('cancelCrewBtn').addEventListener('click', closeCrewModal);
            document.getElementById('saveCrewBtn').addEventListener('click', saveCrew);
            
            // Stock Management
            document.getElementById('addStockBtn').addEventListener('click', openStockModal);
            document.getElementById('closeStockModal').addEventListener('click', closeStockModal);
            document.getElementById('cancelStockBtn').addEventListener('click', closeStockModal);
            document.getElementById('saveStockBtn').addEventListener('click', saveStock);
            
            // Stock Receiving
            document.getElementById('addReceivingItemBtn').addEventListener('click', addReceivingItem);
            document.getElementById('previewReceivingBtn').addEventListener('click', previewReceiving);
            document.getElementById('saveReceivingBtn').addEventListener('click', saveReceiving);
            elements.receivingFilter.addEventListener('change', loadReceivingRecords);
            
            // Notification close
            elements.notificationClose.addEventListener('click', hideNotification);
            
            // Dynamic event listeners for remove buttons
            document.addEventListener('click', (e) => {
                if (e.target.closest('.remove-item')) {
                    removeCashbillItem(e.target.closest('.cashbill-item'));
                } else if (e.target.closest('.remove-service')) {
                    removeQuotationService(e.target.closest('.quotation-service'));
                } else if (e.target.closest('.remove-order-item')) {
                    removeOrderItem(e.target.closest('.order-item'));
                } else if (e.target.closest('.remove-receiving-item')) {
                    removeReceivingItem(e.target.closest('.receiving-item'));
                }
            });
        }
        
        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            
            const userId = document.getElementById('userId').value;
            const password = document.getElementById('password').value;
            
            // Default password is 0000
            if (password !== '0000') {
                showLoginAlert('Invalid password');
                return;
            }
            
            // Get user data
            const user = getUserById(userId);
            if (!user) {
                showLoginAlert('User ID not found');
                return;
            }
            
            // Save user to app state and localStorage
            app.user = user;
            localStorage.setItem('pneUser', JSON.stringify(user));
            
            // Show app
            showApp();
            showNotification('Login successful', 'success');
        }
        
        // Get user by ID
        function getUserById(id) {
            const users = [
                { id: '0001', name: 'Danial Danish', role: 'Head IT (Admin)', outlet: 'HQ', isAdmin: true },
                { id: '0002', name: 'Aida', role: 'Director/Business Manager', outlet: 'HQ', isAdmin: false },
                { id: '0003', name: 'Putri Erinna', role: 'Business Development Manager', outlet: 'HQ', isAdmin: false },
                { id: '0004', name: 'Putri Farah', role: 'Business Marketing Manager', outlet: 'HQ', isAdmin: false }
            ];
            
            return users.find(user => user.id === id);
        }
        
        // Handle logout
        function handleLogout() {
            localStorage.removeItem('pneUser');
            app.user = null;
            showLogin();
            showNotification('Logged out successfully', 'success');
        }
        
        // Toggle sidebar
        function toggleSidebar() {
            app.sidebarVisible = !app.sidebarVisible;
            
            if (app.sidebarVisible) {
                elements.sidebar.classList.remove('hidden');
                elements.mainContent.classList.remove('expanded');
            } else {
                elements.sidebar.classList.add('hidden');
                elements.mainContent.classList.add('expanded');
            }
        }
        
        // Navigate to page
        function navigateTo(page) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => {
                p.style.display = 'none';
            });
            
            // Show selected page
            document.getElementById(`${page}Page`).style.display = 'block';
            
            // Update active menu item
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-page') === page) {
                    item.classList.add('active');
                }
            });
            
            // Update current page
            app.currentPage = page;
            
            // Load page data
            loadPageData(page);
        }
        
        // Load page data
        function loadPageData(page) {
            switch (page) {
                case 'cashbill':
                    loadCashbills();
                    break;
                case 'logbook':
                    loadLogEntries();
                    break;
                case 'quotation':
                    loadQuotations();
                    break;
                case 'schedule':
                    loadSchedule();
                    break;
                case 'orders':
                    loadOrders();
                    break;
                case 'activity':
                    loadActivityLogs();
                    break;
                case 'attendance':
                    loadAttendancePage();
                    break;
                case 'crew':
                    loadCrewMembers();
                    break;
                case 'stock':
                    loadStockItems();
                    break;
                case 'stock-receiving':
                    loadStockReceivingPage();
                    break;
                case 'dashboard':
                    loadDashboardActivities();
                    break;
            }
        }
        
        // Update admin features
        function updateAdminFeatures() {
            const isAdmin = app.user && app.user.isAdmin;
            
            // Show/hide admin menu items
            document.querySelectorAll('.admin-only').forEach(item => {
                if (isAdmin) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Show/hide admin buttons in pages
            const adminButtons = document.querySelectorAll('.admin-only');
            adminButtons.forEach(btn => {
                if (isAdmin) {
                    btn.style.display = 'inline-flex';
                } else {
                    btn.style.display = 'none';
                }
            });
            
            // Update schedule admin controls
            const scheduleAdminControls = document.getElementById('scheduleAdminControls');
            if (isAdmin) {
                scheduleAdminControls.style.display = 'flex';
            } else {
                scheduleAdminControls.style.display = 'none';
            }
        }
        
        // Update date and time
        function updateDateTime() {
            const now = new Date();
            
            // Update date
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            elements.currentDate.textContent = now.toLocaleDateString('en-US', dateOptions);
            
            // Update time
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            elements.currentTime.textContent = now.toLocaleTimeString('en-US', timeOptions);
        }
        
        // Check today's schedule (Improved version)
        function checkTodaySchedule() {
            const today = new Date();
            const todayStr = formatDate(today);
            
            // Check if user has a schedule for today in the actual schedule data
            let userSchedule = null;
            
            // Look through all weeks to find today's schedule for this user
            Object.keys(app.schedules).forEach(weekKey => {
                const weekSchedule = app.schedules[weekKey];
                if (weekSchedule && weekSchedule.entries) {
                    const todayEntry = weekSchedule.entries.find(entry => 
                        entry.crewId === app.user.id && entry.date === todayStr
                    );
                    
                    if (todayEntry && todayEntry.startTime && todayEntry.endTime) {
                        userSchedule = {
                            startTime: todayEntry.startTime,
                            endTime: todayEntry.endTime,
                            duties: todayEntry.duties,
                            remarks: todayEntry.remarks
                        };
                    }
                }
            });
            
            if (userSchedule) {
                // Check if it's a day off or leave
                if (userSchedule.remarks === 'Off') {
                    elements.currentSchedule.textContent = 'Day Off';
                } else if (userSchedule.remarks === 'Annual Leave') {
                    elements.currentSchedule.textContent = 'Annual Leave';
                } else if (userSchedule.remarks === 'Emergency Leave') {
                    elements.currentSchedule.textContent = 'Emergency Leave';
                } else {
                    elements.currentSchedule.textContent = `${userSchedule.startTime} - ${userSchedule.endTime}`;
                    if (userSchedule.duties) {
                        elements.currentSchedule.textContent += ` (${userSchedule.duties})`;
                    }
                }
                
                // Only show punch buttons if it's a regular working day
                if (!userSchedule.remarks || userSchedule.remarks === '') {
                    elements.punchSection.style.display = 'flex';
                    elements.scheduleMessage.style.display = 'none';
                } else {
                    elements.punchSection.style.display = 'none';
                    elements.scheduleMessage.textContent = `You have ${userSchedule.remarks.toLowerCase()} today.`;
                    elements.scheduleMessage.style.display = 'block';
                }
            } else {
                elements.currentSchedule.textContent = 'Not scheduled';
                elements.punchSection.style.display = 'none';
                elements.scheduleMessage.textContent = 'No schedule found for you today.';
                elements.scheduleMessage.style.display = 'block';
            }
        }
        
        // Get current date string (YYYY-MM-DD)
        function getCurrentDateStr() {
            const today = new Date();
            return formatDate(today);
        }
        
        // Format date as YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Handle punch in/out
        function handlePunch(action) {
            // Check if user has a schedule for today
            const today = new Date();
            const todayStr = formatDate(today);
            const userSchedule = getUserSchedule(app.user.id, todayStr);
            
            if (!userSchedule) {
                showNotification('You do not have a schedule for today', 'error');
                return;
            }
            
            // Record activity
            const activity = {
                id: generateId(),
                userId: app.user.id,
                userName: app.user.name,
                type: action,
                timestamp: new Date().toISOString(),
                date: todayStr
            };
            
            // Calculate duration for punch out and resume
            if (action === 'out' || action === 'resume') {
                const lastActivity = app.activityLogs
                    .filter(log => log.userId === app.user.id)
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                
                if (lastActivity && (lastActivity.type === 'in' || lastActivity.type === 'break')) {
                    const startTime = new Date(lastActivity.timestamp);
                    const endTime = new Date(activity.timestamp);
                    const durationMs = endTime - startTime;
                    const hours = Math.floor(durationMs / (1000 * 60 * 60));
                    const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
                    activity.duration = `${hours}h ${minutes}m`;
                }
            }
            
            // Check for late punch in (after 10:01 AM)
            if (action === 'in') {
                const punchInTime = new Date(activity.timestamp);
                const scheduledTime = new Date(`${todayStr}T${userSchedule.startTime}`);
                const lateThreshold = new Date(`${todayStr}T10:01:00`);
                
                if (punchInTime > lateThreshold) {
                    activity.isLate = true;
                    activity.lateBy = calculateTimeDifference(scheduledTime, punchInTime);
                }
            }
            
            app.activityLogs.push(activity);
            saveData();
            
            // Update UI
            switch (action) {
                case 'in':
                    app.punchStatus = 'in';
                    elements.punchInBtn.disabled = true;
                    elements.punchOutBtn.disabled = false;
                    elements.breakBtn.disabled = false;
                    showNotification('Punched in successfully', 'success');
                    break;
                case 'out':
                    app.punchStatus = 'out';
                    elements.punchInBtn.disabled = false;
                    elements.punchOutBtn.disabled = true;
                    elements.breakBtn.disabled = true;
                    elements.resumeBtn.style.display = 'none';
                    showNotification('Punched out successfully', 'success');
                    break;
                case 'break':
                    app.punchStatus = 'break';
                    elements.punchInBtn.disabled = true;
                    elements.punchOutBtn.disabled = true;
                    elements.breakBtn.disabled = true;
                    elements.resumeBtn.style.display = 'inline-flex';
                    showNotification('Break started', 'success');
                    break;
                case 'resume':
                    app.punchStatus = 'in';
                    elements.punchInBtn.disabled = true;
                    elements.punchOutBtn.disabled = false;
                    elements.breakBtn.disabled = false;
                    elements.resumeBtn.style.display = 'none';
                    showNotification('Resumed work', 'success');
                    break;
            }
            
            // Reload activity logs if on that page
            if (app.currentPage === 'activity') {
                loadActivityLogs();
            }
            
            // Reload dashboard activities if on dashboard
            if (app.currentPage === 'dashboard') {
                loadDashboardActivities();
            }
            
            // Reload attendance records if on that page
            if (app.currentPage === 'attendance') {
                loadAttendanceRecords();
            }
        }
        
        // Get user schedule for a specific date
        function getUserSchedule(userId, dateStr) {
            // This is a simplified implementation
            // In a real app, this would fetch from a database
            const schedules = [
                { userId: '0001', date: getCurrentDateStr(), startTime: '09:00', endTime: '17:00' },
                { userId: '0002', date: getCurrentDateStr(), startTime: '09:00', endTime: '17:00' },
                { userId: '0003', date: getCurrentDateStr(), startTime: '10:00', endTime: '18:00' },
                { userId: '0004', date: getCurrentDateStr(), startTime: '09:00', endTime: '17:00' }
            ];
            
            return schedules.find(s => s.userId === userId && s.date === dateStr);
        }
        
        // Calculate time difference
        function calculateTimeDifference(start, end) {
            const diffMs = end - start;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            return `${diffHours}h ${diffMinutes}m`;
        }
        
        // Show login alert
        function showLoginAlert(message) {
            elements.loginAlert.textContent = message;
            elements.loginAlert.style.display = 'block';
            
            setTimeout(() => {
                elements.loginAlert.style.display = 'none';
            }, 3000);
        }
        
        // Show notification
        function showNotification(message, type = 'success') {
            elements.notificationMessage.textContent = message;
            elements.notification.className = `notification notification-${type}`;
            elements.notification.classList.add('show');
            
            setTimeout(() => {
                hideNotification();
            }, 3000);
        }
        
        // Hide notification
        function hideNotification() {
            elements.notification.classList.remove('show');
        }
        
        // Load data from localStorage
        function loadData() {
            // Load cashbills
            const cashbillsData = localStorage.getItem('pneCashbills');
            if (cashbillsData) {
                app.cashbills = JSON.parse(cashbillsData);
            }
            
            // Load log entries
            const logEntriesData = localStorage.getItem('pneLogEntries');
            if (logEntriesData) {
                app.logEntries = JSON.parse(logEntriesData);
            }
            
            // Load quotations
            const quotationsData = localStorage.getItem('pneQuotations');
            if (quotationsData) {
                app.quotations = JSON.parse(quotationsData);
            }
            
            // Load orders
            const ordersData = localStorage.getItem('pneOrders');
            if (ordersData) {
                app.orders = JSON.parse(ordersData);
            }
            
            // Load crew members
            const crewMembersData = localStorage.getItem('pneCrewMembers');
            if (crewMembersData) {
                app.crewMembers = JSON.parse(crewMembersData);
            } else {
                // Initialize with default crew members
                app.crewMembers = [
                    { id: '0001', name: 'Danial Danish', role: 'Head IT (Admin)', outlet: 'HQ', status: 'Active' },
                    { id: '0002', name: 'Aida', role: 'Director/Business Manager', outlet: 'HQ', status: 'Active' },
                    { id: '0003', name: 'Putri Erinna', role: 'Business Development Manager', outlet: 'HQ', status: 'Active' },
                    { id: '0004', name: 'Putri Farah', role: 'Business Marketing Manager', outlet: 'HQ', status: 'Active' }
                ];
                saveCrewMembers();
            }
            
            // Load stock items
            const stockItemsData = localStorage.getItem('pneStockItems');
            if (stockItemsData) {
                app.stockItems = JSON.parse(stockItemsData);
            } else {
                // Initialize with sample stock items
                app.stockItems = [
                    { code: 'ITEM001', name: 'Sample Item 1', description: 'Description for item 1', price: 10.00, quantity: 50, outlet: 'HQ' },
                    { code: 'ITEM002', name: 'Sample Item 2', description: 'Description for item 2', price: 20.00, quantity: 30, outlet: 'HQ' },
                    { code: 'ITEM003', name: 'Sample Item 3', description: 'Description for item 3', price: 15.00, quantity: 25, outlet: 'BLM' }
                ];
                saveStockItems();
            }
            
            // Load schedules
            const schedulesData = localStorage.getItem('pneSchedules');
            if (schedulesData) {
                app.schedules = JSON.parse(schedulesData);
            }
            
            // Load activity logs
            const activityLogsData = localStorage.getItem('pneActivityLogs');
            if (activityLogsData) {
                app.activityLogs = JSON.parse(activityLogsData);
            }
            
            // Load attendance records
            const attendanceRecordsData = localStorage.getItem('pneAttendanceRecords');
            if (attendanceRecordsData) {
                app.attendanceRecords = JSON.parse(attendanceRecordsData);
            }
            
            // Load stock receiving records
            loadStockReceivingData();
        }
        
        // Save data to localStorage
        function saveData() {
            localStorage.setItem('pneCashbills', JSON.stringify(app.cashbills));
            localStorage.setItem('pneLogEntries', JSON.stringify(app.logEntries));
            localStorage.setItem('pneQuotations', JSON.stringify(app.quotations));
            localStorage.setItem('pneOrders', JSON.stringify(app.orders));
            localStorage.setItem('pneCrewMembers', JSON.stringify(app.crewMembers));
            localStorage.setItem('pneStockItems', JSON.stringify(app.stockItems));
            localStorage.setItem('pneSchedules', JSON.stringify(app.schedules));
            localStorage.setItem('pneActivityLogs', JSON.stringify(app.activityLogs));
            localStorage.setItem('pneAttendanceRecords', JSON.stringify(app.attendanceRecords));
            saveStockReceivingData();
        }
        
        // Load dashboard activities
        function loadDashboardActivities() {
            const tbody = document.getElementById('dashboardActivityTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Get today's activities, sorted by most recent
            const today = new Date();
            const todayStr = formatDate(today);
            
            // Filter activities for today
            const todayActivities = app.activityLogs.filter(log => log.date === todayStr);
            
            // Sort by timestamp (newest first)
            todayActivities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Show only the 5 most recent activities
            const recentActivities = todayActivities.slice(0, 5);
            
            if (recentActivities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="no-schedule">No recent activities</td></tr>';
                return;
            }
            
            recentActivities.forEach(log => {
                const tr = document.createElement('tr');
                
                // Format time
                const timestamp = new Date(log.timestamp);
                const formattedTime = timestamp.toLocaleTimeString();
                
                // Get activity display
                let activityDisplay = '';
                switch (log.type) {
                    case 'punch-in':
                        activityDisplay = log.isLate ? 'Punched In (Late)' : 'Punched In';
                        break;
                    case 'punch-out':
                        activityDisplay = 'Punched Out';
                        break;
                    case 'break':
                        activityDisplay = 'Break Started';
                        break;
                    case 'resume':
                        activityDisplay = log.isOverbreak ? 'Resumed (Overbreak)' : 'Resumed Work';
                        break;
                }
                
                tr.innerHTML = `
                    <td>${formattedTime}</td>
                    <td>${log.userName}</td>
                    <td>${activityDisplay}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Cashbill Functions
        function loadCashbills() {
            const tbody = document.getElementById('cashbillTableBody');
            tbody.innerHTML = '';
            
            if (app.cashbills.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-schedule">No cashbills found</td></tr>';
                return;
            }
            
            app.cashbills.forEach(cashbill => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cashbill.invoiceNo}</td>
                    <td>${cashbill.date}</td>
                    <td>${cashbill.customerName}</td>
                    <td>${cashbill.customerPhone}</td>
                    <td>RM${cashbill.totalAmount.toFixed(2)}</td>
                    <td><span class="status-badge ${cashbill.status === 'Committed' ? 'status-active' : 'status-inactive'}">${cashbill.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewCashbill('${cashbill.invoiceNo}')">View</button>
                        ${cashbill.status === 'Draft' ? 
                            `<button class="btn btn-sm btn-warning" onclick="editCashbill('${cashbill.invoiceNo}')">Edit</button>
                             <button class="btn btn-sm btn-danger" onclick="deleteCashbill('${cashbill.invoiceNo}')">Delete</button>` : 
                            ''}
                        ${app.user.isAdmin && cashbill.status === 'Committed' ? 
                            `<button class="btn btn-sm btn-danger" onclick="uncommitCashbill('${cashbill.invoiceNo}')">Uncommit</button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function openCashbillModal() {
            // Reset form
            elements.cashbillForm.reset();
            
            // Generate invoice number
            const invoiceNo = generateInvoiceNo();
            document.getElementById('invoiceNo').value = invoiceNo;
            
            // Set today's date
            document.getElementById('cashbillDate').value = getCurrentDateStr();
            
            // Populate item dropdown
            populateItemDropdown();
            
            // Show/hide price adjustment for admin
            const priceAdjustmentGroup = document.getElementById('priceAdjustmentGroup');
            if (app.user.isAdmin) {
                priceAdjustmentGroup.style.display = 'block';
            } else {
                priceAdjustmentGroup.style.display = 'none';
            }
            
            // Reset items
            resetCashbillItems();
            
            // Show modal
            elements.cashbillModal.classList.add('active');
        }
        
        function closeCashbillModal() {
            elements.cashbillModal.classList.remove('active');
        }
        
        function generateInvoiceNo() {
            const prefix = 'INV-';
            const nextNumber = app.cashbills.length + 1;
            return `${prefix}${String(nextNumber).padStart(4, '0')}`;
        }
        
        function populateItemDropdown() {
            const selects = document.querySelectorAll('.item-select');
            
            selects.forEach(select => {
                select.innerHTML = '<option value="">Select Item</option>';
                
                app.stockItems.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.code;
                    option.textContent = `${item.name} - RM${item.price.toFixed(2)}`;
                    option.dataset.price = item.price;
                    select.appendChild(option);
                });
                
                // Add change event listener
                select.addEventListener('change', updateItemPrice);
            });
        }
        
        function updateItemPrice(e) {
            const select = e.target;
            const priceInput = select.closest('.cashbill-item').querySelector('.item-price');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption && selectedOption.value) {
                priceInput.value = selectedOption.dataset.price;
                calculateTotal();
            } else {
                priceInput.value = '';
            }
        }
        
        function addCashbillItem() {
            const itemsContainer = document.getElementById('cashbillItems');
            const itemTemplate = document.querySelector('.cashbill-item').cloneNode(true);
            
            // Reset values
            itemTemplate.querySelector('.item-select').value = '';
            itemTemplate.querySelector('.item-quantity').value = '1';
            itemTemplate.querySelector('.item-price').value = '';
            
            // Show remove button
            itemTemplate.querySelector('.remove-item').style.display = 'inline-flex';
            
            // Add event listener
            itemTemplate.querySelector('.item-select').addEventListener('change', updateItemPrice);
            
            itemsContainer.appendChild(itemTemplate);
            
            // Populate dropdown
            populateItemDropdown();
        }
        
        function removeCashbillItem(item) {
            item.remove();
            calculateTotal();
            
            // Show/hide remove buttons
            const items = document.querySelectorAll('.cashbill-item');
            items.forEach((item, index) => {
                const removeBtn = item.querySelector('.remove-item');
                if (items.length > 1) {
                    removeBtn.style.display = 'inline-flex';
                } else {
                    removeBtn.style.display = 'none';
                }
            });
        }
        
        function resetCashbillItems() {
            const itemsContainer = document.getElementById('cashbillItems');
            itemsContainer.innerHTML = `
                <div class="form-row cashbill-item">
                    <div class="form-col">
                        <div class="form-group">
                            <select class="form-input item-select" required>
                                <option value="">Select Item</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <input type="number" class="form-input item-quantity" placeholder="Quantity" min="1" value="1" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <input type="number" class="form-input item-price" placeholder="Price" step="0.01" readonly>
                        </div>
                    </div>
                    <div class="form-col" style="display: flex; align-items: end;">
                        <button type="button" class="btn btn-danger remove-item" style="display: none;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // Populate dropdown
            populateItemDropdown();
        }
        
        function calculateTotal() {
            const items = document.querySelectorAll('.cashbill-item');
            let total = 0;
            
            items.forEach(item => {
                const quantity = parseFloat(item.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(item.querySelector('.item-price').value) || 0;
                total += quantity * price;
            });
            
            // Apply price adjustment if admin
            if (app.user.isAdmin) {
                const adjustment = parseFloat(document.getElementById('priceAdjustment').value) || 0;
                total += adjustment;
            }
            
            document.getElementById('totalAmount').value = total.toFixed(2);
        }
        
        function saveCashbill(status) {
            // Get form data
            const customerName = document.getElementById('customerName').value;
            const customerPhone = document.getElementById('customerPhone').value;
            const date = document.getElementById('cashbillDate').value;
            const invoiceNo = document.getElementById('invoiceNo').value;
            const totalAmount = parseFloat(document.getElementById('totalAmount').value);
            
            // Get items
            const items = [];
            document.querySelectorAll('.cashbill-item').forEach(item => {
                const itemCode = item.querySelector('.item-select').value;
                const quantity = parseInt(item.querySelector('.item-quantity').value);
                const price = parseFloat(item.querySelector('.item-price').value);
                
                if (itemCode && quantity && price) {
                    const stockItem = app.stockItems.find(si => si.code === itemCode);
                    items.push({
                        code: itemCode,
                        name: stockItem.name,
                        quantity: quantity,
                        price: price
                    });
                }
            });
            
            // Create cashbill object
            const cashbill = {
                invoiceNo,
                date,
                customerName,
                customerPhone,
                items,
                totalAmount,
                status: status === 'commit' ? 'Committed' : 'Draft',
                createdBy: app.user.id,
                createdAt: new Date().toISOString()
            };
            
            // Check if we're editing an existing cashbill
            const existingIndex = app.cashbills.findIndex(c => c.invoiceNo === invoiceNo);
            
            if (existingIndex !== -1) {
                // Update existing cashbill
                app.cashbills[existingIndex] = cashbill;
            } else {
                // Add new cashbill
                app.cashbills.push(cashbill);
            }
            
            saveData();
            
            // Close modal
            closeCashbillModal();
            
            // Reload cashbills
            loadCashbills();
            
            // Show notification
            showNotification(`Cashbill ${status === 'commit' ? 'committed' : 'saved as draft'} successfully`, 'success');
        }
        
        function viewCashbill(invoiceNo) {
            // Find cashbill
            const cashbill = app.cashbills.find(c => c.invoiceNo === invoiceNo);
            if (!cashbill) return;
            
            // Open modal with cashbill data
            openCashbillModal();
            
            // Update modal title
            document.getElementById('cashbillModalTitle').textContent = 'View Cashbill';
            
            // Populate form
            document.getElementById('invoiceNo').value = cashbill.invoiceNo;
            document.getElementById('customerName').value = cashbill.customerName;
            document.getElementById('customerPhone').value = cashbill.customerPhone;
            document.getElementById('cashbillDate').value = cashbill.date;
            document.getElementById('totalAmount').value = cashbill.totalAmount.toFixed(2);
            
            // Populate items
            const itemsContainer = document.getElementById('cashbillItems');
            itemsContainer.innerHTML = '';
            
            cashbill.items.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'form-row cashbill-item';
                itemElement.innerHTML = `
                    <div class="form-col">
                        <div class="form-group">
                            <select class="form-input item-select" required>
                                <option value="">Select Item</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <input type="number" class="form-input item-quantity" placeholder="Quantity" min="1" value="${item.quantity}" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <input type="number" class="form-input item-price" placeholder="Price" step="0.01" value="${item.price}" readonly>
                        </div>
                    </div>
                    <div class="form-col" style="display: flex; align-items: end;">
                        <button type="button" class="btn btn-danger remove-item" ${index === 0 ? 'style="display: none;"' : ''}>
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                itemsContainer.appendChild(itemElement);
            });
            
            // Populate dropdown
            populateItemDropdown();
            
            // Set selected values
            const itemSelects = document.querySelectorAll('.item-select');
            itemSelects.forEach((select, index) => {
                if (cashbill.items[index]) {
                    select.value = cashbill.items[index].code;
                }
            });
            
            // Show/hide buttons based on status
            const draftBtn = document.getElementById('draftCashbillBtn');
            const commitBtn = document.getElementById('commitCashbillBtn');
            const printBtn = document.getElementById('printCashbillBtn');
            
            if (cashbill.status === 'Committed') {
                draftBtn.style.display = 'none';
                commitBtn.style.display = 'none';
                printBtn.style.display = 'inline-flex';
                
                // Disable form inputs
                document.querySelectorAll('#cashbillForm input, #cashbillForm select').forEach(input => {
                    input.disabled = true;
                });
            } else {
                draftBtn.style.display = 'inline-flex';
                commitBtn.style.display = 'inline-flex';
                printBtn.style.display = 'none';
                
                // Enable form inputs
                document.querySelectorAll('#cashbillForm input, #cashbillForm select').forEach(input => {
                    input.disabled = false;
                });
            }
        }
        
        function editCashbill(invoiceNo) {
            // Find cashbill
            const cashbill = app.cashbills.find(c => c.invoiceNo === invoiceNo);
            if (!cashbill) return;
            
            // Open modal with cashbill data
            openCashbillModal();
            
            // Update modal title
            document.getElementById('cashbillModalTitle').textContent = 'Edit Cashbill';
            
            // Populate form
            document.getElementById('invoiceNo').value = cashbill.invoiceNo;
            document.getElementById('customerName').value = cashbill.customerName;
            document.getElementById('customerPhone').value = cashbill.customerPhone;
            document.getElementById('cashbillDate').value = cashbill.date;
            document.getElementById('totalAmount').value = cashbill.totalAmount.toFixed(2);
            
            // Populate items
            const itemsContainer = document.getElementById('cashbillItems');
            itemsContainer.innerHTML = '';
            
            cashbill.items.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'form-row cashbill-item';
                itemElement.innerHTML = `
                    <div class="form-col">
                        <div class="form-group">
                            <select class="form-input item-select" required>
                                <option value="">Select Item</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <input type="number" class="form-input item-quantity" placeholder="Quantity" min="1" value="${item.quantity}" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <input type="number" class="form-input item-price" placeholder="Price" step="0.01" value="${item.price}" readonly>
                        </div>
                    </div>
                    <div class="form-col" style="display: flex; align-items: end;">
                        <button type="button" class="btn btn-danger remove-item" ${index === 0 ? 'style="display: none;"' : ''}>
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                itemsContainer.appendChild(itemElement);
            });
            
            // Populate dropdown
            populateItemDropdown();
            
            // Set selected values
            const itemSelects = document.querySelectorAll('.item-select');
            itemSelects.forEach((select, index) => {
                if (cashbill.items[index]) {
                    select.value = cashbill.items[index].code;
                }
            });
        }
        
        function deleteCashbill(invoiceNo) {
            if (confirm('Are you sure you want to delete this cashbill?')) {
                // Find and remove cashbill
                const cashbillIndex = app.cashbills.findIndex(c => c.invoiceNo === invoiceNo);
                if (cashbillIndex === -1) return;
                
                app.cashbills.splice(cashbillIndex, 1);
                saveData();
                
                // Reload cashbills
                loadCashbills();
                
                // Show notification
                showNotification('Cashbill deleted successfully', 'success');
            }
        }
        
        function uncommitCashbill(invoiceNo) {
            // Find cashbill
            const cashbillIndex = app.cashbills.findIndex(c => c.invoiceNo === invoiceNo);
            if (cashbillIndex === -1) return;
            
            // Update status
            app.cashbills[cashbillIndex].status = 'Draft';
            saveData();
            
            // Reload cashbills
            loadCashbills();
            
            // Show notification
            showNotification('Cashbill uncommitted successfully', 'success');
        }
        
        function printCashbill() {
            // This would open a print dialog in a real app
            showNotification('Print functionality would be implemented here', 'success');
        }
        
        // Logbook Functions
        function loadLogEntries() {
            const tbody = document.getElementById('logbookTableBody');
            tbody.innerHTML = '';
            
            if (app.logEntries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-schedule">No log entries found</td></tr>';
                return;
            }
            
            app.logEntries.forEach(entry => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${entry.date}</td>
                    <td>${entry.description}</td>
                    <td>${entry.crewInvolved.join(', ')}</td>
                    <td><span class="status-badge ${entry.status === 'Committed' ? 'status-active' : 'status-inactive'}">${entry.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewLogEntry('${entry.id}')">View</button>
                        ${entry.status === 'Draft' ? 
                            `<button class="btn btn-sm btn-warning" onclick="editLogEntry('${entry.id}')">Edit</button>
                             <button class="btn btn-sm btn-danger" onclick="deleteLogEntry('${entry.id}')">Delete</button>` : 
                            ''}
                        ${app.user.isAdmin && entry.status === 'Committed' ? 
                            `<button class="btn btn-sm btn-danger" onclick="uncommitLogEntry('${entry.id}')">Uncommit</button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function openLogbookModal() {
            // Reset form
            elements.logbookForm.reset();
            
            // Set today's date
            document.getElementById('logDate').value = getCurrentDateStr();
            
            // Populate crew dropdown
            const crewSelect = document.getElementById('logCrew');
            crewSelect.innerHTML = '';
            
            app.crewMembers.forEach(crew => {
                const option = document.createElement('option');
                option.value = crew.id;
                option.textContent = `${crew.name} (${crew.role})`;
                crewSelect.appendChild(option);
            });
            
            // Show modal
            elements.logbookModal.classList.add('active');
        }
        
        function closeLogbookModal() {
            elements.logbookModal.classList.remove('active');
        }
        
        function saveLogEntry(status) {
            // Get form data
            const date = document.getElementById('logDate').value;
            const description = document.getElementById('logDescription').value;
            const crewInvolved = Array.from(document.getElementById('logCrew').selectedOptions).map(option => {
                const crew = app.crewMembers.find(c => c.id === option.value);
                return crew ? crew.name : option.value;
            });
            
            // Create log entry object
            const logEntry = {
                id: generateId(),
                date,
                description,
                crewInvolved,
                status: status === 'commit' ? 'Committed' : 'Draft',
                createdBy: app.user.id,
                createdAt: new Date().toISOString()
            };
            
            // Check if we're editing an existing log entry
            const existingIndex = app.logEntries.findIndex(e => e.id === logEntry.id);
            
            if (existingIndex !== -1) {
                // Update existing log entry
                app.logEntries[existingIndex] = logEntry;
            } else {
                // Add new log entry
                app.logEntries.push(logEntry);
            }
            
            saveData();
            
            // Close modal
            closeLogbookModal();
            
            // Reload log entries
            loadLogEntries();
            
            // Show notification
            showNotification(`Log entry ${status === 'commit' ? 'committed' : 'saved as draft'} successfully`, 'success');
        }
        
        function viewLogEntry(id) {
            // Find log entry
            const logEntry = app.logEntries.find(e => e.id === id);
            if (!logEntry) return;
            
            // Open modal with log entry data
            openLogbookModal();
            
            // Update modal title
            document.getElementById('logbookModalTitle').textContent = 'View Log Entry';
            
            // Populate form
            document.getElementById('logDate').value = logEntry.date;
            document.getElementById('logDescription').value = logEntry.description;
            
            // Set selected crew
            const crewSelect = document.getElementById('logCrew');
            Array.from(crewSelect.options).forEach(option => {
                const crew = app.crewMembers.find(c => c.id === option.value);
                if (crew && logEntry.crewInvolved.includes(crew.name)) {
                    option.selected = true;
                }
            });
            
            // Show/hide buttons based on status
            const draftBtn = document.getElementById('draftLogBtn');
            const commitBtn = document.getElementById('commitLogBtn');
            
            if (logEntry.status === 'Committed') {
                draftBtn.style.display = 'none';
                commitBtn.style.display = 'none';
                
                // Disable form inputs
                document.querySelectorAll('#logbookForm input, #logbookForm select, #logbookForm textarea').forEach(input => {
                    input.disabled = true;
                });
            } else {
                draftBtn.style.display = 'inline-flex';
                commitBtn.style.display = 'inline-flex';
                
                // Enable form inputs
                document.querySelectorAll('#logbookForm input, #logbookForm select, #logbookForm textarea').forEach(input => {
                    input.disabled = false;
                });
            }
        }
        
        function editLogEntry(id) {
            // Find log entry
            const logEntry = app.logEntries.find(e => e.id === id);
            if (!logEntry) return;
            
            // Open modal with log entry data
            openLogbookModal();
            
            // Update modal title
            document.getElementById('logbookModalTitle').textContent = 'Edit Log Entry';
            
            // Populate form
            document.getElementById('logDate').value = logEntry.date;
            document.getElementById('logDescription').value = logEntry.description;
            
            // Set selected crew
            const crewSelect = document.getElementById('logCrew');
            Array.from(crewSelect.options).forEach(option => {
                const crew = app.crewMembers.find(c => c.id === option.value);
                if (crew && logEntry.crewInvolved.includes(crew.name)) {
                    option.selected = true;
                }
            });
        }
        
        function deleteLogEntry(id) {
            if (confirm('Are you sure you want to delete this log entry?')) {
                // Find and remove log entry
                const logEntryIndex = app.logEntries.findIndex(e => e.id === id);
                if (logEntryIndex === -1) return;
                
                app.logEntries.splice(logEntryIndex, 1);
                saveData();
                
                // Reload log entries
                loadLogEntries();
                
                // Show notification
                showNotification('Log entry deleted successfully', 'success');
            }
        }
        
        function uncommitLogEntry(id) {
            // Find log entry
            const logEntryIndex = app.logEntries.findIndex(e => e.id === id);
            if (logEntryIndex === -1) return;
            
            // Update status
            app.logEntries[logEntryIndex].status = 'Draft';
            saveData();
            
            // Reload log entries
            loadLogEntries();
            
            // Show notification
            showNotification('Log entry uncommitted successfully', 'success');
        }
        
        // Quotation Functions
        function loadQuotations() {
            const tbody = document.getElementById('quotationTableBody');
            tbody.innerHTML = '';
            
            if (app.quotations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-schedule">No quotations found</td></tr>';
                return;
            }
            
            app.quotations.forEach(quotation => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${quotation.quoteNo}</td>
                    <td>${quotation.date}</td>
                    <td>${quotation.clientName}</td>
                    <td>${quotation.services.map(s => s.name).join(', ')}</td>
                    <td>RM${quotation.totalAmount.toFixed(2)}</td>
                    <td><span class="status-badge status-active">${quotation.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewQuotation('${quotation.quoteNo}')">View</button>
                        ${quotation.status === 'Draft' ? 
                            `<button class="btn btn-sm btn-warning" onclick="editQuotation('${quotation.quoteNo}')">Edit</button>
                             <button class="btn btn-sm btn-danger" onclick="deleteQuotation('${quotation.quoteNo}')">Delete</button>` : 
                            ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function openQuotationModal() {
            // Reset form
            elements.quotationForm.reset();
            
            // Set today's date
            document.getElementById('quoteDate').value = getCurrentDateStr();
            
            // Reset services
            resetQuotationServices();
            
            // Show modal
            elements.quotationModal.classList.add('active');
        }
        
        function closeQuotationModal() {
            elements.quotationModal.classList.remove('active');
        }
        
        function generateQuoteNo() {
            const prefix = 'QUOTE-';
            const nextNumber = app.quotations.length + 1;
            return `${prefix}${String(nextNumber).padStart(4, '0')}`;
        }
        
        function addQuotationService() {
            const servicesContainer = document.getElementById('quotationServices');
            const serviceTemplate = document.querySelector('.quotation-service').cloneNode(true);
            
            // Reset values
            serviceTemplate.querySelector('.service-name').value = '';
            serviceTemplate.querySelector('.service-price').value = '';
            
            // Show remove button
            serviceTemplate.querySelector('.remove-service').style.display = 'inline-flex';
            
            servicesContainer.appendChild(serviceTemplate);
        }
        
        function removeQuotationService(service) {
            service.remove();
            calculateQuoteTotal();
            
            // Show/hide remove buttons
            const services = document.querySelectorAll('.quotation-service');
            services.forEach((service, index) => {
                const removeBtn = service.querySelector('.remove-service');
                if (services.length > 1) {
                    removeBtn.style.display = 'inline-flex';
                } else {
                    removeBtn.style.display = 'none';
                }
            });
        }
        
        function resetQuotationServices() {
            const servicesContainer = document.getElementById('quotationServices');
            servicesContainer.innerHTML = `
                <div class="form-row quotation-service">
                    <div class="form-col">
                        <div class="form-group">
                            <input type="text" class="form-input service-name" placeholder="Service Name" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <input type="number" class="form-input service-price" placeholder="Price (RM)" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-col" style="display: flex; align-items: end;">
                        <button type="button" class="btn btn-danger remove-service" style="display: none;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // Add event listeners
            document.querySelectorAll('.service-price').forEach(input => {
                input.addEventListener('input', calculateQuoteTotal);
            });
        }
        
        function calculateQuoteTotal() {
            const services = document.querySelectorAll('.quotation-service');
            let total = 0;
            
            services.forEach(service => {
                const price = parseFloat(service.querySelector('.service-price').value) || 0;
                total += price;
            });
            
            document.getElementById('quoteTotal').value = total.toFixed(2);
        }
        
        function saveQuotation() {
            // Get form data
            const clientName = document.getElementById('clientName').value;
            const clientEmail = document.getElementById('clientEmail').value;
            const clientPhone = document.getElementById('clientPhone').value;
            const date = document.getElementById('quoteDate').value;
            const totalAmount = parseFloat(document.getElementById('quoteTotal').value);
            
            // Get services
            const services = [];
            document.querySelectorAll('.quotation-service').forEach(service => {
                const name = service.querySelector('.service-name').value;
                const price = parseFloat(service.querySelector('.service-price').value);
                
                if (name && price) {
                    services.push({
                        name,
                        price
                    });
                }
            });
            
            // Create quotation object
            const quotation = {
                quoteNo: generateQuoteNo(),
                date,
                clientName,
                clientEmail,
                clientPhone,
                services,
                totalAmount,
                status: 'Draft',
                createdBy: app.user.id,
                createdAt: new Date().toISOString()
            };
            
            // Check if we're editing an existing quotation
            const existingIndex = app.quotations.findIndex(q => q.quoteNo === quotation.quoteNo);
            
            if (existingIndex !== -1) {
                // Update existing quotation
                app.quotations[existingIndex] = quotation;
            } else {
                // Add new quotation
                app.quotations.push(quotation);
            }
            
            saveData();
            
            // Close modal
            closeQuotationModal();
            
            // Reload quotations
            loadQuotations();
            
            // Show notification
            showNotification('Quotation saved successfully', 'success');
        }
        
        function viewQuotation(quoteNo) {
            // Find quotation
            const quotation = app.quotations.find(q => q.quoteNo === quoteNo);
            if (!quotation) return;
            
            // Open modal with quotation data
            openQuotationModal();
            
            // Update modal title
            document.getElementById('quotationModalTitle').textContent = 'View Quotation';
            
            // Populate form
            document.getElementById('clientName').value = quotation.clientName;
            document.getElementById('clientEmail').value = quotation.clientEmail || '';
            document.getElementById('clientPhone').value = quotation.clientPhone || '';
            document.getElementById('quoteDate').value = quotation.date;
            document.getElementById('quoteTotal').value = quotation.totalAmount.toFixed(2);
            
            // Populate services
            const servicesContainer = document.getElementById('quotationServices');
            servicesContainer.innerHTML = '';
            
            quotation.services.forEach((service, index) => {
                const serviceElement = document.createElement('div');
                serviceElement.className = 'form-row quotation-service';
                serviceElement.innerHTML = `
                    <div class="form-col">
                        <div class="form-group">
                            <input type="text" class="form-input service-name" placeholder="Service Name" value="${service.name}" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <input type="number" class="form-input service-price" placeholder="Price (RM)" step="0.01" value="${service.price}" required>
                        </div>
                    </div>
                    <div class="form-col" style="display: flex; align-items: end;">
                        <button type="button" class="btn btn-danger remove-service" ${index === 0 ? 'style="display: none;"' : ''}>
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                servicesContainer.appendChild(serviceElement);
            });
            
            // Add event listeners
            document.querySelectorAll('.service-price').forEach(input => {
                input.addEventListener('input', calculateQuoteTotal);
            });
        }
        
        function editQuotation(quoteNo) {
            // Find quotation
            const quotation = app.quotations.find(q => q.quoteNo === quoteNo);
            if (!quotation) return;
            
            // Open modal with quotation data
            openQuotationModal();
            
            // Update modal title
            document.getElementById('quotationModalTitle').textContent = 'Edit Quotation';
            
            // Populate form
            document.getElementById('clientName').value = quotation.clientName;
            document.getElementById('clientEmail').value = quotation.clientEmail || '';
            document.getElementById('clientPhone').value = quotation.clientPhone || '';
            document.getElementById('quoteDate').value = quotation.date;
            document.getElementById('quoteTotal').value = quotation.totalAmount.toFixed(2);
            
            // Populate services
            const servicesContainer = document.getElementById('quotationServices');
            servicesContainer.innerHTML = '';
            
            quotation.services.forEach((service, index) => {
                const serviceElement = document.createElement('div');
                serviceElement.className = 'form-row quotation-service';
                serviceElement.innerHTML = `
                    <div class="form-col">
                        <div class="form-group">
                            <input type="text" class="form-input service-name" placeholder="Service Name" value="${service.name}" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <input type="number" class="form-input service-price" placeholder="Price (RM)" step="0.01" value="${service.price}" required>
                        </div>
                    </div>
                    <div class="form-col" style="display: flex; align-items: end;">
                        <button type="button" class="btn btn-danger remove-service" ${index === 0 ? 'style="display: none;"' : ''}>
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                servicesContainer.appendChild(serviceElement);
            });
            
            // Add event listeners
            document.querySelectorAll('.service-price').forEach(input => {
                input.addEventListener('input', calculateQuoteTotal);
            });
        }
        
        function deleteQuotation(quoteNo) {
            if (confirm('Are you sure you want to delete this quotation?')) {
                // Find and remove quotation
                const quotationIndex = app.quotations.findIndex(q => q.quoteNo === quoteNo);
                if (quotationIndex === -1) return;
                
                app.quotations.splice(quotationIndex, 1);
                saveData();
                
                // Reload quotations
                loadQuotations();
                
                // Show notification
                showNotification('Quotation deleted successfully', 'success');
            }
        }
        
        function downloadQuotation() {
            // This would generate and download a PDF in a real app
            showNotification('PDF download functionality would be implemented here', 'success');
        }
        
        function emailQuotation() {
            // This would send an email in a real app
            showNotification('Email functionality would be implemented here', 'success');
        }
        
        // Schedule Functions
        function loadSchedule() {
            // Set current week
            if (!app.currentWeek) {
                app.currentWeek = getCurrentWeek();
            }
            
            updateWeekDisplay();
            
            // Update week picker
            updateWeekPicker();
            
            // Load schedule for current week
            const weekKey = getWeekKey(app.currentWeek);
            const schedule = app.schedules[weekKey];
            
            if (schedule) {
                renderSchedule(schedule);
            } else {
                showNoSchedule();
            }
        }
        
        function getCurrentWeek() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1)); // Adjust to Monday
            
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6); // Sunday
            
            return { start: startDate, end: endDate };
        }
        
        function getWeekKey(week) {
            const startStr = formatDate(week.start);
            const endStr = formatDate(week.end);
            return `${startStr}_${endStr}`;
        }
        
        function updateWeekDisplay() {
            const startStr = app.currentWeek.start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const endStr = app.currentWeek.end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            document.getElementById('currentWeek').textContent = `${startStr} - ${endStr}`;
        }
        
        function updateWeekPicker() {
            // Format the current week for the week picker input
            const year = app.currentWeek.start.getFullYear();
            const month = String(app.currentWeek.start.getMonth() + 1).padStart(2, '0');
            
            // Find the first day of the week that contains the current date
            const firstDayOfYear = new Date(year, 0, 1);
            const pastDaysOfYear = (app.currentWeek.start - firstDayOfYear) / 86400000;
            const weekNumber = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
            
            elements.weekPicker.value = `${year}-W${String(weekNumber).padStart(2, '0')}`;
        }
        
        function handleWeekPickerChange(e) {
            const weekValue = e.target.value;
            if (!weekValue) return;
            
            const [year, week] = weekValue.split('-W').map(Number);
            
            // Calculate the start date of the selected week
            const firstDayOfYear = new Date(year, 0, 1);
            const daysOffset = (week - 1) * 7 - firstDayOfYear.getDay();
            const startDate = new Date(year, 0, 1 + daysOffset);
            
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            
            app.currentWeek = { start: startDate, end: endDate };
            
            loadSchedule();
        }
        
        function changeWeek(direction) {
            const newStart = new Date(app.currentWeek.start);
            newStart.setDate(newStart.getDate() + (direction * 7));
            
            const newEnd = new Date(newStart);
            newEnd.setDate(newStart.getDate() + 6);
            
            app.currentWeek = { start: newStart, end: newEnd };
            
            loadSchedule();
        }
        
        function createSchedule() {
            // Create empty schedule
            const weekKey = getWeekKey(app.currentWeek);
            app.schedules[weekKey] = {
                week: weekKey,
                startDate: formatDate(app.currentWeek.start),
                endDate: formatDate(app.currentWeek.end),
                entries: []
            };
            
            // Add entries for all crew members
            app.crewMembers.forEach(crew => {
                for (let i = 0; i < 7; i++) {
                    const date = new Date(app.currentWeek.start);
                    date.setDate(date.getDate() + i);
                    
                    app.schedules[weekKey].entries.push({
                        crewId: crew.id,
                        crewName: crew.name,
                        crewRole: crew.role,
                        crewOutlet: crew.outlet,
                        date: formatDate(date),
                        startTime: '',
                        endTime: '',
                        duties: '',
                        remarks: ''
                    });
                }
            });
            
            // Enter edit mode
            app.scheduleEditMode = true;
            updateScheduleControls();
            
            // Render schedule
            renderSchedule(app.schedules[weekKey]);
        }
        
        function saveSchedule() {
            // Save to localStorage
            saveData();
            
            // Exit edit mode
            app.scheduleEditMode = false;
            updateScheduleControls();
            
            // Show notification
            showNotification('Schedule saved successfully', 'success');
        }
        
        function updateScheduleControls() {
            const createBtn = document.getElementById('createScheduleBtn');
            const saveBtn = document.getElementById('saveScheduleBtn');
            
            if (app.scheduleEditMode) {
                createBtn.style.display = 'none';
                saveBtn.style.display = 'inline-flex';
            } else {
                createBtn.style.display = 'inline-flex';
                saveBtn.style.display = 'none';
            }
        }
        
        function showNoSchedule() {
            const container = document.getElementById('scheduleTableContainer');
            container.innerHTML = '<div class="no-schedule" id="noScheduleMessage">This week schedule is not yet available</div>';
        }
        
        function renderSchedule(schedule) {
            const container = document.getElementById('scheduleTableContainer');
            
            // Create table
            const table = document.createElement('table');
            table.className = 'schedule-table';
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            // Add empty cell for crew info
            const emptyHeader = document.createElement('th');
            emptyHeader.textContent = 'Employee';
            headerRow.appendChild(emptyHeader);
            
            // Add day headers
            for (let i = 0; i < 7; i++) {
                const date = new Date(app.currentWeek.start);
                date.setDate(date.getDate() + i);
                
                const dayHeader = document.createElement('th');
                dayHeader.className = 'day-header';
                dayHeader.innerHTML = `
                    ${date.toLocaleDateString('en-US', { weekday: 'short' })}
                    <div class="date-label">${date.getDate()}</div>
                `;
                headerRow.appendChild(dayHeader);
            }
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            
            // Group entries by crew
            const crewEntries = {};
            schedule.entries.forEach(entry => {
                if (!crewEntries[entry.crewId]) {
                    crewEntries[entry.crewId] = [];
                }
                crewEntries[entry.crewId].push(entry);
            });
            
            // Get active filter
            const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
            
            // Add rows for each crew
            Object.keys(crewEntries).forEach(crewId => {
                const entries = crewEntries[crewId];
                const crew = app.crewMembers.find(c => c.id === crewId);
                
                // Apply filter
                if (activeFilter === 'hq' && crew.outlet !== 'HQ') return;
                if (activeFilter === 'blm' && crew.outlet !== 'BLM') return;
                
                // Create crew info row
                const crewRow = document.createElement('tr');
                crewRow.dataset.outlet = crew.outlet.toLowerCase();
                
                // Crew info cell
                const crewCell = document.createElement('td');
                crewCell.className = 'employee-info';
                crewCell.innerHTML = `
                    <div><strong>${crew.name}</strong></div>
                    <div>${crew.role}</div>
                    <div>${crew.outlet}</div>
                `;
                crewRow.appendChild(crewCell);
                
                // Add schedule cells for each day
                let hasWorkingDay = false;
                
                for (let i = 0; i < 7; i++) {
                    const date = new Date(app.currentWeek.start);
                    date.setDate(date.getDate() + i);
                    const dateStr = formatDate(date);
                    
                    const entry = entries.find(e => e.date === dateStr);
                    const scheduleCell = document.createElement('td');
                    scheduleCell.className = 'schedule-cell';
                    
                    if (entry) {
                        let statusClass = 'schedule-working';
                        let statusText = '';
                        
                        if (entry.remarks === 'Off') {
                            statusClass = 'schedule-off';
                            statusText = 'Off Day';
                        } else if (entry.remarks === 'Annual Leave' || entry.remarks === 'Emergency Leave') {
                            statusClass = 'schedule-leave';
                            statusText = entry.remarks;
                        } else if (entry.startTime && entry.endTime) {
                            statusText = `${entry.startTime} - ${entry.endTime}`;
                            hasWorkingDay = true;
                        }
                        
                        if (app.scheduleEditMode) {
                            scheduleCell.innerHTML = `
                                <div>
                                    <input type="time" class="form-input" value="${entry.startTime}" data-crew="${crewId}" data-date="${dateStr}" data-field="startTime" style="margin-bottom: 5px;">
                                    <input type="time" class="form-input" value="${entry.endTime}" data-crew="${crewId}" data-date="${dateStr}" data-field="endTime" style="margin-bottom: 5px;">
                                    <input type="text" class="form-input" value="${entry.duties}" data-crew="${crewId}" data-date="${dateStr}" data-field="duties" placeholder="Duties" style="margin-bottom: 5px;">
                                    <select class="form-input" data-crew="${crewId}" data-date="${dateStr}" data-field="remarks">
                                        <option value="">None</option>
                                        <option value="Off" ${entry.remarks === 'Off' ? 'selected' : ''}>Off</option>
                                        <option value="Annual Leave" ${entry.remarks === 'Annual Leave' ? 'selected' : ''}>Annual Leave</option>
                                        <option value="Emergency Leave" ${entry.remarks === 'Emergency Leave' ? 'selected' : ''}>Emergency Leave</option>
                                    </select>
                                </div>
                            `;
                            
                            // Add event listeners
                            scheduleCell.querySelectorAll('input, select').forEach(input => {
                                input.addEventListener('change', updateScheduleEntry);
                            });
                        } else {
                            scheduleCell.innerHTML = `
                                <div class="schedule-status ${statusClass}">
                                    ${statusText}
                                    ${entry.duties ? `<div style="font-size: 12px; margin-top: 5px;">${entry.duties}</div>` : ''}
                                </div>
                            `;
                        }
                    }
                    
                    crewRow.appendChild(scheduleCell);
                }
                
                // Apply working/off filter
                if (activeFilter === 'working' && !hasWorkingDay) return;
                if (activeFilter === 'off' && hasWorkingDay) return;
                
                tbody.appendChild(crewRow);
            });
            
            // Add total hours row if not in edit mode
            if (!app.scheduleEditMode) {
                const totalRow = document.createElement('tr');
                totalRow.className = 'totals-row';
                
                const totalLabel = document.createElement('td');
                totalLabel.textContent = 'Total Hours';
                totalRow.appendChild(totalLabel);
                
                // Calculate total hours for each day
                for (let i = 0; i < 7; i++) {
                    const date = new Date(app.currentWeek.start);
                    date.setDate(date.getDate() + i);
                    const dateStr = formatDate(date);
                    
                    let totalHours = 0;
                    
                    Object.keys(crewEntries).forEach(crewId => {
                        const entries = crewEntries[crewId];
                        const entry = entries.find(e => e.date === dateStr);
                        
                        if (entry && entry.startTime && entry.endTime && !entry.remarks) {
                            const start = new Date(`2000-01-01T${entry.startTime}`);
                            const end = new Date(`2000-01-01T${entry.endTime}`);
                            const hours = (end - start) / (1000 * 60 * 60);
                            totalHours += hours;
                        }
                    });
                    
                    const totalCell = document.createElement('td');
                    totalCell.textContent = totalHours.toFixed(1);
                    totalRow.appendChild(totalCell);
                }
                
                tbody.appendChild(totalRow);
            }
            
            table.appendChild(tbody);
            container.innerHTML = '';
            container.appendChild(table);
            
            // Add event listeners for filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    renderSchedule(schedule);
                });
            });
        }
        
        function updateScheduleEntry(e) {
            const crewId = e.target.dataset.crew;
            const date = e.target.dataset.date;
            const field = e.target.dataset.field;
            const value = e.target.value;
            
            const weekKey = getWeekKey(app.currentWeek);
            const schedule = app.schedules[weekKey];
            
            if (schedule) {
                const entry = schedule.entries.find(e => e.crewId === crewId && e.date === date);
                if (entry) {
                    entry[field] = value;
                }
            }
        }
        
        // Orders Functions
        function loadOrders() {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';
            
            if (app.orders.length === 0) {
                // Initialize with sample orders
                app.orders = [
                    {
                        id: 'ORD-0001',
                        date: getCurrentDateStr(),
                        customer: 'John Doe',
                        items: [
                            { name: 'Sample Item 1', quantity: 2, price: 10.00 },
                            { name: 'Sample Item 2', quantity: 1, price: 20.00 }
                        ],
                        total: 40.00,
                        outlet: 'HQ',
                        status: 'Pending',
                        assignedTo: ''
                    },
                    {
                        id: 'ORD-0002',
                        date: getCurrentDateStr(),
                        customer: 'Jane Smith',
                        items: [
                            { name: 'Sample Item 3', quantity: 3, price: 15.00 }
                        ],
                        total: 45.00,
                        outlet: 'BLM',
                        status: 'Assigned',
                        assignedTo: '0003'
                    }
                ];
                saveData();
            }
            
            app.orders.forEach(order => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${order.id}</td>
                    <td>${order.date}</td>
                    <td>${order.customer}</td>
                    <td>${order.items.map(i => `${i.name} (x${i.quantity})`).join(', ')}</td>
                    <td>RM${order.total.toFixed(2)}</td>
                    <td>${order.outlet}</td>
                    <td><span class="status-badge ${order.status === 'Pending' ? 'status-inactive' : 'status-active'}">${order.status}</span></td>
                    <td>
                        ${app.user.isAdmin ? 
                            `<button class="btn btn-sm btn-danger" onclick="assignOrder('${order.id}')">Assign</button>` : 
                            order.assignedTo === app.user.id ? 
                            `<button class="btn btn-sm btn-primary" onclick="generateCashbillFromOrder('${order.id}')">Generate Cashbill</button>` : 
                            ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function openOrderModal() {
            // Reset form
            elements.orderForm.reset();
            
            // Set today's date
            document.getElementById('orderDate').value = getCurrentDateStr();
            
            // Populate item dropdown
            populateOrderItemDropdown();
            
            // Reset items
            resetOrderItems();
            
            // Show modal
            elements.orderModal.classList.add('active');
        }
        
        function closeOrderModal() {
            elements.orderModal.classList.remove('active');
        }
        
        function populateOrderItemDropdown() {
            const selects = document.querySelectorAll('.order-item-select');
            
            selects.forEach(select => {
                select.innerHTML = '<option value="">Select Item</option>';
                
                app.stockItems.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.code;
                    option.textContent = `${item.name} - RM${item.price.toFixed(2)}`;
                    option.dataset.price = item.price;
                    select.appendChild(option);
                });
                
                // Add change event listener
                select.addEventListener('change', updateOrderItemPrice);
            });
        }
        
        function updateOrderItemPrice(e) {
            const select = e.target;
            const priceInput = select.closest('.order-item').querySelector('.order-item-price');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption && selectedOption.value) {
                priceInput.value = selectedOption.dataset.price;
                calculateOrderTotal();
            } else {
                priceInput.value = '';
            }
        }
        
        function addOrderItem() {
            const itemsContainer = document.getElementById('orderItems');
            const itemTemplate = document.querySelector('.order-item').cloneNode(true);
            
            // Reset values
            itemTemplate.querySelector('.order-item-select').value = '';
            itemTemplate.querySelector('.order-item-quantity').value = '1';
            itemTemplate.querySelector('.order-item-price').value = '';
            
            // Show remove button
            itemTemplate.querySelector('.remove-order-item').style.display = 'inline-flex';
            
            // Add event listener
            itemTemplate.querySelector('.order-item-select').addEventListener('change', updateOrderItemPrice);
            
            itemsContainer.appendChild(itemTemplate);
            
            // Populate dropdown
            populateOrderItemDropdown();
        }
        
        function removeOrderItem(item) {
            item.remove();
            calculateOrderTotal();
            
            // Show/hide remove buttons
            const items = document.querySelectorAll('.order-item');
            items.forEach((item, index) => {
                const removeBtn = item.querySelector('.remove-order-item');
                if (items.length > 1) {
                    removeBtn.style.display = 'inline-flex';
                } else {
                    removeBtn.style.display = 'none';
                }
            });
        }
        
        function resetOrderItems() {
            const itemsContainer = document.getElementById('orderItems');
            itemsContainer.innerHTML = `
                <div class="form-row order-item">
                    <div class="form-col">
                        <div class="form-group">
                            <select class="form-input order-item-select" required>
                                <option value="">Select Item</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <input type="number" class="form-input order-item-quantity" placeholder="Quantity" min="1" value="1" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <input type="number" class="form-input order-item-price" placeholder="Price (RM)" step="0.01" readonly>
                        </div>
                    </div>
                    <div class="form-col" style="display: flex; align-items: end;">
                        <button type="button" class="btn btn-danger remove-order-item" style="display: none;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // Populate dropdown
            populateOrderItemDropdown();
        }
        
        function calculateOrderTotal() {
            const items = document.querySelectorAll('.order-item');
            let total = 0;
            
            items.forEach(item => {
                const quantity = parseFloat(item.querySelector('.order-item-quantity').value) || 0;
                const price = parseFloat(item.querySelector('.order-item-price').value) || 0;
                total += quantity * price;
            });
            
            document.getElementById('orderTotal').value = total.toFixed(2);
        }
        
        function saveOrder() {
            // Get form data
            const customer = document.getElementById('orderCustomer').value;
            const phone = document.getElementById('orderPhone').value;
            const date = document.getElementById('orderDate').value;
            const outlet = document.getElementById('orderOutlet').value;
            const total = parseFloat(document.getElementById('orderTotal').value);
            
            // Get items
            const items = [];
            document.querySelectorAll('.order-item').forEach(item => {
                const itemCode = item.querySelector('.order-item-select').value;
                const quantity = parseInt(item.querySelector('.order-item-quantity').value);
                const price = parseFloat(item.querySelector('.order-item-price').value);
                
                if (itemCode && quantity && price) {
                    const stockItem = app.stockItems.find(si => si.code === itemCode);
                    items.push({
                        code: itemCode,
                        name: stockItem.name,
                        quantity: quantity,
                        price: price
                    });
                }
            });
            
            // Create order object
            const order = {
                id: generateOrderId(),
                date,
                customer,
                phone,
                items,
                total,
                outlet,
                status: 'Pending',
                assignedTo: ''
            };
            
            // Add to app state
            app.orders.push(order);
            saveData();
            
            // Close modal
            closeOrderModal();
            
            // Reload orders
            loadOrders();
            
            // Show notification
            showNotification('Order created successfully', 'success');
        }
        
        function generateOrderId() {
            const prefix = 'ORD-';
            const nextNumber = app.orders.length + 1;
            return `${prefix}${String(nextNumber).padStart(4, '0')}`;
        }
        
        function assignOrder(orderId) {
            // Find order
            const order = app.orders.find(o => o.id === orderId);
            if (!order) return;
            
            // Open assign order modal
            elements.assignOrderModal.classList.add('active');
            
            // Set order ID as data attribute
            document.getElementById('confirmAssignOrderBtn').dataset.orderId = orderId;
            
            // Populate crew dropdown based on selected outlet
            updateCrewDropdownForOutlet(order.outlet);
        }
        
        function closeAssignOrderModal() {
            elements.assignOrderModal.classList.remove('active');
        }
        
        function updateCrewDropdownForOutlet(outlet) {
            const crewSelect = document.getElementById('assignOrderCrew');
            crewSelect.innerHTML = '<option value="">Select Crew Member</option>';
            
            // Filter crew members by outlet
            const crewAtOutlet = app.crewMembers.filter(crew => crew.outlet === outlet);
            
            crewAtOutlet.forEach(crew => {
                const option = document.createElement('option');
                option.value = crew.id;
                option.textContent = `${crew.name} (${crew.role})`;
                crewSelect.appendChild(option);
            });
            
            // Update outlet selection
            document.getElementById('assignOrderOutlet').value = outlet;
            
            // Add event listener for outlet change
            document.getElementById('assignOrderOutlet').addEventListener('change', (e) => {
                updateCrewDropdownForOutlet(e.target.value);
            });
        }
        
        function confirmAssignOrder() {
            const orderId = document.getElementById('confirmAssignOrderBtn').dataset.orderId;
            const outlet = document.getElementById('assignOrderOutlet').value;
            const crewId = document.getElementById('assignOrderCrew').value;
            
            // Find order
            const orderIndex = app.orders.findIndex(o => o.id === orderId);
            if (orderIndex === -1) return;
            
            // Update order
            app.orders[orderIndex].outlet = outlet;
            app.orders[orderIndex].assignedTo = crewId;
            app.orders[orderIndex].status = 'Assigned';
            
            saveData();
            
            // Close modal
            closeAssignOrderModal();
            
            // Reload orders
            loadOrders();
            
            // Show notification
            showNotification('Order assigned successfully', 'success');
        }
        
        function generateCashbillFromOrder(orderId) {
            // Find order
            const order = app.orders.find(o => o.id === orderId);
            if (!order) return;
            
            // Open cashbill modal with order data
            openCashbillModal();
            
            // Update modal title
            document.getElementById('cashbillModalTitle').textContent = 'Create Cashbill from Order';
            
            // Set customer info
            document.getElementById('customerName').value = order.customer;
            document.getElementById('customerPhone').value = order.phone || '';
            
            // Add items from order
            const itemsContainer = document.getElementById('cashbillItems');
            itemsContainer.innerHTML = '';
            
            order.items.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'form-row cashbill-item';
                itemElement.innerHTML = `
                    <div class="form-col">
                        <div class="form-group">
                            <select class="form-input item-select" required>
                                <option value="">Select Item</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <input type="number" class="form-input item-quantity" placeholder="Quantity" min="1" value="${item.quantity}" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <input type="number" class="form-input item-price" placeholder="Price" step="0.01" value="${item.price}" readonly>
                        </div>
                    </div>
                    <div class="form-col" style="display: flex; align-items: end;">
                        <button type="button" class="btn btn-danger remove-item" ${index === 0 ? 'style="display: none;"' : ''}>
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                itemsContainer.appendChild(itemElement);
            });
            
            // Populate dropdown
            populateItemDropdown();
            
            // Set selected values
            const itemSelects = document.querySelectorAll('.item-select');
            itemSelects.forEach((select, index) => {
                if (order.items[index]) {
                    // Try to find matching item by name
                    const stockItem = app.stockItems.find(si => si.name === order.items[index].name);
                    if (stockItem) {
                        select.value = stockItem.code;
                    }
                }
            });
            
            // Calculate total
            calculateTotal();
        }
        
        // Activity Log Functions
        function loadActivityLogs() {
            const tbody = document.getElementById('activityTableBody');
            tbody.innerHTML = '';
            
            if (app.activityLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-schedule">No activity logs found</td></tr>';
                return;
            }
            
            // Get filter value
            const filterType = elements.activityFilter.value;
            
            // Filter logs based on selection
            let filteredLogs = app.activityLogs;
            if (filterType !== 'all') {
                filteredLogs = app.activityLogs.filter(log => log.type === filterType);
            }
            
            // Sort logs by timestamp (newest first)
            filteredLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Display logs
            filteredLogs.forEach(log => {
                const tr = document.createElement('tr');
                
                // Format timestamp
                const timestamp = new Date(log.timestamp);
                const formattedDateTime = timestamp.toLocaleDateString() + ' ' + timestamp.toLocaleTimeString();
                
                // Get log type display
                let logTypeDisplay = '';
                let logTypeClass = '';
                
                switch (log.type) {
                    case 'punch-in':
                        logTypeDisplay = 'Punch In';
                        logTypeClass = 'log-punch-in';
                        if (log.isLate) {
                            logTypeDisplay += ' (Late)';
                            logTypeClass = 'log-late';
                        }
                        break;
                    case 'punch-out':
                        logTypeDisplay = 'Punch Out';
                        logTypeClass = 'log-punch-out';
                        break;
                    case 'break':
                        logTypeDisplay = 'Break';
                        logTypeClass = 'log-break';
                        break;
                    case 'resume':
                        logTypeDisplay = 'Resume';
                        logTypeClass = 'log-break';
                        if (log.isOverbreak) {
                            logTypeDisplay += ' (Overbreak)';
                            logTypeClass = 'log-overbreak';
                        }
                        break;
                }
                
                tr.innerHTML = `
                    <td>${formattedDateTime}</td>
                    <td>${log.userName}</td>
                    <td><span class="log-type ${logTypeClass}">${logTypeDisplay}</span></td>
                    <td>${log.duration || '-'}</td>
                    <td>${log.notes || (log.isLate ? `Late by ${log.lateBy}` : '') || (log.isOverbreak ? `Overbreak by ${log.overbreakBy}` : '') || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function filterActivityLogs() {
            loadActivityLogs();
        }
        
        // Attendance Management Functions
        function loadAttendancePage() {
            // Set today's date as default
            elements.attendanceDate.value = getCurrentDateStr();
            
            // Populate crew filter
            const crewFilter = document.getElementById('crewFilter');
            crewFilter.innerHTML = '<option value="">All Crew</option>';
            
            app.crewMembers.forEach(crew => {
                const option = document.createElement('option');
                option.value = crew.id;
                option.textContent = `${crew.name} (${crew.role})`;
                crewFilter.appendChild(option);
            });
            
            // Load attendance records
            loadAttendanceRecords();
        }
        
        function loadAttendanceRecords() {
            const date = elements.attendanceDate.value;
            const crewId = elements.crewFilter.value;
            
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';
            
            // Get attendance records for the selected date and crew
            let records = [];
            
            if (date) {
                records = app.attendanceRecords.filter(record => record.date === date);
                
                if (crewId) {
                    records = records.filter(record => record.crewId === crewId);
                }
            }
            
            // If no records found, create empty records for all crew members
            if (records.length === 0 && date) {
                const crewToProcess = crewId ? 
                    app.crewMembers.filter(crew => crew.id === crewId) : 
                    app.crewMembers;
                
                crewToProcess.forEach(crew => {
                    const userSchedule = getUserSchedule(crew.id, date);
                    
                    if (userSchedule) {
                        records.push({
                            id: generateId(),
                            crewId: crew.id,
                            crewName: crew.name,
                            date: date,
                            scheduledTime: userSchedule.startTime + ' - ' + userSchedule.endTime,
                            punchInTime: '',
                            punchOutTime: '',
                            breakStartTime: '',
                            breakEndTime: '',
                            breakDuration: '',
                            status: 'No Record',
                            isLate: false,
                            isOverbreak: false,
                            notes: ''
                        });
                    }
                });
            }
            
            // Display records
            records.forEach(record => {
                const tr = document.createElement('tr');
                
                // Determine status
                let statusClass = 'status-inactive';
                let statusText = record.status;
                
                if (record.isLate) {
                    statusClass = 'status-warning';
                    statusText = 'Late';
                } else if (record.isOverbreak) {
                    statusClass = 'status-warning';
                    statusText = 'Overbreak';
                } else if (record.punchInTime && record.punchOutTime) {
                    statusClass = 'status-active';
                    statusText = 'Complete';
                } else if (record.punchInTime) {
                    statusClass = 'status-active';
                    statusText = 'Working';
                }
                
                tr.innerHTML = `
                    <td>${record.crewId}</td>
                    <td>${record.crewName}</td>
                    <td>${record.scheduledTime}</td>
                    <td>${record.punchInTime || '-'}</td>
                    <td>${record.punchOutTime || '-'}</td>
                    <td>${record.breakStartTime || '-'}</td>
                    <td>${record.breakEndTime || '-'}</td>
                    <td>${record.breakDuration || '-'}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <div class="attendance-actions">
                            <button class="btn btn-sm btn-primary" onclick="editAttendanceRecord('${record.id}')">Edit</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function editAttendanceRecord(recordId) {
            // Find attendance record
            const record = app.attendanceRecords.find(r => r.id === recordId);
            if (!record) return;
            
            // Open attendance edit modal
            elements.attendanceEditModal.classList.add('active');
            
            // Populate form
            document.getElementById('editCrewName').value = record.crewName;
            document.getElementById('editAttendanceDate').value = record.date;
            document.getElementById('editScheduledTime').value = record.scheduledTime;
            document.getElementById('editPunchInTime').value = record.punchInTime;
            document.getElementById('editPunchOutTime').value = record.punchOutTime;
            document.getElementById('editBreakStartTime').value = record.breakStartTime;
            document.getElementById('editBreakEndTime').value = record.breakEndTime;
            document.getElementById('editAttendanceNotes').value = record.notes || '';
            
            // Set record ID as data attribute
            document.getElementById('saveAttendanceEditBtn').dataset.recordId = recordId;
            
            // Update status indicators
            updatePunchInStatus();
            updateBreakStatus();
        }
        
        function closeAttendanceEditModal() {
            elements.attendanceEditModal.classList.remove('active');
        }
        
        function updatePunchInStatus() {
            const punchInTime = elements.editPunchInTime.value;
            const scheduledTimeText = document.getElementById('editScheduledTime').value;
            const date = document.getElementById('editAttendanceDate').value;
            
            if (!punchInTime || !scheduledTimeText || !date) {
                elements.punchInStatus.textContent = 'Normal';
                elements.punchInStatus.className = 'time-status status-normal';
                return;
            }
            
            // Extract scheduled start time
            const scheduledStartTime = scheduledTimeText.split(' - ')[0];
            
            // Create date objects for comparison
            const punchInDateTime = new Date(`${date}T${punchInTime}`);
            const scheduledDateTime = new Date(`${date}T${scheduledStartTime}`);
            const lateThreshold = new Date(`${date}T10:01:00`);
            
            // Check if punch in is late
            if (punchInDateTime > lateThreshold) {
                const lateBy = calculateTimeDifference(scheduledDateTime, punchInDateTime);
                elements.punchInStatus.textContent = `Late by ${lateBy}`;
                elements.punchInStatus.className = 'time-status status-late';
            } else {
                elements.punchInStatus.textContent = 'Normal';
                elements.punchInStatus.className = 'time-status status-normal';
            }
        }
        
        function updateBreakStatus() {
            const breakStartTime = elements.editBreakStartTime.value;
            const breakEndTime = elements.editBreakEndTime.value;
            
            if (!breakStartTime || !breakEndTime) {
                elements.breakStatus.textContent = 'Normal';
                elements.breakStatus.className = 'time-status status-normal';
                return;
            }
            
            // Create date objects for comparison
            const date = document.getElementById('editAttendanceDate').value;
            const breakStartDateTime = new Date(`${date}T${breakStartTime}`);
            const breakEndDateTime = new Date(`${date}T${breakEndTime}`);
            
            // Calculate break duration
            const breakDurationMs = breakEndDateTime - breakStartDateTime;
            const breakDurationHours = breakDurationMs / (1000 * 60 * 60);
            
            // Check if break is over 1 hour
            if (breakDurationHours > 1) {
                const overbreakBy = calculateTimeDifference(
                    new Date(breakStartDateTime.getTime() + 60 * 60 * 1000), // 1 hour after break start
                    breakEndDateTime
                );
                elements.breakStatus.textContent = `Overbreak by ${overbreakBy}`;
                elements.breakStatus.className = 'time-status status-overbreak';
            } else {
                elements.breakStatus.textContent = 'Normal';
                elements.breakStatus.className = 'time-status status-normal';
            }
        }
        
        function saveAttendanceEdit() {
            const recordId = document.getElementById('saveAttendanceEditBtn').dataset.recordId;
            
            // Find attendance record
            const recordIndex = app.attendanceRecords.findIndex(r => r.id === recordId);
            
            // Get form values
            const punchInTime = document.getElementById('editPunchInTime').value;
            const punchOutTime = document.getElementById('editPunchOutTime').value;
            const breakStartTime = document.getElementById('editBreakStartTime').value;
            const breakEndTime = document.getElementById('editBreakEndTime').value;
            const notes = document.getElementById('editAttendanceNotes').value;
            
            // Calculate break duration
            let breakDuration = '';
            if (breakStartTime && breakEndTime) {
                const date = document.getElementById('editAttendanceDate').value;
                const breakStartDateTime = new Date(`${date}T${breakStartTime}`);
                const breakEndDateTime = new Date(`${date}T${breakEndTime}`);
                breakDuration = calculateTimeDifference(breakStartDateTime, breakEndDateTime);
            }
            
            // Determine status
            let status = 'No Record';
            let isLate = false;
            let isOverbreak = false;
            
            if (punchInTime) {
                const scheduledTimeText = document.getElementById('editScheduledTime').value;
                const scheduledStartTime = scheduledTimeText.split(' - ')[0];
                const date = document.getElementById('editAttendanceDate').value;
                
                // Create date objects for comparison
                const punchInDateTime = new Date(`${date}T${punchInTime}`);
                const scheduledDateTime = new Date(`${date}T${scheduledStartTime}`);
                const lateThreshold = new Date(`${date}T10:01:00`);
                
                // Check if punch in is late
                if (punchInDateTime > lateThreshold) {
                    isLate = true;
                    status = 'Late';
                } else {
                    status = 'Working';
                }
            }
            
            // Check for overbreak
            if (breakStartTime && breakEndTime) {
                const date = document.getElementById('editAttendanceDate').value;
                const breakStartDateTime = new Date(`${date}T${breakStartTime}`);
                const breakEndDateTime = new Date(`${date}T${breakEndTime}`);
                
                // Calculate break duration
                const breakDurationMs = breakEndDateTime - breakStartDateTime;
                const breakDurationHours = breakDurationMs / (1000 * 60 * 60);
                
                // Check if break is over 1 hour
                if (breakDurationHours > 1) {
                    isOverbreak = true;
                    status = 'Overbreak';
                }
            }
            
            if (punchInTime && punchOutTime && !isLate && !isOverbreak) {
                status = 'Complete';
            }
            
            // Update or create record
            if (recordIndex !== -1) {
                // Update existing record
                app.attendanceRecords[recordIndex] = {
                    ...app.attendanceRecords[recordIndex],
                    punchInTime,
                    punchOutTime,
                    breakStartTime,
                    breakEndTime,
                    breakDuration,
                    status,
                    isLate,
                    isOverbreak,
                    notes
                };
            } else {
                // Create new record
                const crewId = document.getElementById('editCrewName').value.split(' ')[0]; // Extract crew ID from name
                const date = document.getElementById('editAttendanceDate').value;
                const crew = app.crewMembers.find(c => c.name.includes(document.getElementById('editCrewName').value.split(' ')[0]));
                
                if (crew) {
                    app.attendanceRecords.push({
                        id: recordId,
                        crewId: crew.id,
                        crewName: crew.name,
                        date,
                        scheduledTime: document.getElementById('editScheduledTime').value,
                        punchInTime,
                        punchOutTime,
                        breakStartTime,
                        breakEndTime,
                        breakDuration,
                        status,
                        isLate,
                        isOverbreak,
                        notes
                    });
                }
            }
            
            // Save data
            saveData();
            
            // Close modal
            closeAttendanceEditModal();
            
            // Reload attendance records
            loadAttendanceRecords();
            
            // Show notification
            showNotification('Attendance record updated successfully', 'success');
        }
        
        // Crew Management Functions
        function loadCrewMembers() {
            const tbody = document.getElementById('crewTableBody');
            tbody.innerHTML = '';
            
            app.crewMembers.forEach(crew => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${crew.id}</td>
                    <td>${crew.name}</td>
                    <td>${crew.role}</td>
                    <td>${crew.outlet}</td>
                    <td><span class="status-badge ${crew.status === 'Active' ? 'status-active' : 'status-inactive'}">${crew.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editCrew('${crew.id}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCrew('${crew.id}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function openCrewModal() {
            // Reset form
            elements.crewForm.reset();
            
            // Update modal title
            document.getElementById('crewModalTitle').textContent = 'Add Crew Member';
            
            // Show modal
            elements.crewModal.classList.add('active');
        }
        
        function closeCrewModal() {
            elements.crewModal.classList.remove('active');
        }
        
        function saveCrew() {
            // Get form data
            const id = document.getElementById('crewId').value;
            const name = document.getElementById('crewName').value;
            const role = document.getElementById('crewRole').value;
            const outlet = document.getElementById('crewOutlet').value;
            
            // Check if crew member already exists
            const existingCrewIndex = app.crewMembers.findIndex(c => c.id === id);
            
            if (existingCrewIndex !== -1) {
                // Update existing crew member
                app.crewMembers[existingCrewIndex] = {
                    ...app.crewMembers[existingCrewIndex],
                    name,
                    role,
                    outlet
                };
            } else {
                // Add new crew member
                app.crewMembers.push({
                    id,
                    name,
                    role,
                    outlet,
                    status: 'Active'
                });
            }
            
            // Save to localStorage
            saveCrewMembers();
            
            // Close modal
            closeCrewModal();
            
            // Reload crew members
            loadCrewMembers();
            
            // Show notification
            showNotification('Crew member saved successfully', 'success');
        }
        
        function saveCrewMembers() {
            localStorage.setItem('pneCrewMembers', JSON.stringify(app.crewMembers));
        }
        
        function editCrew(id) {
            // Find crew member
            const crew = app.crewMembers.find(c => c.id === id);
            if (!crew) return;
            
            // Open modal with crew data
            openCrewModal();
            
            // Update modal title
            document.getElementById('crewModalTitle').textContent = 'Edit Crew Member';
            
            // Populate form
            document.getElementById('crewId').value = crew.id;
            document.getElementById('crewId').disabled = true;
            document.getElementById('crewName').value = crew.name;
            document.getElementById('crewRole').value = crew.role;
            document.getElementById('crewOutlet').value = crew.outlet;
        }
        
        function deleteCrew(id) {
            if (confirm('Are you sure you want to delete this crew member?')) {
                // Find and remove crew member
                const crewIndex = app.crewMembers.findIndex(c => c.id === id);
                if (crewIndex === -1) return;
                
                app.crewMembers.splice(crewIndex, 1);
                
                // Save to localStorage
                saveCrewMembers();
                
                // Reload crew members
                loadCrewMembers();
                
                // Show notification
                showNotification('Crew member deleted successfully', 'success');
            }
        }
        
        // Stock Management Functions
        function loadStockItems() {
            const tbody = document.getElementById('stockTableBody');
            tbody.innerHTML = '';
            
            app.stockItems.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.code}</td>
                    <td>${item.name}</td>
                    <td>${item.description}</td>
                    <td>RM${item.price.toFixed(2)}</td>
                    <td>${item.quantity}</td>
                    <td>${item.outlet}</td>
                    <td>
                        ${app.user.isAdmin ? 
                            `<button class="btn btn-sm btn-primary" onclick="editStock('${item.code}')">Edit</button>
                             <button class="btn btn-sm btn-danger" onclick="deleteStock('${item.code}')">Delete</button>` : 
                            ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function openStockModal() {
            // Reset form
            elements.stockForm.reset();
            
            // Update modal title
            document.getElementById('stockModalTitle').textContent = 'Add Stock Item';
            
            // Show modal
            elements.stockModal.classList.add('active');
        }
        
        function closeStockModal() {
            elements.stockModal.classList.remove('active');
        }
        
        function saveStock() {
            // Get form data
            const code = document.getElementById('itemCode').value;
            const name = document.getElementById('itemName').value;
            const description = document.getElementById('itemDescription').value;
            const price = parseFloat(document.getElementById('itemPrice').value);
            const quantity = parseInt(document.getElementById('itemQuantity').value);
            const outlet = document.getElementById('itemOutlet').value;
            
            // Check if stock item already exists
            const existingStockIndex = app.stockItems.findIndex(s => s.code === code);
            
            if (existingStockIndex !== -1) {
                // Update existing stock item
                app.stockItems[existingStockIndex] = {
                    ...app.stockItems[existingStockIndex],
                    name,
                    description,
                    price,
                    quantity,
                    outlet
                };
            } else {
                // Add new stock item
                app.stockItems.push({
                    code,
                    name,
                    description,
                    price,
                    quantity,
                    outlet
                });
            }
            
            // Save to localStorage
            saveStockItems();
            
            // Close modal
            closeStockModal();
            
            // Reload stock items
            loadStockItems();
            
            // Show notification
            showNotification('Stock item saved successfully', 'success');
        }
        
        function saveStockItems() {
            localStorage.setItem('pneStockItems', JSON.stringify(app.stockItems));
        }
        
        function editStock(code) {
            // Find stock item
            const stock = app.stockItems.find(s => s.code === code);
            if (!stock) return;
            
            // Open modal with stock data
            openStockModal();
            
            // Update modal title
            document.getElementById('stockModalTitle').textContent = 'Edit Stock Item';
            
            // Populate form
            document.getElementById('itemCode').value = stock.code;
            document.getElementById('itemCode').disabled = true;
            document.getElementById('itemName').value = stock.name;
            document.getElementById('itemDescription').value = stock.description;
            document.getElementById('itemPrice').value = stock.price;
            document.getElementById('itemQuantity').value = stock.quantity;
            document.getElementById('itemOutlet').value = stock.outlet;
        }
        
        function deleteStock(code) {
            if (confirm('Are you sure you want to delete this stock item?')) {
                // Find and remove stock item
                const stockIndex = app.stockItems.findIndex(s => s.code === code);
                if (stockIndex === -1) return;
                
                app.stockItems.splice(stockIndex, 1);
                
                // Save to localStorage
                saveStockItems();
                
                // Reload stock items
                loadStockItems();
                
                // Show notification
                showNotification('Stock item deleted successfully', 'success');
            }
        }
        
        // Stock Receiving Functions
        function loadStockReceivingData() {
            const receivingData = localStorage.getItem('pneStockReceivingRecords');
            if (receivingData) {
                app.stockReceivingRecords = JSON.parse(receivingData);
            }
        }
        
        function saveStockReceivingData() {
            localStorage.setItem('pneStockReceivingRecords', JSON.stringify(app.stockReceivingRecords));
        }
        
        function loadStockReceivingPage() {
            // Set today's date as default
            elements.receivingDate.value = getCurrentDateStr();
            
            // Set received by to current user
            elements.receivedBy.value = app.user.name;
            
            // Populate item dropdown
            populateReceivingItemDropdown();
            
            // Reset items
            resetReceivingItems();
            
            // Load receiving records
            loadReceivingRecords();
            
            // Set up event listeners
            setupReceivingEventListeners();
        }
        
        function populateReceivingItemDropdown() {
            const selects = document.querySelectorAll('.item-select');
            
            selects.forEach(select => {
                select.innerHTML = '<option value="">Select Item</option>';
                
                app.stockItems.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.code;
                    option.textContent = `${item.name} (Current Stock: ${item.quantity})`;
                    option.dataset.price = item.price;
                    select.appendChild(option);
                });
                
                // Add change event listener
                select.addEventListener('change', updateReceivingItemDetails);
            });
        }
        
        function updateReceivingItemDetails(e) {
            const select = e.target;
            const itemRow = select.closest('.receiving-item');
            const costInput = itemRow.querySelector('.item-cost');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption && selectedOption.value) {
                // Pre-fill with current price, but allow editing
                costInput.value = selectedOption.dataset.price || '';
                calculateReceivingTotal();
            } else {
                costInput.value = '';
            }
        }
        
        function addReceivingItem() {
            const itemsContainer = document.getElementById('receivingItems');
            const itemTemplate = document.querySelector('.receiving-item').cloneNode(true);
            
            // Reset values
            itemTemplate.querySelector('.item-select').value = '';
            itemTemplate.querySelector('.item-quantity').value = '1';
            itemTemplate.querySelector('.item-cost').value = '';
            
            // Show remove button
            itemTemplate.querySelector('.remove-receiving-item').style.display = 'inline-flex';
            
            // Add event listener
            itemTemplate.querySelector('.item-select').addEventListener('change', updateReceivingItemDetails);
            itemTemplate.querySelector('.item-quantity').addEventListener('input', calculateReceivingTotal);
            itemTemplate.querySelector('.item-cost').addEventListener('input', calculateReceivingTotal);
            
            itemsContainer.appendChild(itemTemplate);
            
            // Populate dropdown
            populateReceivingItemDropdown();
            
            // Show/hide remove buttons
            updateReceivingRemoveButtons();
        }
        
        function removeReceivingItem(item) {
            item.remove();
            calculateReceivingTotal();
            updateReceivingRemoveButtons();
        }
        
        function resetReceivingItems() {
            const itemsContainer = document.getElementById('receivingItems');
            itemsContainer.innerHTML = `
                <div class="form-row receiving-item">
                    <div class="form-col">
                        <div class="form-group">
                            <select class="form-input item-select" required>
                                <option value="">Select Item</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <input type="number" class="form-input item-quantity" placeholder="Quantity" min="1" value="1" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <input type="number" class="form-input item-cost" placeholder="Cost (RM)" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-col" style="display: flex; align-items: end;">
                        <button type="button" class="btn btn-danger remove-receiving-item" style="display: none;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // Populate dropdown
            populateReceivingItemDropdown();
            
            // Add event listeners
            document.querySelector('.item-select').addEventListener('change', updateReceivingItemDetails);
            document.querySelector('.item-quantity').addEventListener('input', calculateReceivingTotal);
            document.querySelector('.item-cost').addEventListener('input', calculateReceivingTotal);
        }
        
        function updateReceivingRemoveButtons() {
            const items = document.querySelectorAll('.receiving-item');
            items.forEach((item, index) => {
                const removeBtn = item.querySelector('.remove-receiving-item');
                if (items.length > 1) {
                    removeBtn.style.display = 'inline-flex';
                } else {
                    removeBtn.style.display = 'none';
                }
            });
        }
        
        function calculateReceivingTotal() {
            const items = document.querySelectorAll('.receiving-item');
            let total = 0;
            
            items.forEach(item => {
                const quantity = parseInt(item.querySelector('.item-quantity').value) || 0;
                const cost = parseFloat(item.querySelector('.item-cost').value) || 0;
                total += quantity * cost;
            });
            
            document.getElementById('totalCost').value = total.toFixed(2);
        }
        
        function setupReceivingEventListeners() {
            // Add item button
            document.getElementById('addReceivingItemBtn').addEventListener('click', addReceivingItem);
            
            // Preview button
            document.getElementById('previewReceivingBtn').addEventListener('click', previewReceiving);
            
            // Save button
            document.getElementById('saveReceivingBtn').addEventListener('click', saveReceiving);
            
            // Filter dropdown
            elements.receivingFilter.addEventListener('change', loadReceivingRecords);
        }
        
        function previewReceiving() {
            // Validate form
            const date = elements.receivingDate.value;
            const supplier = elements.supplierName.value;
            
            if (!date || !supplier) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            // Check if at least one item is added
            const items = document.querySelectorAll('.receiving-item');
            let hasValidItem = false;
            
            items.forEach(item => {
                const itemCode = item.querySelector('.item-select').value;
                const quantity = parseInt(item.querySelector('.item-quantity').value) || 0;
                const cost = parseFloat(item.querySelector('.item-cost').value) || 0;
                
                if (itemCode && quantity > 0 && cost > 0) {
                    hasValidItem = true;
                }
            });
            
            if (!hasValidItem) {
                showNotification('Please add at least one valid item', 'error');
                return;
            }
            
            // Show preview notification
            showNotification('Preview functionality would be implemented here', 'success');
        }
        
        function saveReceiving() {
            // Validate form
            const date = elements.receivingDate.value;
            const supplier = elements.supplierName.value;
            const invoiceNumber = elements.invoiceNumber.value;
            const receivedBy = elements.receivedBy.value;
            const notes = elements.receivingNotes.value;
            const totalCost = parseFloat(document.getElementById('totalCost').value) || 0;
            
            if (!date || !supplier) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            // Get items
            const items = [];
            const itemElements = document.querySelectorAll('.receiving-item');
            
            itemElements.forEach(itemElement => {
                const itemCode = itemElement.querySelector('.item-select').value;
                const quantity = parseInt(itemElement.querySelector('.item-quantity').value) || 0;
                const cost = parseFloat(itemElement.querySelector('.item-cost').value) || 0;
                
                if (itemCode && quantity > 0 && cost > 0) {
                    const stockItem = app.stockItems.find(si => si.code === itemCode);
                    if (stockItem) {
                        items.push({
                            code: itemCode,
                            name: stockItem.name,
                            quantity: quantity,
                            cost: cost
                        });
                        
                        // Update stock quantity
                        const stockIndex = app.stockItems.findIndex(si => si.code === itemCode);
                        if (stockIndex !== -1) {
                            app.stockItems[stockIndex].quantity += quantity;
                        }
                    }
                }
            });
            
            if (items.length === 0) {
                showNotification('Please add at least one valid item', 'error');
                return;
            }
            
            // Create receiving record
            const receivingRecord = {
                id: generateId(),
                date,
                supplier,
                invoiceNumber,
                items,
                totalCost,
                receivedBy,
                notes,
                createdAt: new Date().toISOString()
            };
            
            // Add to app state
            app.stockReceivingRecords.push(receivingRecord);
            
            // Save data
            saveStockReceivingData();
            saveStockItems();
            
            // Show notification
            showNotification('Stock received and inventory updated successfully', 'success');
            
            // Reset form
            document.getElementById('stockReceivingForm').reset();
            elements.receivingDate.value = getCurrentDateStr();
            elements.receivedBy.value = app.user.name;
            resetReceivingItems();
            
            // Reload records
            loadReceivingRecords();
        }
        
        function loadReceivingRecords() {
            const tbody = document.getElementById('receivingTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Get filter value
            const filter = elements.receivingFilter.value;
            
            // Filter records based on selection
            let filteredRecords = [...app.stockReceivingRecords];
            
            if (filter !== 'all') {
                const today = new Date();
                
                switch (filter) {
                    case 'today':
                        const todayStr = formatDate(today);
                        filteredRecords = filteredRecords.filter(record => record.date === todayStr);
                        break;
                    case 'week':
                        const weekStart = new Date(today);
                        weekStart.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1));
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        
                        filteredRecords = filteredRecords.filter(record => {
                            const recordDate = new Date(record.date);
                            return recordDate >= weekStart && recordDate <= weekEnd;
                        });
                        break;
                    case 'month':
                        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                        const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                        
                        filteredRecords = filteredRecords.filter(record => {
                            const recordDate = new Date(record.date);
                            return recordDate >= monthStart && recordDate <= monthEnd;
                        });
                        break;
                }
            }
            
            // Sort records by date (newest first)
            filteredRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (filteredRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-schedule">No receiving records found</td></tr>';
                return;
            }
            
            // Display records
            filteredRecords.forEach(record => {
                const tr = document.createElement('tr');
                
                // Format items display
                const itemsDisplay = record.items.map(item => 
                    `${item.name} (x${item.quantity})`
                ).join(', ');
                
                tr.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.invoiceNumber || '-'}</td>
                    <td>${record.supplier}</td>
                    <td>${itemsDisplay}</td>
                    <td>RM${record.totalCost.toFixed(2)}</td>
                    <td>${record.receivedBy}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewReceivingRecord('${record.id}')">View</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteReceivingRecord('${record.id}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function viewReceivingRecord(id) {
            // Find record
            const record = app.stockReceivingRecords.find(r => r.id === id);
            if (!record) return;
            
            // This would open a modal with record details in a real app
            alert(`Viewing record #${record.invoiceNumber || 'N/A'} from ${record.supplier}`);
        }
        
        function deleteReceivingRecord(id) {
            if (confirm('Are you sure you want to delete this receiving record? This will NOT revert the stock quantities.')) {
                // Find and remove record
                const recordIndex = app.stockReceivingRecords.findIndex(r => r.id === id);
                if (recordIndex === -1) return;
                
                app.stockReceivingRecords.splice(recordIndex, 1);
                saveStockReceivingData();
                
                // Reload records
                loadReceivingRecords();
                
                // Show notification
                showNotification('Receiving record deleted successfully', 'success');
            }
        }
        
        // Utility Functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Hide loading overlay
            setTimeout(() => {
                elements.loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    elements.loadingOverlay.style.display = 'none';
                }, 500);
            }, 1000);
            
            // Initialize app
            initApp();
        });
    </script>
</body>
</html>
