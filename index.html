<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PNE ARENA PORTAL</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* All existing styles remain the same */
    :root {
      /* Black & White Soft Theme */
      --primary: #2563eb; /* Blue for Edit button */
      --primary-dark: #1d4ed8;
      --secondary: #64748b;
      --success: #10b981; /* Green for View button */
      --danger: #ef4444; /* Red for Delete button */
      --warning: #f59e0b;
      --info: #3b82f6;
      --light: #f8fafc;
      --dark: #1e293b;
      --white: #ffffff;
      --grey-50: #f9fafb;
      --grey-100: #f3f4f6;
      --grey-200: #e5e7eb;
      --grey-300: #d1d5db;
      --grey-400: #9ca3af;
      --grey-500: #6b7280;
      --grey-600: #4b5563;
      --grey-700: #374151;
      --grey-800: #1f2937;
      --grey-900: #111827;
      
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius: 0.5rem;
      --transition: all 0.2s ease;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      color: var(--grey-800);
      min-height: 100vh;
      line-height: 1.6;
      transition: var(--transition);
      font-size: 14px;
    }
    
    /* All existing styles remain the same */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: var(--white);
      min-height: 100vh;
      box-shadow: var(--shadow-md);
      overflow: hidden;
    }
    
    header {
      background: var(--white);
      color: var(--grey-800);
      padding: 1.5rem 2rem;
      border-bottom: 1px solid var(--grey-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--primary);
      letter-spacing: -0.5px;
    }
    
    header p {
      color: var(--grey-500);
      font-size: 0.95rem;
      margin-top: 0.25rem;
    }
    
    .header-left {
      display: flex;
      flex-direction: column;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    /* Notification Toggle */
    .notification-toggle {
      position: relative;
    }
    
    .notification-toggle button {
      background: var(--grey-100);
      border: 1px solid var(--grey-200);
      color: var(--grey-600);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      transition: var(--transition);
    }
    
    .notification-toggle button:hover {
      background: var(--grey-200);
    }
    
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
    }
    
    /* Pages */
    .page {
      display: none;
      padding: 0;
      animation: fadeIn 0.3s ease-in-out;
      background: var(--white);
      color: var(--grey-800);
    }
    
    .page.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Navigation */
    nav {
      background: var(--white);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--grey-200);
    }
    
    .nav-links {
      display: flex;
      gap: 0.5rem;
    }
    
    nav a {
      color: var(--grey-600);
      text-decoration: none;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }
    
    nav a:hover {
      background: var(--grey-100);
      color: var(--primary);
    }
    
    .user-info {
      font-weight: 500;
      color: var(--grey-700);
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .user-role {
      background: var(--primary);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 24px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    /* Mobile Navigation */
    .mobile-nav-toggle {
      display: none;
      background: none;
      border: none;
      color: var(--grey-600);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0.5rem;
    }
    
    /* Cards */
    .card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      transition: var(--transition);
      border: 1px solid var(--grey-200);
    }
    
    .card h2 {
      color: var(--grey-800);
      margin-bottom: 1.25rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--grey-200);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.25rem;
      font-weight: 600;
    }
    
    .card h3 {
      color: var(--grey-800);
      margin-bottom: 1rem;
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    /* Dashboard Stats */
    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      padding: 1.5rem;
      text-align: center;
      transition: all 0.3s ease;
      border: 1px solid var(--grey-200);
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: var(--primary);
    }
    
    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
    }
    
    .stat-card h3 {
      font-size: 1.75rem;
      margin-bottom: 0.5rem;
      color: var(--grey-800);
      font-weight: 700;
    }
    
    .stat-card p {
      color: var(--grey-600);
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }
    
    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .quick-action-btn {
      background: var(--grey-50);
      border: 1px solid var(--grey-200);
      border-radius: var(--radius);
      padding: 1.25rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
      position: relative;
    }
    
    .quick-action-btn:hover {
      background: var(--grey-100);
      transform: translateY(-3px);
      box-shadow: var(--shadow);
      border-color: var(--primary);
    }
    
    .quick-action-btn i {
      font-size: 1.75rem;
      color: var(--primary);
    }
    
    .quick-action-btn h3 {
      margin: 0;
      font-size: 0.95rem;
      color: var(--grey-700);
      font-weight: 500;
    }
    
    /* Performance Metrics */
    .performance-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .metric-card {
      background: var(--grey-50);
      border-radius: var(--radius);
      padding: 1.25rem;
      border: 1px solid var(--grey-200);
      transition: all 0.3s ease;
    }
    
    .metric-card:hover {
      box-shadow: var(--shadow);
    }
    
    .metric-card h3 {
      font-size: 1rem;
      margin-bottom: 1rem;
      color: var(--grey-800);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
    }
    
    .progress-bar {
      height: 8px;
      background: var(--grey-200);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 4px;
      transition: width 1s ease;
    }
    
    .metric-value {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: var(--grey-600);
    }
    
    /* System Health */
    .system-health {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .health-indicator {
      background: var(--grey-50);
      border-radius: var(--radius);
      padding: 1.25rem;
      border: 1px solid var(--grey-200);
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .health-indicator:hover {
      box-shadow: var(--shadow);
    }
    
    .health-indicator i {
      font-size: 1.75rem;
      margin-bottom: 0.75rem;
    }
    
    .health-good {
      color: var(--success);
    }
    
    .health-warning {
      color: var(--warning);
    }
    
    .health-danger {
      color: var(--danger);
    }
    
    .health-indicator h3 {
      font-size: 1.25rem;
      margin-bottom: 0.25rem;
      color: var(--grey-800);
      font-weight: 600;
    }
    
    .health-indicator p {
      color: var(--grey-600);
      font-size: 0.85rem;
    }
    
    /* User Activity Chart */
    .user-activity-chart {
      height: 250px;
      background: var(--grey-50);
      border-radius: var(--radius);
      padding: 1.25rem;
      margin-top: 1rem;
      border: 1px solid var(--grey-200);
      position: relative;
    }
    
    .chart-container {
      height: 200px;
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      padding-top: 1rem;
    }
    
    .chart-bar {
      width: 40px;
      background: var(--primary);
      border-radius: 4px 4px 0 0;
      transition: height 1s ease;
      position: relative;
    }
    
    .chart-bar:hover {
      opacity: 0.8;
    }
    
    .chart-label {
      position: absolute;
      bottom: -25px;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 0.75rem;
      color: var(--grey-600);
    }
    
    .chart-value {
      position: absolute;
      top: -25px;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--grey-800);
    }
    
    /* System Tools */
    .system-tools {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .tool-btn {
      background: var(--grey-50);
      border: 1px solid var(--grey-200);
      border-radius: var(--radius);
      padding: 1.25rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
    }
    
    .tool-btn:hover {
      background: var(--grey-100);
      transform: translateY(-3px);
      box-shadow: var(--shadow);
      border-color: var(--primary);
    }
    
    .tool-btn i {
      font-size: 1.5rem;
      color: var(--primary);
    }
    
    .tool-btn h3 {
      margin: 0;
      font-size: 0.9rem;
      color: var(--grey-700);
      font-weight: 500;
    }
    
    /* Activity Feeds */
    .recent-activity {
      max-height: 300px;
      overflow-y: auto;
      background: var(--grey-50);
      border-radius: var(--radius);
      padding: 1.25rem;
      margin-top: 1rem;
      border: 1px solid var(--grey-200);
    }
    
    .activity-item {
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--grey-200);
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .activity-item:last-child {
      border-bottom: none;
    }
    
    .activity-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .activity-icon.create {
      background: rgba(40, 167, 69, 0.1);
      color: var(--success);
    }
    
    .activity-icon.edit {
      background: rgba(37, 99, 235, 0.1);
      color: var(--primary);
    }
    
    .activity-icon.delete {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }
    
    .activity-icon.login {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }
    
    .activity-content {
      flex: 1;
    }
    
    .activity-title {
      font-weight: 500;
      color: var(--grey-800);
      margin-bottom: 0.2rem;
    }
    
    .activity-time {
      font-size: 0.75rem;
      color: var(--grey-500);
    }
    
    /* Forms */
    form {
      background: var(--grey-50);
      padding: 1.5rem;
      border-radius: var(--radius);
      border: 1px solid var(--grey-200);
      margin-bottom: 1.5rem;
      transition: var(--transition);
    }
    
    .form-group {
      margin-bottom: 1.25rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--grey-700);
      font-size: 0.9rem;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--grey-300);
      border-radius: 6px;
      font-size: 0.95rem;
      transition: var(--transition);
      background: var(--white);
      color: var(--grey-800);
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    /* Buttons */
    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.75rem 1.25rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    button:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled {
      background: var(--grey-400);
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-secondary {
      background: var(--success);
    }
    
    .btn-secondary:hover {
      background: #16a34a;
    }
    
    .btn-danger {
      background: var(--danger);
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }
    
    .btn-warning {
      background: var(--warning);
      color: var(--grey-800);
    }
    
    .btn-warning:hover {
      background: #d97706;
    }
    
    .btn-info {
      background: var(--info);
    }
    
    .btn-info:hover {
      background: #2563eb;
    }
    
    /* Messages */
    .success-message {
      background: var(--success);
      color: white;
      padding: 1rem;
      border-radius: var(--radius);
      margin-bottom: 1.5rem;
      text-align: center;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      font-size: 0.95rem;
    }
    
    .error-message {
      background: var(--danger);
      color: white;
      padding: 1rem;
      border-radius: var(--radius);
      margin-bottom: 1.5rem;
      text-align: center;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      font-size: 0.95rem;
    }
    
    .warning-message {
      background: var(--warning);
      color: var(--grey-800);
      padding: 1rem;
      border-radius: var(--radius);
      margin-bottom: 1.5rem;
      text-align: center;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      font-size: 0.95rem;
    }
    
    .info-message {
      background: var(--info);
      color: white;
      padding: 1rem;
      border-radius: var(--radius);
      margin-bottom: 1.5rem;
      text-align: center;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      font-size: 0.95rem;
    }
    
    /* Indicators */
    .permission-denied {
      background: var(--warning);
      color: var(--grey-800);
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .draft-indicator {
      background: var(--warning);
      color: var(--grey-800);
      padding: 0.2rem 0.6rem;
      border-radius: 24px;
      font-size: 0.8rem;
      margin-left: 0.75rem;
      font-weight: 500;
    }
    
    .pending-indicator {
      background: var(--info);
      color: white;
      padding: 0.2rem 0.6rem;
      border-radius: 24px;
      font-size: 0.8rem;
      margin-left: 0.75rem;
      font-weight: 500;
    }
    
    .committed-indicator {
      background: var(--success);
      color: white;
      padding: 0.2rem 0.6rem;
      border-radius: 24px;
      font-size: 0.8rem;
      margin-left: 0.75rem;
      font-weight: 500;
    }
    
    /* Tables */
    .table-container {
      overflow-x: auto;
      margin-top: 1rem;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: var(--white);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--grey-200);
    }
    
    th, td {
      padding: 1rem 1.25rem;
      text-align: left;
      border-bottom: 1px solid var(--grey-200);
      color: var(--grey-800);
      font-size: 0.9rem;
    }
    
    th {
      background: var(--grey-50);
      font-weight: 600;
      color: var(--grey-700);
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.5px;
    }
    
    tr:hover {
      background: var(--grey-50);
    }
    
    /* Action Buttons */
    .btn-delete {
      background: var(--danger);
      color: white;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn-delete:hover {
      background: #dc2626;
    }
    
    .btn-edit {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      margin-right: 0.5rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn-edit:hover {
      background: var(--primary-dark);
    }
    
    .btn-view {
      background: var(--success);
      color: white;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn-view:hover {
      background: #16a34a;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--grey-500);
    }
    
    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 1.5rem;
      opacity: 0.5;
    }
    
    /* Filters */
    .filter-container {
      background: var(--grey-50);
      padding: 1.25rem;
      border-radius: var(--radius);
      margin-bottom: 1.25rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: flex-end;
      transition: var(--transition);
      border: 1px solid var(--grey-200);
    }
    
    .filter-group {
      flex: 1;
      min-width: 180px;
    }
    
    .filter-group label {
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--grey-700);
    }
    
    .filter-actions {
      display: flex;
      gap: 0.75rem;
    }
    
    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 1.5rem;
      gap: 0.25rem;
    }
    
    .pagination button {
      padding: 0.6rem 1rem;
      background: var(--white);
      color: var(--grey-700);
      border: 1px solid var(--grey-300);
      border-radius: 6px;
      font-size: 0.9rem;
    }
    
    .pagination button.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .pagination button:hover:not(.active) {
      background: var(--grey-100);
    }
    
    /* Items */
    .item-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto;
      gap: 1rem;
      align-items: end;
      margin-bottom: 1rem;
      padding: 1.25rem;
      background: var(--grey-50);
      border-radius: var(--radius);
      transition: var(--transition);
      border: 1px solid var(--grey-200);
    }
    
    .items-container {
      margin-bottom: 1.25rem;
    }
    
    .add-item-btn {
      background: var(--success);
      margin-bottom: 1.25rem;
    }
    
    .add-item-btn:hover {
      background: #16a34a;
    }
    
    .remove-item-btn {
      background: var(--danger);
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
    }
    
    .remove-item-btn:hover {
      background: #dc2626;
    }
    
    /* Custom Item Section */
    .custom-item-section {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--grey-100);
      border-radius: var(--radius);
      border: 1px dashed var(--grey-300);
    }
    
    .custom-item-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      font-weight: 500;
      color: var(--grey-700);
    }
    
    .custom-item-row {
      display: grid;
      grid-template-columns: 2fr 1fr auto;
      gap: 1rem;
      align-items: end;
      margin-bottom: 0.75rem;
    }
    
    /* Totals */
    .total-section {
      background: var(--grey-50);
      padding: 1.25rem;
      border-radius: var(--radius);
      margin-top: 1.25rem;
      transition: var(--transition);
      border: 1px solid var(--grey-200);
    }
    
    .total-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      color: var(--grey-800);
      font-size: 0.95rem;
    }
    
    .total-row.final {
      font-weight: 600;
      font-size: 1.1rem;
      border-top: 1px solid var(--grey-200);
      padding-top: 1rem;
      margin-top: 1rem;
    }
    
    /* Activity Log */
    .activity-log {
      max-height: 350px;
      overflow-y: auto;
      background: var(--grey-50);
      padding: 1.25rem;
      border-radius: var(--radius);
      margin-top: 1.25rem;
      border: 1px solid var(--grey-200);
    }
    
    .log-entry {
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--grey-200);
      font-size: 0.9rem;
      color: var(--grey-800);
    }
    
    .log-entry:last-child {
      border-bottom: none;
    }
    
    .log-time {
      color: var(--grey-500);
      font-size: 0.8rem;
    }
    
    /* Admin Badge */
    .admin-badge {
      background: var(--danger);
      color: white;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      font-size: 0.7rem;
      margin-left: 0.5rem;
      font-weight: 500;
    }
    
    /* Shortcuts */
    .shortcuts {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      background: var(--primary);
      color: white;
      padding: 0.6rem 1rem;
      border-radius: var(--radius);
      font-size: 0.8rem;
      opacity: 0.8;
      box-shadow: var(--shadow);
    }
    
    /* Edit Items */
    .edit-items-container {
      margin-top: 1.25rem;
      max-height: 400px;
      overflow-y: auto;
      padding: 1rem;
      background: var(--grey-100);
      border-radius: var(--radius);
    }
    
    .edit-item-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto;
      gap: 1rem;
      align-items: end;
      margin-bottom: 1rem;
      padding: 1.25rem;
      background: var(--grey-50);
      border-radius: var(--radius);
      transition: var(--transition);
      border: 1px solid var(--grey-200);
    }
    
    /* Modals */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }
    
    .modal-content {
      background: var(--white);
      padding: 1.5rem;
      border-radius: var(--radius);
      max-width: 800px;
      width: 100%;
      transition: var(--transition);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--grey-200);
      max-height: 95vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.25rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--grey-200);
    }
    
    .modal-header h3 {
      color: var(--grey-800);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.25rem;
      font-weight: 600;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: var(--grey-600);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.3s ease;
    }
    
    .close-modal:hover {
      background: var(--grey-100);
    }
    
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1.25rem;
      padding-top: 1rem;
      border-top: 1px solid var(--grey-200);
    }
    
    /* Notification Panel */
    .notification-panel {
      position: fixed;
      top: 80px;
      right: 20px;
      width: 350px;
      max-height: 400px;
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--grey-200);
      z-index: 100;
      overflow: hidden;
      transition: all 0.3s ease;
      transform: translateX(400px);
    }
    
    .notification-panel.active {
      transform: translateX(0);
    }
    
    .notification-header {
      background: var(--primary);
      color: white;
      padding: 1rem 1.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .notification-header h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 500;
    }
    
    .notification-list {
      max-height: 320px;
      overflow-y: auto;
    }
    
    .notification-item {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--grey-200);
      transition: all 0.3s ease;
    }
    
    .notification-item:hover {
      background: var(--grey-50);
    }
    
    .notification-item:last-child {
      border-bottom: none;
    }
    
    .notification-title {
      font-weight: 500;
      color: var(--grey-800);
      margin-bottom: 0.25rem;
    }
    
    .notification-message {
      font-size: 0.85rem;
      color: var(--grey-600);
    }
    
    .notification-time {
      font-size: 0.75rem;
      color: var(--grey-500);
      margin-top: 0.25rem;
    }
    
    /* Loading */
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    
    .spinner {
      border: 4px solid rgba(37, 99, 235, 0.1);
      border-radius: 50%;
      border-top: 4px solid var(--primary);
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Page Content Container */
    .page-content {
      padding: 2rem;
    }
    
    /* Cashbill List Page Styles */
    .cashbill-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .cashbill-list-header h2 {
      margin: 0;
      font-size: 1.5rem;
      color: var(--grey-800);
    }
    
    .create-cashbill-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .create-cashbill-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    
    /* Cashbill View Page Styles */
    .cashbill-view-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--grey-200);
    }
    
    .cashbill-view-title {
      font-size: 1.5rem;
      color: var(--grey-800);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .cashbill-view-actions {
      display: flex;
      gap: 0.75rem;
    }
    
    .cashbill-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .cashbill-info-card {
      background: var(--grey-50);
      border-radius: var(--radius);
      padding: 1.25rem;
      border: 1px solid var(--grey-200);
    }
    
    .cashbill-info-card h4 {
      font-size: 0.9rem;
      color: var(--grey-600);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .cashbill-info-card p {
      font-size: 1.1rem;
      color: var(--grey-800);
      margin: 0;
      font-weight: 600;
    }
    
    .cashbill-items-table {
      margin-bottom: 2rem;
    }
    
    .cashbill-summary {
      background: var(--grey-50);
      border-radius: var(--radius);
      padding: 1.5rem;
      border: 1px solid var(--grey-200);
    }
    
    .cashbill-summary h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.1rem;
      color: var(--grey-800);
    }
    
    /* Additional styles for item dropdown */
    .item-select {
      font-size: 0.9rem;
    }
    
    .min-order-note {
      font-size: 0.75rem;
      color: var(--warning);
      margin-top: 0.25rem;
    }
    
    .member-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .member-checkbox input[type="checkbox"] {
      width: auto;
      margin: 0;
    }
    
    /* Page Content Container */
    .page-content {
      padding: 2rem;
    }
    
    /* Cashbill List Page Styles */
    .cashbill-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .cashbill-list-header h2 {
      margin: 0;
      font-size: 1.5rem;
      color: var(--grey-800);
    }
    
    .create-cashbill-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .create-cashbill-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    
    /* Cashbill View Page Styles */
    .cashbill-view-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--grey-200);
    }
    
    .cashbill-view-title {
      font-size: 1.5rem;
      color: var(--grey-800);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .cashbill-view-actions {
      display: flex;
      gap: 0.75rem;
    }
    
    .cashbill-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .cashbill-info-card {
      background: var(--grey-50);
      border-radius: var(--radius);
      padding: 1.25rem;
      border: 1px solid var(--grey-200);
    }
    
    .cashbill-info-card h4 {
      font-size: 0.9rem;
      color: var(--grey-600);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .cashbill-info-card p {
      font-size: 1.1rem;
      color: var(--grey-800);
      margin: 0;
      font-weight: 600;
    }
    
    .cashbill-items-table {
      margin-bottom: 2rem;
    }
    
    .cashbill-summary {
      background: var(--grey-50);
      border-radius: var(--radius);
      padding: 1.5rem;
      border: 1px solid var(--grey-200);
    }
    
    .cashbill-summary h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.1rem;
      color: var(--grey-800);
    }
    
    /* PDF Generation Styles */
    .pdf-header {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .pdf-company-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .pdf-info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    
    .pdf-separator {
      border-top: 1px solid #000;
      margin: 15px 0;
    }
    
    .pdf-items-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    
    .pdf-items-table th, .pdf-items-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    
    .pdf-items-table th {
      background-color: #f2f2f2;
    }
    
    .pdf-total-row {
      font-weight: bold;
    }
    
    /* Responsive Styles */
    @media (max-width: 768px) {
      /* Mobile Navigation */
      .mobile-nav-toggle {
        display: block;
      }
      
      .nav-links {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background: var(--white);
        flex-direction: column;
        padding: 1rem;
        box-shadow: var(--shadow);
        z-index: 10;
      }
      
      .nav-links.active {
        display: flex;
      }
      
      nav {
        position: relative;
        flex-direction: column;
        align-items: flex-start;
      }
      
      .user-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
        margin-top: 1rem;
        width: 100%;
      }
      
      /* Header */
      header {
        padding: 1rem;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      
      header h1 {
        font-size: 1.5rem;
      }
      
      .header-right {
        margin-top: 0.5rem;
      }
      
      /* Page Content */
      .page-content {
        padding: 1rem;
      }
      
      /* Dashboard Stats */
      .dashboard-stats {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      /* Quick Actions */
      .quick-actions {
        grid-template-columns: 1fr;
      }
      
      /* Performance Metrics */
      .performance-metrics {
        grid-template-columns: 1fr;
      }
      
      /* System Health */
      .system-health {
        grid-template-columns: repeat(2, 1fr);
      }
      
      /* System Tools */
      .system-tools {
        grid-template-columns: repeat(2, 1fr);
      }
      
      /* Items */
      .item-row, .edit-item-row {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }
      
      .item-row > div, .edit-item-row > div {
        margin-bottom: 0.5rem;
      }
      
      /* Custom Item Row */
      .custom-item-row {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }
      
      /* Filters */
      .filter-container {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .filter-group {
        width: 100%;
        min-width: auto;
      }
      
      /* Tables */
      .table-container {
        overflow-x: auto;
        margin: 1rem -1rem;
        padding: 0 1rem;
      }
      
      table {
        min-width: 600px;
      }
      
      /* Pagination */
      .pagination {
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      
      .pagination button {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
      }
      
      /* Modals */
      .modal-content {
        max-width: 95%;
        padding: 1rem;
        margin: 0.5rem;
      }
      
      .modal-header {
        padding-bottom: 0.75rem;
        margin-bottom: 1rem;
      }
      
      .modal-header h3 {
        font-size: 1.1rem;
      }
      
      .modal-actions {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      /* Notification Panel */
      .notification-panel {
        width: calc(100% - 40px);
        right: 20px;
        left: 20px;
        max-height: 50vh;
      }
      
      /* Buttons */
      button {
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
      }
      
      /* Forms */
      .form-group {
        margin-bottom: 1rem;
      }
      
      /* Cashbill List Header */
      .cashbill-list-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }
      
      .create-cashbill-btn {
        width: 100%;
        justify-content: center;
      }
      
      /* Cashbill View Header */
      .cashbill-view-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }
      
      .cashbill-view-actions {
        width: 100%;
        justify-content: space-between;
      }
      
      /* Cashbill Info Grid */
      .cashbill-info-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      /* Shortcuts */
      .shortcuts {
        display: none;
      }
      
      /* Activity Item */
      .activity-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      
      .activity-icon {
        align-self: flex-start;
      }
    }
    
    @media (max-width: 480px) {
      /* Dashboard Stats */
      .stat-card h3 {
        font-size: 1.5rem;
      }
      
      /* System Health */
      .system-health {
        grid-template-columns: 1fr;
      }
      
      /* System Tools */
      .system-tools {
        grid-template-columns: 1fr;
      }
      
      /* Buttons */
      button {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
      }
      
      /* Modals */
      .modal-content {
        padding: 0.75rem;
      }
      
      .modal-header h3 {
        font-size: 1rem;
      }
      
      /* Notification Panel */
      .notification-panel {
        top: 70px;
      }
    }
    
    @media (min-width: 1200px) {
      /* Larger screens */
      .dashboard-stats {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .quick-actions {
        grid-template-columns: repeat(4, 1fr);
      }
      
      .performance-metrics {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .system-health {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .system-tools {
        grid-template-columns: repeat(6, 1fr);
      }
    }
    
    /* Login Form Enhancements */
    .login-form-container {
      max-width: 400px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .login-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .login-header h2 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: var(--primary);
    }
    
    .login-header p {
      color: var(--grey-600);
      font-size: 0.95rem;
    }
    
    .login-form {
      background: var(--white);
      border-radius: var(--radius);
      padding: 2rem;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--grey-200);
    }
    
    .login-form .form-group {
      margin-bottom: 1.25rem;
    }
    
    .login-form label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--grey-700);
    }
    
    .login-form input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--grey-300);
      border-radius: 6px;
      font-size: 0.95rem;
      transition: var(--transition);
      background: var(--white);
      color: var(--grey-800);
    }
    
    .login-form input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .login-form button {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      margin-top: 1rem;
    }
    
    .user-id-display {
      background: var(--grey-100);
      border-radius: var(--radius);
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
      text-align: center;
      font-weight: 500;
      color: var(--grey-600);
      font-size: 0.9rem;
    }
    
    .permission-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.25rem;
      margin-top: 1.25rem;
    }
    
    .permission-card {
      background: var(--grey-50);
      border-radius: var(--radius);
      padding: 1.25rem;
      border: 1px solid var(--grey-200);
    }
    
    .permission-card h4 {
      margin-bottom: 1rem;
      color: var(--grey-800);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .permission-card ul {
      list-style-type: none;
      padding-left: 0;
    }
    
    .permission-card li {
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--grey-200);
      color: var(--grey-600);
    }
    
    .permission-card li:last-child {
      border-bottom: none;
    }
    
    .permission-card li::before {
      content: "âœ“";
      color: var(--success);
      font-weight: bold;
      margin-right: 0.5rem;
    }
    
    .cashbill-details {
      background: var(--grey-50);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-top: 1.25rem;
      border: 1px solid var(--grey-200);
    }
    
    .cashbill-details h3 {
      margin-bottom: 1.25rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--grey-200);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--grey-200);
    }
    
    .detail-row:last-child {
      border-bottom: none;
    }
    
    /* Device Detection Styles */
    .mobile-device .desktop-only {
      display: none !important;
    }
    
    .desktop-device .mobile-only {
      display: none !important;
    }
    
    /* Touch-friendly styles for mobile */
    .mobile-device button, 
    .mobile-device .btn-edit, 
    .mobile-device .btn-delete, 
    .mobile-device .btn-view,
    .mobile-device .quick-action-btn, 
    .mobile-device .tool-btn {
      min-height: 44px; /* Minimum touch target size */
      min-width: 44px;
    }
    
    .mobile-device .nav-links a {
      padding: 0.75rem 1rem;
    }
    
    .mobile-device .stat-card, 
    .mobile-device .metric-card, 
    .mobile-device .health-indicator, 
    .mobile-device .tool-btn {
      padding: 1.25rem;
    }
    
    .mobile-device .card {
      margin-bottom: 1rem;
    }
    
    .mobile-device .form-group {
      margin-bottom: 1rem;
    }
    
    .mobile-device input, 
    .mobile-device select, 
    .mobile-device textarea {
      padding: 0.875rem;
      font-size: 1rem;
    }
    
    .mobile-device .modal-content {
      padding: 1.25rem;
    }
    
    .mobile-device .modal-header {
      padding-bottom: 0.75rem;
      margin-bottom: 1rem;
    }
    
    .mobile-device .modal-header h3 {
      font-size: 1.1rem;
    }
    
    .mobile-device .modal-actions {
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .mobile-device .modal-actions button {
      width: 100%;
      justify-content: center;
    }
    
    /* Desktop-specific enhancements */
    .desktop-device .nav-links {
      flex-wrap: nowrap;
    }
    
    .desktop-device .user-info {
      white-space: nowrap;
    }
    
    .desktop-device .dashboard-stats {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    
    .desktop-device .quick-actions {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
    
    .desktop-device .performance-metrics {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }
    
    .desktop-device .system-health {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
    
    .desktop-device .system-tools {
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }
    
    .desktop-device .cashbill-info-grid {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }
    
    .desktop-device .admin-feature-grid {
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    }
    
    .desktop-device .security-settings-grid {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }
    
    .desktop-device .system-info-grid {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    
    .desktop-device .user-activity-summary {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    
    .desktop-device .analytics-summary {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    
    /* Focus styles for keyboard navigation */
    button:focus, 
    input:focus, 
    select:focus, 
    textarea:focus, 
    a:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
    
    /* Skip to content link for accessibility */
    .skip-to-content {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--primary);
      color: white;
      padding: 8px;
      text-decoration: none;
      border-radius: 0 0 4px 0;
      z-index: 100;
    }
    
    .skip-to-content:focus {
      top: 0;
    }
    
    /* Enhanced Admin Panel Styles */
    .admin-feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }
    
    .feature-card {
      background: var(--grey-50);
      border-radius: var(--radius);
      padding: 1.5rem;
      border: 1px solid var(--grey-200);
      transition: var(--transition);
    }
    
    .feature-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-3px);
    }
    
    .feature-card h4 {
      margin-top: 0;
      margin-bottom: 1rem;
      color: var(--grey-800);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .feature-card p {
      color: var(--grey-600);
      margin-bottom: 1.25rem;
    }
    
    .feature-stats {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.25rem;
    }
    
    .feature-stat {
      flex: 1;
      text-align: center;
      padding: 1rem;
      background: var(--white);
      border-radius: var(--radius);
      border: 1px solid var(--grey-200);
    }
    
    .feature-stat-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 0.25rem;
    }
    
    .feature-stat-label {
      font-size: 0.85rem;
      color: var(--grey-600);
    }
    
    .user-management-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    
    .security-settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }
    
    .security-setting {
      background: var(--white);
      border-radius: var(--radius);
      padding: 1.25rem;
      border: 1px solid var(--grey-200);
    }
    
    .security-setting h5 {
      margin-top: 0;
      margin-bottom: 0.75rem;
      color: var(--grey-800);
    }
    
    .system-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
    }
    
    .info-item {
      background: var(--white);
      border-radius: var(--radius);
      padding: 1.25rem;
      border: 1px solid var(--grey-200);
      text-align: center;
    }
    
    .info-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }
    
    .info-label {
      font-size: 0.85rem;
      color: var(--grey-600);
    }
    
    .audit-log-controls {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 1.25rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .audit-log-filters {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .permission-management-grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 1.5rem;
    }
    
    .permission-role-selector {
      background: var(--grey-50);
      border-radius: var(--radius);
      padding: 1.25rem;
      border: 1px solid var(--grey-200);
    }
    
    .permission-role-item {
      padding: 0.75rem;
      border-radius: var(--radius);
      margin-bottom: 0.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: var(--transition);
    }
    
    .permission-role-item:hover {
      background: var(--grey-100);
    }
    
    .permission-role-item.active {
      background: var(--primary);
      color: white;
    }
    
    .permission-details {
      background: var(--grey-50);
      border-radius: var(--radius);
      padding: 1.25rem;
      border: 1px solid var(--grey-200);
    }
    
    .permission-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    
    .user-activity-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .activity-summary-card {
      background: var(--white);
      border-radius: var(--radius);
      padding: 1.25rem;
      border: 1px solid var(--grey-200);
      text-align: center;
    }
    
    .activity-summary-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }
    
    .activity-summary-label {
      font-size: 0.85rem;
      color: var(--grey-600);
    }
    
    .user-activity-timeline {
      margin-top: 1.25rem;
    }
    
    .timeline-item {
      position: relative;
      padding-left: 1.5rem;
      padding-bottom: 1rem;
      border-left: 2px solid var(--grey-200);
    }
    
    .timeline-item:last-child {
      border-left: 2px solid transparent;
    }
    
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -6px;
      top: 0;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--primary);
    }
    
    .timeline-content {
      background: var(--white);
      border-radius: var(--radius);
      padding: 1rem;
      border: 1px solid var(--grey-200);
    }
    
    .timeline-action {
      font-weight: 500;
      color: var(--grey-800);
      margin-bottom: 0.25rem;
    }
    
    .timeline-details {
      color: var(--grey-600);
      margin-bottom: 0.5rem;
    }
    
    .timeline-time {
      font-size: 0.75rem;
      color: var(--grey-500);
    }
    
    .system-settings-section {
      margin-bottom: 1.5rem;
    }
    
    .settings-group {
      margin-bottom: 1.5rem;
    }
    
    .settings-group h4 {
      margin-top: 0;
      margin-bottom: 1rem;
      color: var(--grey-800);
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--grey-200);
    }
    
    .settings-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      border-bottom: 1px solid var(--grey-200);
    }
    
    .settings-item:last-child {
      border-bottom: none;
    }
    
    .settings-label {
      display: flex;
      flex-direction: column;
    }
    
    .settings-label span {
      font-weight: 500;
      color: var(--grey-800);
      margin-bottom: 0.25rem;
    }
    
    .settings-description {
      font-size: 0.85rem;
      color: var(--grey-600);
    }
    
    .settings-control {
      flex: 1;
      max-width: 200px;
    }
    
    .backup-history {
      margin-top: 1.5rem;
    }
    
    .backup-history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: var(--white);
      border-radius: var(--radius);
      border: 1px solid var(--grey-200);
      margin-bottom: 0.75rem;
    }
    
    .backup-info {
      display: flex;
      flex-direction: column;
    }
    
    .backup-date {
      font-weight: 500;
      color: var(--grey-800);
    }
    
    .backup-size {
      font-size: 0.85rem;
      color: var(--grey-600);
    }
    
    .backup-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .analytics-controls {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .analytics-filters {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .analytics-chart-container {
      margin-bottom: 1.5rem;
      position: relative;
    }
    
    .analytics-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .analytics-summary-card {
      background: var(--white);
      border-radius: var(--radius);
      padding: 1.25rem;
      border: 1px solid var(--grey-200);
      text-align: center;
      position: relative;
    }
    
    .analytics-summary-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--grey-800);
      margin-bottom: 0.5rem;
    }
    
    .analytics-summary-label {
      font-size: 0.85rem;
      color: var(--grey-600);
    }
    
    .analytics-summary-change {
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }
    
    .analytics-summary-change.positive {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }
    
    .analytics-summary-change.negative {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }
    
    .data-export-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1.5rem;
    }
    
    .export-option {
      background: var(--grey-50);
      border: 1px solid var(--grey-200);
      border-radius: var(--radius);
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }
    
    .export-option:hover {
      background: var(--grey-100);
      transform: translateY(-3px);
      box-shadow: var(--shadow);
      border-color: var(--primary);
    }
    
    .export-option i {
      font-size: 1.5rem;
      color: var(--primary);
    }
    
    .export-option span {
      font-size: 0.85rem;
      color: var(--grey-700);
      font-weight: 500;
    }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-to-content">Skip to main content</a>
  
  <div class="container">
    <header>
      <div class="header-left">
        <h1>PNE ARENA</h1>
        <p> Billing Management </p>
      </div>
      <div class="header-right">
        <div class="notification-toggle">
          <button onclick="toggleNotifications()" aria-label="Notifications">
            <i class="fas fa-bell"></i>
            <span id="notificationCount" class="notification-badge" style="display: none;">0</span>
          </button>
        </div>
      </div>
    </header>
    
    <!-- LOGIN PAGE -->
    <div id="loginPage" class="page active">
      <div class="login-form-container">
        <div class="login-header">
          <h2>PNE ARENA</h2>
          <p> Billing Portal</p>
        </div>
        <div class="login-form">
          <form id="loginForm">
            <div class="form-group">
              <label for="userId">User ID:</label>
              <input type="text" id="userId" required placeholder="Enter your User ID" autocomplete="username">
            </div>
            <div class="form-group">
              <label for="password">Password:</label>
              <input type="password" id="password" required placeholder="Enter your password" autocomplete="current-password">
            </div>
            <button type="submit"><i class="fas fa-sign-in-alt"></i> Login</button>
          </form>
          <div id="loginError" class="error-message" style="display: none;">
            <i class="fas fa-exclamation-circle"></i> Invalid credentials. Please try again.
          </div>
        </div>
      </div>
    </div>
    
    <!-- DASHBOARD PAGE -->
    <div id="dashboardPage" class="page">
      <nav>
        <button class="mobile-nav-toggle mobile-only" id="mobileMenuToggle" aria-label="Toggle navigation menu">
          <i class="fas fa-bars"></i>
        </button>
        <div class="nav-links" id="navLinks">
          <a onclick="showPage('newCashbillPage')"><i class="fas fa-plus"></i> Create New Cashbill</a>
          <a onclick="showPage('cashbillListPage')"><i class="fas fa-list"></i> View Cashbills</a>
          <a onclick="showPage('reportsPage')"><i class="fas fa-chart-bar"></i> View Reports</a>
          <a id="adminPanelLink" onclick="showPage('adminPanelPage')" style="display: none;"><i class="fas fa-cogs"></i> Admin Panel</a>
        </div>
        <div class="user-info">
          Hi,<span id="currentUser">Admin</span> 
          <span id="currentUserRole" class="user-role">Admin</span> | 
          <a onclick="confirmLogout()" style="color: var(--danger);"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
      </nav>
      
      <div class="page-content" id="main-content">
        <!-- Crew Features -->
        <div id="crewFeatures" style="display: none;">
          <div class="card">
            <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
            <div class="quick-actions">
              <div class="quick-action-btn" onclick="showPage('newCashbillPage')">
                <i class="fas fa-plus-circle"></i>
                <h3>New Cashbill</h3>
              </div>
              <div class="quick-action-btn" onclick="showDrafts()">
                <i class="fas fa-file-alt"></i>
                <h3>My Drafts</h3>
                <span id="draftCountBadge" class="notification-badge" style="display: none;">0</span>
              </div>
              <div class="quick-action-btn" onclick="showMyCashbills()">
                <i class="fas fa-receipt"></i>
                <h3>My Cashbills</h3>
              </div>
              <div class="quick-action-btn" onclick="showPerformanceReport()">
                <i class="fas fa-chart-line"></i>
                <h3>Performance</h3>
              </div>
            </div>
          </div>
          
          <div class="card">
            <h2><i class="fas fa-chart-line"></i> My Performance</h2>
            <div class="performance-metrics">
              <div class="metric-card">
                <h3><i class="fas fa-file-invoice"></i> Cashbills Created</h3>
                <div class="progress-bar">
                  <div id="myCashbillsProgress" class="progress-fill" style="width: 0%;"></div>
                </div>
                <div class="metric-value">
                  <span id="myCashbillsCount">0</span>
                  <span id="myCashbillsTarget">Target: 10</span>
                </div>
              </div>
              <div class="metric-card">
                <h3><i class="fas fa-money-bill-wave"></i> Revenue Generated</h3>
                <div class="progress-bar">
                  <div id="myRevenueProgress" class="progress-fill" style="width: 0%;"></div>
                </div>
                <div class="metric-value">
                  <span id="myRevenueAmount">RM0.00</span>
                  <span id="myRevenueTarget">Target: RM5000</span>
                </div>
              </div>
              <div class="metric-card">
                <h3><i class="fas fa-percentage"></i> Completion Rate</h3>
                <div class="progress-bar">
                  <div id="myCompletionProgress" class="progress-fill" style="width: 0%;"></div>
                </div>
                <div class="metric-value">
                  <span id="myCompletionRate">0%</span>
                  <span>Committed vs Draft</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <h2><i class="fas fa-history"></i> Recent Activity</h2>
            <div class="recent-activity" id="myRecentActivity">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>
        </div>
        
        <!-- Admin Features -->
        <div id="adminFeatures" style="display: none;">
          <div class="card">
            <h2><i class="fas fa-heartbeat"></i> System Health</h2>
            <div class="system-health">
              <div class="health-indicator">
                <i class="fas fa-file-invoice health-good"></i>
                <h3 id="totalCashbillsCount">0</h3>
                <p>Total Cashbills</p>
              </div>
              <div class="health-indicator">
                <i class="fas fa-server health-good"></i>
                <h3>99.9%</h3>
                <p>System Uptime</p>
              </div>
              <div class="health-indicator">
                <i class="fas fa-database health-warning"></i>
                <h3>78%</h3>
                <p>Storage Used</p>
              </div>
            </div>
          </div>
          
          <div class="card">
            <h2><i class="fas fa-chart-bar"></i> User Activity</h2>
            <div class="user-activity-chart">
              <div class="chart-container" id="userActivityChart">
                <!-- Will be populated by JavaScript -->
              </div>
            </div>
          </div>
          
          <div class="card">
            <h2><i class="fas fa-tools"></i> System Tools</h2>
            <div class="system-tools">
              <div class="tool-btn" onclick="backupSystem()">
                <i class="fas fa-download"></i>
                <h3>Backup Data</h3>
              </div>
              <div class="tool-btn" onclick="showRestoreModal()">
                <i class="fas fa-upload"></i>
                <h3>Restore Data</h3>
              </div>
              <div class="tool-btn" onclick="showSystemSettings()">
                <i class="fas fa-cog"></i>
                <h3>System Settings</h3>
              </div>
              <div class="tool-btn" onclick="generateReport()">
                <i class="fas fa-file-alt"></i>
                <h3>Generate Report</h3>
              </div>
              <div class="tool-btn" onclick="showAuditLog()">
                <i class="fas fa-history"></i>
                <h3>Audit Log</h3>
              </div>
              <div class="tool-btn" onclick="showDataAnalytics()">
                <i class="fas fa-chart-pie"></i>
                <h3>Analytics</h3>
              </div>
            </div>
          </div>
          
          <div class="card">
            <h2><i class="fas fa-history"></i> System Activity</h2>
            <div class="recent-activity" id="systemRecentActivity">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>
        </div>
        
        <!-- Common Dashboard Features -->
        <div class="dashboard-stats">
          <div class="stat-card">
            <h3 id="totalCashbills">0</h3>
            <p><i class="fas fa-file-invoice"></i> Total Cashbills</p>
          </div>
          <div class="stat-card">
            <h3 id="totalRevenue">RM0.00</h3>
            <p><i class="fas fa-money-bill-wave"></i> Total Revenue</p>
          </div>
          <div class="stat-card">
            <h3 id="cashPayments">0</h3>
            <p><i class="fas fa-money-bill"></i> Cash Payments</p>
          </div>
          <div class="stat-card">
            <h3 id="cardPayments">0</h3>
            <p><i class="fas fa-credit-card"></i> Card Payments</p>
          </div>
          <div class="stat-card">
            <h3 id="qrPayments">0</h3>
            <p><i class="fas fa-qrcode"></i> QR Payments</p>
          </div>
          <div class="stat-card">
            <h3 id="onlineBankingPayments">0</h3>
            <p><i class="fas fa-university"></i> Online Banking</p>
          </div>
        </div>
        
        <div class="card">
          <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
          <p>Hi, to PNE ARENA PORTAL. Any bugs contact Danial Danish - 0001 (Admin).</p>
          <div id="dashboardMessage" class="warning-message" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i> You have <span id="draftCount">0</span> draft cashbills. <a onclick="showPage('cashbillListPage')" style="color: var(--grey-800); text-decoration: underline;">View them now</a>.
          </div>
        </div>
        
        <div class="card" id="activityLogCard" style="display: none;">
          <h2><i class="fas fa-history"></i> Recent Activity</h2>
          <div class="activity-log" id="activityLog">
            <!-- Activity log will be populated here -->
          </div>
        </div>
      </div>
    </div>
    
    <!-- CASHBILL LIST PAGE -->
    <div id="cashbillListPage" class="page">
      <nav>
        <button class="mobile-nav-toggle mobile-only" id="mobileMenuToggle2" aria-label="Toggle navigation menu">
          <i class="fas fa-bars"></i>
        </button>
        <div class="nav-links" id="navLinks2">
          <a onclick="showPage('dashboardPage')"><i class="fas fa-home"></i> Dashboard</a>
          <a onclick="showPage('newCashbillPage')"><i class="fas fa-plus"></i> Create New Cashbill</a>
          <a onclick="showPage('reportsPage')"><i class="fas fa-chart-bar"></i> View Reports</a>
          <a id="adminPanelLink2" onclick="showPage('adminPanelPage')" style="display: none;"><i class="fas fa-cogs"></i> Admin Panel</a>
        </div>
        <div class="user-info">
          Hi,<span id="currentUser2">Admin</span> 
          <span id="currentUserRole2" class="user-role">Admin</span> | 
          <a onclick="confirmLogout()" style="color: var(--danger);"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
      </nav>
      
      <div class="page-content">
        <div class="cashbill-list-header">
          <h2>Cashbills</h2>
          <button class="create-cashbill-btn" onclick="showPage('newCashbillPage')">
            <i class="fas fa-plus"></i> Create New Cashbill
          </button>
        </div>
        
        <div class="filter-container">
          <div class="filter-group">
            <label for="searchCustomer">Search Customer:</label>
            <input type="text" id="searchCustomer" placeholder="Customer name">
          </div>
          <div class="filter-group">
            <label for="filterStatus">Status:</label>
            <select id="filterStatus">
              <option value="">All</option>
              <option value="committed">Committed</option>
              <option value="pending">Pending</option>
              <option value="draft">Draft</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterPayment">Payment Method:</label>
            <select id="filterPayment">
              <option value="">All</option>
              <option value="cash">Cash</option>
              <option value="card">Card</option>
              <option value="qr">QR</option>
              <option value="online_banking">Online Banking</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="dateFrom">Date From:</label>
            <input type="date" id="dateFrom">
          </div>
          <div class="filter-group">
            <label for="dateTo">Date To:</label>
            <input type="date" id="dateTo">
          </div>
          <div class="filter-actions">
            <button onclick="applyFilters()"><i class="fas fa-filter"></i> Apply Filters</button>
            <button type="button" class="btn-secondary" onclick="resetFilters()"><i class="fas fa-redo"></i> Reset</button>
            <button type="button" class="btn-secondary" onclick="exportToCSV()"><i class="fas fa-file-csv"></i> Export CSV</button>
          </div>
        </div>
        
        <div id="cashbillListContent">
          <!-- Cashbill list will be populated here -->
        </div>
        
        <div id="pagination" class="pagination">
          <!-- Pagination will be populated here -->
        </div>
      </div>
    </div>
    
    <!-- CASHBILL VIEW PAGE -->
    <div id="cashbillViewPage" class="page">
      <nav>
        <button class="mobile-nav-toggle mobile-only" id="mobileMenuToggle3" aria-label="Toggle navigation menu">
          <i class="fas fa-bars"></i>
        </button>
        <div class="nav-links" id="navLinks3">
          <a onclick="showPage('dashboardPage')"><i class="fas fa-home"></i> Dashboard</a>
          <a onclick="showPage('cashbillListPage')"><i class="fas fa-list"></i> Back to List</a>
          <a onclick="showPage('newCashbillPage')"><i class="fas fa-plus"></i> Create New Cashbill</a>
          <a onclick="showPage('reportsPage')"><i class="fas fa-chart-bar"></i> View Reports</a>
          <a id="adminPanelLink3" onclick="showPage('adminPanelPage')" style="display: none;"><i class="fas fa-cogs"></i> Admin Panel</a>
        </div>
        <div class="user-info">
          Hi,<span id="currentUser3">Admin</span> 
          <span id="currentUserRole3" class="user-role">Admin</span> | 
          <a onclick="confirmLogout()" style="color: var(--danger);"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
      </nav>
      
      <div class="page-content">
        <div class="cashbill-view-header">
          <h2 class="cashbill-view-title">
            <i class="fas fa-file-invoice"></i> Cashbill Details
          </h2>
          <div class="cashbill-view-actions">
            <button class="btn-secondary" onclick="generateCashbillPDF()"><i class="fas fa-file-pdf"></i> Generate PDF</button>
            <button onclick="editCashbillFromView()"><i class="fas fa-edit"></i> Edit</button>
          </div>
        </div>
        
        <div class="cashbill-info-grid">
          <div class="cashbill-info-card">
            <h4>Invoice Number</h4>
            <p id="viewInvoiceNumber">#INV0001</p>
          </div>
          <div class="cashbill-info-card">
            <h4>Customer Name</h4>
            <p id="viewCustomerName">Customer Name</p>
          </div>
          <div class="cashbill-info-card">
            <h4>Date</h4>
            <p id="viewDate">Jan 1, 2023</p>
          </div>
          <div class="cashbill-info-card">
            <h4>Status</h4>
            <p id="viewStatus">Committed</p>
          </div>
          <div class="cashbill-info-card">
            <h4>Payment Method</h4>
            <p id="viewPaymentMethod">Cash</p>
          </div>
          <div class="cashbill-info-card">
            <h4>Created By</h4>
            <p id="viewCreatedBy">Admin</p>
          </div>
        </div>
        
        <div class="card">
          <h3>Items</h3>
          <div class="table-container">
            <table class="cashbill-items-table">
              <thead>
                <tr>
                  <th>Description</th>
                  <th>Quantity</th>
                  <th>Unit Price</th>
                  <th>Tax</th>
                  <th>Discount</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody id="viewItemsTableBody">
                <!-- Items will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="cashbill-summary">
          <h3>Summary</h3>
          <div class="total-row">
            <span>Subtotal:</span>
            <span id="viewSubtotal">RM0.00</span>
          </div>
          <div class="total-row">
            <span>Tax:</span>
            <span id="viewTotalTax">RM0.00</span>
          </div>
          <div class="total-row">
            <span>Discount:</span>
            <span id="viewTotalDiscount">RM0.00</span>
          </div>
          <div class="total-row final">
            <span>Total Amount:</span>
            <span id="viewGrandTotal">RM0.00</span>
          </div>
        </div>
        
        <div class="card" id="viewNotesCard" style="display: none;">
          <h3>Notes</h3>
          <p id="viewNotes">No notes available</p>
        </div>
      </div>
    </div>
    
    <!-- NEW CASHBILL PAGE -->
    <div id="newCashbillPage" class="page">
      <nav>
        <button class="mobile-nav-toggle mobile-only" id="mobileMenuToggle4" aria-label="Toggle navigation menu">
          <i class="fas fa-bars"></i>
        </button>
        <div class="nav-links" id="navLinks4">
          <a onclick="showPage('dashboardPage')"><i class="fas fa-home"></i> Dashboard</a>
          <a onclick="showPage('cashbillListPage')"><i class="fas fa-list"></i> View Cashbills</a>
          <a onclick="showPage('reportsPage')"><i class="fas fa-chart-bar"></i> View Reports</a>
          <a id="adminPanelLink4" onclick="showPage('adminPanelPage')" style="display: none;"><i class="fas fa-cogs"></i> Admin Panel</a>
        </div>
        <div class="user-info">
          Hi,<span id="currentUser4">Admin</span> 
          <span id="currentUserRole4" class="user-role">Admin</span> | 
          <a onclick="confirmLogout()" style="color: var(--danger);"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
      </nav>
      
      <div class="page-content">
        <div class="card">
          <h2><i class="fas fa-file-invoice"></i> Create New Cashbill</h2>
          <form id="cashbillForm">
            <div class="form-group">
              <label for="customerName">Customer Name:</label>
              <input type="text" id="customerName" required placeholder="Enter customer name">
            </div>
            
            <div class="member-checkbox">
              <input type="checkbox" id="isMember">
              <label for="isMember">Is Member?</label>
            </div>
            
            <div class="items-container">
              <h3>Items</h3>
              <div id="itemsContainer">
                <div class="item-row">
                  <div class="form-group">
                    <label>Item</label>
                    <select class="item-select" required>
                      <option value="">Select an item</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" class="item-quantity" min="1" value="1" required>
                    <div class="min-order-note" style="display: none; font-size: 0.8rem; color: var(--warning);">Minimum order: <span class="min-order-value"></span> sets</div>
                  </div>
                  <div class="form-group">
                    <label>Unit Price (RM)</label>
                    <input type="number" class="item-price" step="0.01" min="0" required placeholder="0.00">
                  </div>
                  <div class="form-group">
                    <label>Tax (%)</label>
                    <input type="number" class="item-tax" step="0.01" min="0" value="0" placeholder="0">
                  </div>
                  <div class="form-group">
                    <label>Discount (RM)</label>
                    <input type="number" class="item-discount" step="0.01" min="0" value="0" placeholder="0">
                  </div>
                  <div>
                    <button type="button" class="remove-item-btn" onclick="removeItem(this)"><i class="fas fa-trash"></i> Remove</button>
                  </div>
                </div>
              </div>
              <button type="button" class="add-item-btn" onclick="addItem()"><i class="fas fa-plus"></i> Add Item</button>
              
              <!-- Custom Item Section -->
              <div class="custom-item-section">
                <div class="custom-item-header">
                  <i class="fas fa-plus-circle"></i>
                  <span>Add Custom Item</span>
                </div>
                <div class="custom-item-row">
                  <div class="form-group">
                    <label>Item Name</label>
                    <input type="text" id="customItemName" placeholder="Enter item name">
                  </div>
                  <div class="form-group">
                    <label>Price (RM)</label>
                    <input type="number" id="customItemPrice" step="0.01" min="0" placeholder="0.00">
                  </div>
                  <div>
                    <button type="button" class="btn-secondary" onclick="addCustomItem()"><i class="fas fa-plus"></i> Add</button>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="total-section">
              <div class="total-row">
                <span>Subtotal:</span>
                <span id="subtotal">RM0.00</span>
              </div>
              <div class="total-row">
                <span>Tax:</span>
                <span id="totalTax">RM0.00</span>
              </div>
              <div class="total-row">
                <span>Discount:</span>
                <span id="totalDiscount">RM0.00</span>
              </div>
              <div class="total-row final">
                <span>Total:</span>
                <span id="grandTotal">RM0.00</span>
              </div>
            </div>
            
            <div class="form-group">
              <label for="paymentMethod">Payment Method:</label>
              <select id="paymentMethod" required>
                <option value="">Select payment method</option>
                <option value="cash">Cash</option>
                <option value="card">Card</option>
                <option value="qr">QR</option>
                <option value="online_banking">Online Banking</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="status">Status:</label>
              <select id="status" required>
                <option value="committed">Committed</option>
                <option value="pending">Pending</option>
                <option value="draft">Draft</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="notes">Notes (Optional):</label>
              <textarea id="notes" rows="3" placeholder="Additional notes..."></textarea>
            </div>
            
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
              <button type="submit"><i class="fas fa-file-invoice"></i> Generate Cashbill</button>
              <button type="button" class="btn-secondary" onclick="saveDraft()"><i class="fas fa-save"></i> Save Draft</button>
              <button type="button" onclick="resetForm()"><i class="fas fa-redo"></i> Reset</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <!-- SUCCESS PAGE -->
    <div id="successPage" class="page">
      <nav>
        <button class="mobile-nav-toggle mobile-only" id="mobileMenuToggle5" aria-label="Toggle navigation menu">
          <i class="fas fa-bars"></i>
        </button>
        <div class="nav-links" id="navLinks5">
          <a onclick="showPage('newCashbillPage')"><i class="fas fa-plus"></i> Create Another</a>
          <a onclick="showPage('dashboardPage')"><i class="fas fa-home"></i> Dashboard</a>
          <a onclick="showPage('cashbillListPage')"><i class="fas fa-list"></i> View Cashbills</a>
          <a onclick="showPage('reportsPage')"><i class="fas fa-chart-bar"></i> View Reports</a>
          <a id="adminPanelLink5" onclick="showPage('adminPanelPage')" style="display: none;"><i class="fas fa-cogs"></i> Admin Panel</a>
        </div>
        <div class="user-info">
          Hi,<span id="currentUser5">Admin</span> 
          <span id="currentUserRole5" class="user-role">Admin</span> | 
          <a onclick="confirmLogout()" style="color: var(--danger);"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
      </nav>
      
      <div class="page-content">
        <div class="success-message">
          <i class="fas fa-check-circle"></i> Cashbill Created Successfully!
        </div>
        
        <div class="cashbill-details" id="cashbillDetails">
          <!-- Cashbill details will be populated here -->
        </div>
        
        <div style="text-align: center; margin-top: 2rem;">
          <button onclick="showPage('newCashbillPage')"><i class="fas fa-file-invoice"></i> Create Another Cashbill</button>
          <button class="btn-secondary" onclick="generateCashbillPDF()"><i class="fas fa-file-pdf"></i> Generate PDF</button>
          <button class="btn-secondary" onclick="showPage('cashbillListPage')"><i class="fas fa-list"></i> View All Cashbills</button>
        </div>
      </div>
    </div>
    
    <!-- REPORTS PAGE -->
    <div id="reportsPage" class="page">
      <nav>
        <button class="mobile-nav-toggle mobile-only" id="mobileMenuToggle6" aria-label="Toggle navigation menu">
          <i class="fas fa-bars"></i>
        </button>
        <div class="nav-links" id="navLinks6">
          <a onclick="showPage('dashboardPage')"><i class="fas fa-home"></i> Dashboard</a>
          <a onclick="showPage('cashbillListPage')"><i class="fas fa-list"></i> View Cashbills</a>
          <a onclick="showPage('newCashbillPage')"><i class="fas fa-plus"></i> Create New Cashbill</a>
          <a id="adminPanelLink6" onclick="showPage('adminPanelPage')" style="display: none;"><i class="fas fa-cogs"></i> Admin Panel</a>
        </div>
        <div class="user-info">
          Hi,<span id="currentUser6">Admin</span> 
          <span id="currentUserRole6" class="user-role">Admin</span> | 
          <a onclick="confirmLogout()" style="color: var(--danger);"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
      </nav>
      
      <div class="page-content">
        <div class="card">
          <h2><i class="fas fa-chart-bar"></i> Cashbill Reports</h2>
          
          <div class="filter-container">
            <div class="filter-group">
              <label for="reportSearchCustomer">Search Customer:</label>
              <input type="text" id="reportSearchCustomer" placeholder="Customer name">
            </div>
            <div class="filter-group">
              <label for="reportFilterStatus">Status:</label>
              <select id="reportFilterStatus">
                <option value="">All</option>
                <option value="committed">Committed</option>
                <option value="pending">Pending</option>
                <option value="draft">Draft</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="reportFilterPayment">Payment Method:</label>
              <select id="reportFilterPayment">
                <option value="">All</option>
                <option value="cash">Cash</option>
                <option value="card">Card</option>
                <option value="qr">QR</option>
                <option value="online_banking">Online Banking</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="reportDateFrom">Date From:</label>
              <input type="date" id="reportDateFrom">
            </div>
            <div class="filter-group">
              <label for="reportDateTo">Date To:</label>
              <input type="date" id="reportDateTo">
            </div>
            <div class="filter-actions">
              <button onclick="applyReportFilters()"><i class="fas fa-filter"></i> Apply Filters</button>
              <button type="button" class="btn-secondary" onclick="resetReportFilters()"><i class="fas fa-redo"></i> Reset</button>
              <button type="button" class="btn-secondary" onclick="exportReportToCSV()"><i class="fas fa-file-csv"></i> Export CSV</button>
            </div>
          </div>
          
          <div id="reportsContent">
            <!-- Reports will be populated here -->
          </div>
          
          <div id="reportPagination" class="pagination">
            <!-- Pagination will be populated here -->
          </div>
        </div>
      </div>
    </div>
    
    <!-- ADMIN PANEL PAGE -->
    <div id="adminPanelPage" class="page">
      <nav>
        <button class="mobile-nav-toggle mobile-only" id="mobileMenuToggle7" aria-label="Toggle navigation menu">
          <i class="fas fa-bars"></i>
        </button>
        <div class="nav-links" id="navLinks7">
          <a onclick="showPage('dashboardPage')"><i class="fas fa-home"></i> Dashboard</a>
          <a onclick="showPage('cashbillListPage')"><i class="fas fa-list"></i> View Cashbills</a>
          <a onclick="showPage('newCashbillPage')"><i class="fas fa-plus"></i> Create New Cashbill</a>
          <a onclick="showPage('reportsPage')"><i class="fas fa-chart-bar"></i> View Reports</a>
        </div>
        <div class="user-info">
          Hi,<span id="currentUser7">Admin</span> 
          <span id="currentUserRole7" class="user-role">Admin</span> | 
          <a onclick="confirmLogout()" style="color: var(--danger);"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
      </nav>
      
      <div class="page-content">
        <div class="card">
          <h2><i class="fas fa-cogs"></i> Admin Panel</h2>
          <p>System administration and settings.</p>
          
          <div class="admin-feature-grid">
            <div class="feature-card">
              <h4><i class="fas fa-users-cog"></i> User Management</h4>
              <p>Manage system users, roles, and permissions</p>
              <div class="feature-stats">
                <div class="feature-stat">
                  <div class="feature-stat-value" id="totalUsersCount">0</div>
                  <div class="feature-stat-label">Total Users</div>
                </div>
                <div class="feature-stat">
                  <div class="feature-stat-value" id="activeUsersCount">0</div>
                  <div class="feature-stat-label">Active Today</div>
                </div>
              </div>
              <div class="user-management-actions">
                <button onclick="showAddUserModal()"><i class="fas fa-user-plus"></i> Add User</button>
                <button onclick="showUserPermissionsModal()"><i class="fas fa-user-shield"></i> Permissions</button>
                <button onclick="showUserActivityModal()"><i class="fas fa-chart-line"></i> Activity</button>
              </div>
            </div>
            
            <div class="feature-card">
              <h4><i class="fas fa-shield-alt"></i> Security Settings</h4>
              <p>Configure system security and access controls</p>
              <div class="security-settings-grid">
                <div class="security-setting">
                  <h5>Session Control</h5>
                  <label for="sessionTimeout">Session Timeout (min):</label>
                  <input type="number" id="sessionTimeout" min="5" max="120" value="30">
                </div>
                <div class="security-setting">
                  <h5>Login Protection</h5>
                  <label for="maxLoginAttempts">Max Login Attempts:</label>
                  <input type="number" id="maxLoginAttempts" min="1" max="10" value="3">
                </div>
              </div>
              <button onclick="saveSecuritySettings()" style="margin-top: 1rem;"><i class="fas fa-save"></i> Save Settings</button>
            </div>
          </div>
          
          <div class="card" style="margin-top: 1.5rem;">
            <h2><i class="fas fa-server"></i> System Information</h2>
            <div class="system-info-grid">
              <div class="info-item">
                <div class="info-value">2.4 GB</div>
                <div class="info-label">Database Size</div>
              </div>
              <div class="info-item">
                <div class="info-value" id="activeUsersInfo">0</div>
                <div class="info-label">Active Users</div>
              </div>
              <div class="info-item">
                <div class="info-value">24/7</div>
                <div class="info-label">System Uptime</div>
              </div>
              <div class="info-item">
                <div class="info-value">78%</div>
                <div class="info-label">Storage Used</div>
              </div>
            </div>
            
            <div style="margin-top: 1.25rem;">
              <h3>System Logs</h3>
              <div class="audit-log-controls">
                <div class="audit-log-filters">
                  <div class="filter-group">
                    <label for="logType">Log Type:</label>
                    <select id="logType">
                      <option value="">All</option>
                      <option value="security">Security</option>
                      <option value="user">User</option>
                      <option value="system">System</option>
                    </select>
                  </div>
                  <div class="filter-group">
                    <label for="logDateFrom">Date From:</label>
                    <input type="date" id="logDateFrom">
                  </div>
                  <div class="filter-group">
                    <label for="logDateTo">Date To:</label>
                    <input type="date" id="logDateTo">
                  </div>
                </div>
                <button onclick="applyLogFilters()"><i class="fas fa-filter"></i> Apply</button>
              </div>
              <div class="activity-log" id="systemLogs" style="max-height: 300px;">
                <!-- Will be populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- EDIT CASHBILL MODAL -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-edit"></i> Edit Cashbill</h3>
          <button class="close-modal" onclick="closeEditModal()" aria-label="Close modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="editCashbillForm">
          <input type="hidden" id="editCashbillId">
          <div class="form-group">
            <label for="editCustomerName">Customer Name:</label>
            <input type="text" id="editCustomerName" required>
          </div>
          <div class="form-group">
            <label for="editPaymentMethod">Payment Method:</label>
            <select id="editPaymentMethod" required>
              <option value="cash">Cash</option>
              <option value="card">Card</option>
              <option value="qr">QR</option>
              <option value="online_banking">Online Banking</option>
            </select>
          </div>
          <div class="form-group">
            <label for="editStatus">Status:</label>
            <select id="editStatus" required>
              <option value="draft">Draft</option>
              <option value="pending">Pending</option>
              <option value="committed">Committed</option>
            </select>
          </div>
          
          <div class="edit-items-container">
            <h3>Items</h3>
            <div id="editItemsContainer">
              <!-- Items will be populated here -->
            </div>
            <button type="button" class="add-item-btn" onclick="addEditItem()"><i class="fas fa-plus"></i> Add Item</button>
          </div>
          
          <div class="total-section">
            <div class="total-row">
              <span>Subtotal:</span>
              <span id="editSubtotal">RM0.00</span>
            </div>
            <div class="total-row">
              <span>Tax:</span>
              <span id="editTotalTax">RM0.00</span>
            </div>
            <div class="total-row">
              <span>Discount:</span>
              <span id="editTotalDiscount">RM0.00</span>
            </div>
            <div class="total-row final">
              <span>Total:</span>
              <span id="editGrandTotal">RM0.00</span>
            </div>
          </div>
          
          <div class="form-group">
            <label for="editNotes">Notes (Optional):</label>
            <textarea id="editNotes" rows="3"></textarea>
          </div>
          
          <div class="modal-actions">
            <button type="submit"><i class="fas fa-save"></i> Save Changes</button>
            <button type="button" class="btn-secondary" onclick="closeEditModal()"><i class="fas fa-times"></i> Cancel</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- CONFIRMATION MODAL -->
    <div id="confirmModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="confirmTitle"><i class="fas fa-question-circle"></i> Confirm Action</h3>
          <button class="close-modal" onclick="closeConfirmModal()" aria-label="Close modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <p id="confirmMessage">Are you sure you want to proceed?</p>
        <div class="modal-actions">
          <button id="confirmButton" onclick="executeConfirmedAction()"><i class="fas fa-check"></i> Confirm</button>
          <button type="button" class="btn-secondary" onclick="closeConfirmModal()"><i class="fas fa-times"></i> Cancel</button>
        </div>
      </div>
    </div>
    
    <!-- NOTIFICATION PANEL -->
    <div id="notificationPanel" class="notification-panel">
      <div class="notification-header">
        <h3>Notifications</h3>
        <button onclick="toggleNotifications()" aria-label="Close notifications">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="notification-list" id="notificationList">
        <!-- Notifications will be populated here -->
      </div>
    </div>
    
    <!-- LOADING SPINNER -->
    <div id="loadingSpinner" class="loading">
      <div class="spinner"></div>
    </div>
    
    <!-- KEYBOARD SHORTCUTS -->
    <div class="shortcuts desktop-only">
      <i class="fas fa-keyboard"></i> Shortcuts: N=New, D=Dashboard, L=List, R=Reports
    </div>
    
    <!-- ADD USER MODAL -->
    <div id="addUserModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-user-plus"></i> Add New User</h3>
          <button class="close-modal" onclick="closeAddUserModal()" aria-label="Close modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="addUserForm">
          <div class="form-group">
            <label for="newUserId">User ID:</label>
            <input type="text" id="newUserId" required placeholder="Enter User ID">
          </div>
          <div class="form-group">
            <label for="newUserName">Full Name:</label>
            <input type="text" id="newUserName" required placeholder="Enter full name">
          </div>
          <div class="form-group">
            <label for="newUserRole">Role:</label>
            <select id="newUserRole" required>
              <option value="crew">Crew</option>
              <option value="marketing">Marketing Team</option>
              <option value="director">Director Head of Business</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="form-group">
            <label for="newUserPassword">Password:</label>
            <input type="password" id="newUserPassword" required placeholder="Enter password">
          </div>
          <div class="form-group">
            <label for="newUserConfirmPassword">Confirm Password:</label>
            <input type="password" id="newUserConfirmPassword" required placeholder="Confirm password">
          </div>
          <div class="modal-actions">
            <button type="submit"><i class="fas fa-save"></i> Add User</button>
            <button type="button" class="btn-secondary" onclick="closeAddUserModal()"><i class="fas fa-times"></i> Cancel</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- USER PERMISSIONS MODAL -->
    <div id="userPermissionsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-user-shield"></i> Manage User Permissions</h3>
          <button class="close-modal" onclick="closeUserPermissionsModal()" aria-label="Close modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="permission-management-grid">
          <div class="permission-role-selector">
            <h4>Select User</h4>
            <select id="permissionUser" onchange="loadUserPermissions()" style="width: 100%; margin-bottom: 1rem;">
              <option value="">Select a user</option>
            </select>
            <div id="roleList">
              <!-- Role list will be populated here -->
            </div>
          </div>
          <div class="permission-details">
            <h4>Permissions</h4>
            <div id="permissionsContainer">
              <!-- Permissions will be populated here -->
            </div>
          </div>
        </div>
        <div class="modal-actions">
          <button onclick="saveUserPermissions()"><i class="fas fa-save"></i> Save Permissions</button>
          <button type="button" class="btn-secondary" onclick="closeUserPermissionsModal()"><i class="fas fa-times"></i> Cancel</button>
        </div>
      </div>
    </div>
    
    <!-- USER ACTIVITY MODAL -->
    <div id="userActivityModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-chart-line"></i> User Activity Report</h3>
          <button class="close-modal" onclick="closeUserActivityModal()" aria-label="Close modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="form-group">
          <label for="activityUser">Select User:</label>
          <select id="activityUser" onchange="loadUserActivity()">
            <option value="">Select a user</option>
          </select>
        </div>
        <div id="userActivityContainer" style="margin-top: 1.25rem;">
          <!-- Will be populated by JavaScript -->
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" onclick="closeUserActivityModal()"><i class="fas fa-times"></i> Close</button>
        </div>
      </div>
    </div>
    
    <!-- SYSTEM SETTINGS MODAL -->
    <div id="systemSettingsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-cog"></i> System Settings</h3>
          <button class="close-modal" onclick="closeSystemSettingsModal()" aria-label="Close modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="system-settings-section">
          <div class="settings-group">
            <h4>General Settings</h4>
            <div class="settings-item">
              <div>
                <div class="settings-label">Company Name</div>
                <div class="settings-description">The name of your organization</div>
              </div>
              <div class="settings-control">
                <input type="text" id="settingsCompanyName" value="PNE ARENA">
              </div>
            </div>
            <div class="settings-item">
              <div>
                <div class="settings-label">Company Address</div>
                <div class="settings-description">Company address for PDF generation</div>
              </div>
              <div class="settings-control">
                <textarea id="settingsCompanyAddress" rows="3">58, Bandar Laguna Merbok, 08000 Sungai Petani, Kedah</textarea>
              </div>
            </div>
            <div class="settings-item">
              <div>
                <div class="settings-label">Default Currency</div>
                <div class="settings-description">Currency used for all transactions</div>
              </div>
              <div class="settings-control">
                <select id="settingsCurrency">
                  <option value="RM">Malaysian Ringgit (RM)</option>
                  <option value="USD">US Dollar ($)</option>
                  <option value="EUR">Euro (â‚¬)</option>
                </select>
              </div>
            </div>
            <div class="settings-item">
              <div>
                <div class="settings-label">Default Tax Rate (%)</div>
                <div class="settings-description">Default tax rate applied to cashbills</div>
              </div>
              <div class="settings-control">
                <input type="number" id="settingsTaxRate" step="0.01" min="0" value="0">
              </div>
            </div>
          </div>
          
          <div class="settings-group">
            <h4>Performance Targets</h4>
            <div class="settings-item">
              <div>
                <div class="settings-label">Crew Cashbill Target</div>
                <div class="settings-description">Monthly target for crew members</div>
              </div>
              <div class="settings-control">
                <input type="number" id="settingsCrewTarget" min="1" value="10">
              </div>
            </div>
            <div class="settings-item">
              <div>
                <div class="settings-label">Crew Revenue Target</div>
                <div class="settings-description">Monthly revenue target for crew members</div>
              </div>
              <div class="settings-control">
                <input type="number" id="settingsCrewRevenue" step="100" min="0" value="5000">
              </div>
            </div>
          </div>
          
          <div class="settings-group">
            <h4>Notification Settings</h4>
            <div class="settings-item">
              <div>
                <div class="settings-label">Email Notifications</div>
                <div class="settings-description">Receive email notifications for system events</div>
              </div>
              <div class="settings-control">
                <input type="checkbox" id="settingsEmailNotifications" checked>
              </div>
            </div>
            <div class="settings-item">
              <div>
                <div class="settings-label">Low Stock Alerts</div>
                <div class="settings-description">Get notified when items are low in stock</div>
              </div>
              <div class="settings-control">
                <input type="checkbox" id="settingsStockAlerts" checked>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-actions">
          <button onclick="saveSystemSettings()"><i class="fas fa-save"></i> Save Settings</button>
          <button type="button" class="btn-secondary" onclick="closeSystemSettingsModal()"><i class="fas fa-times"></i> Cancel</button>
        </div>
      </div>
    </div>
    
    <!-- RESTORE MODAL -->
    <div id="restoreModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-upload"></i> Restore System</h3>
          <button class="close-modal" onclick="closeRestoreModal()" aria-label="Close modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <p>Warning: This will overwrite all current data. Please make sure you have a backup before proceeding.</p>
        <div class="form-group">
          <label for="restoreFile">Select Backup File:</label>
          <input type="file" id="restoreFile" accept=".json">
        </div>
        <div class="backup-history">
          <h4>Recent Backups</h4>
          <div class="backup-history-item">
            <div class="backup-info">
              <div class="backup-date">2023-12-15</div>
              <div class="backup-size">2.1 MB</div>
            </div>
            <div class="backup-actions">
              <button class="btn-secondary"><i class="fas fa-download"></i> Download</button>
              <button><i class="fas fa-upload"></i> Restore</button>
            </div>
          </div>
          <div class="backup-history-item">
            <div class="backup-info">
              <div class="backup-date">2023-12-08</div>
              <div class="backup-size">1.9 MB</div>
            </div>
            <div class="backup-actions">
              <button class="btn-secondary"><i class="fas fa-download"></i> Download</button>
              <button><i class="fas fa-upload"></i> Restore</button>
            </div>
          </div>
        </div>
        <div class="modal-actions">
          <button onclick="restoreSystem()"><i class="fas fa-upload"></i> Restore</button>
          <button type="button" class="btn-secondary" onclick="closeRestoreModal()"><i class="fas fa-times"></i> Cancel</button>
        </div>
      </div>
    </div>
    
    <!-- AUDIT LOG MODAL -->
    <div id="auditLogModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-history"></i> Audit Log</h3>
          <button class="close-modal" onclick="closeAuditLogModal()" aria-label="Close modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="audit-log-controls">
          <div class="audit-log-filters">
            <div class="filter-group">
              <label for="auditUser">User:</label>
              <select id="auditUser">
                <option value="">All Users</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="auditAction">Action:</label>
              <select id="auditAction">
                <option value="">All Actions</option>
                <option value="Login">Login</option>
                <option value="Logout">Logout</option>
                <option value="Create Cashbill">Create Cashbill</option>
                <option value="Edit Cashbill">Edit Cashbill</option>
                <option value="Delete Cashbill">Delete Cashbill</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="auditDateFrom">Date From:</label>
              <input type="date" id="auditDateFrom">
            </div>
            <div class="filter-group">
              <label for="auditDateTo">Date To:</label>
              <input type="date" id="auditDateTo">
            </div>
          </div>
          <button onclick="applyAuditFilters()"><i class="fas fa-filter"></i> Apply</button>
        </div>
        <div class="activity-log" id="auditLogContent" style="max-height: 400px;">
          <!-- Audit log will be populated here -->
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" onclick="exportAuditLog()"><i class="fas fa-download"></i> Export</button>
          <button type="button" class="btn-secondary" onclick="closeAuditLogModal()"><i class="fas fa-times"></i> Close</button>
        </div>
      </div>
    </div>
    
    <!-- DATA ANALYTICS MODAL -->
    <div id="dataAnalyticsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-chart-pie"></i> Advanced Analytics</h3>
          <button class="close-modal" onclick="closeDataAnalyticsModal()" aria-label="Close modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="analytics-controls">
          <div class="analytics-filters">
            <div class="filter-group">
              <label for="analyticsPeriodModal">Period:</label>
              <select id="analyticsPeriodModal">
                <option value="7">Last 7 Days</option>
                <option value="30">Last 30 Days</option>
                <option value="90">Last 90 Days</option>
                <option value="365">Last Year</option>
                <option value="custom">Custom Range</option>
              </select>
            </div>
            <div class="filter-group" id="customDateRange" style="display: none;">
              <label>From:</label>
              <input type="date" id="analyticsDateFrom">
              <label>To:</label>
              <input type="date" id="analyticsDateTo">
            </div>
            <div class="filter-group">
              <label for="analyticsChartType">Chart Type:</label>
              <select id="analyticsChartType">
                <option value="line">Line Chart</option>
                <option value="bar">Bar Chart</option>
                <option value="pie">Pie Chart</option>
                <option value="doughnut">Doughnut Chart</option>
                <option value="radar">Radar Chart</option>
                <option value="polarArea">Polar Area</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="analyticsMetric">Metric:</label>
              <select id="analyticsMetric">
                <option value="revenue">Revenue</option>
                <option value="cashbills">Cashbills</option>
                <option value="users">User Activity</option>
                <option value="items">Items Sold</option>
                <option value="payments">Payment Methods</option>
                <option value="performance">Performance</option>
              </select>
            </div>
          </div>
          <button onclick="refreshAnalytics()"><i class="fas fa-sync"></i> Refresh</button>
        </div>
        
        <div class="analytics-chart-container" style="min-height: 400px;">
          <canvas id="analyticsChart"></canvas>
        </div>
        
        <div class="analytics-summary">
          <div class="analytics-summary-card">
            <div class="analytics-summary-value" id="summaryValue1">RM0.00</div>
            <div class="analytics-summary-label" id="summaryLabel1">Total Revenue</div>
            <div class="analytics-summary-change positive" id="summaryChange1">+0.0%</div>
          </div>
          <div class="analytics-summary-card">
            <div class="analytics-summary-value" id="summaryValue2">0</div>
            <div class="analytics-summary-label" id="summaryLabel2">Cashbills</div>
            <div class="analytics-summary-change positive" id="summaryChange2">+0.0%</div>
          </div>
          <div class="analytics-summary-card">
            <div class="analytics-summary-value" id="summaryValue3">0</div>
            <div class="analytics-summary-label" id="summaryLabel3">Active Users</div>
            <div class="analytics-summary-change negative" id="summaryChange3">-0</div>
          </div>
          <div class="analytics-summary-card">
            <div class="analytics-summary-value" id="summaryValue4">0%</div>
            <div class="analytics-summary-label" id="summaryLabel4">Completion Rate</div>
            <div class="analytics-summary-change positive" id="summaryChange4">+0.0%</div>
          </div>
        </div>
        
        <div class="data-export-options">
          <div class="export-option" onclick="exportAnalyticsPDF()">
            <i class="fas fa-file-pdf"></i>
            <span>Export as PDF</span>
          </div>
          <div class="export-option" onclick="exportAnalyticsCSV()">
            <i class="fas fa-file-csv"></i>
            <span>Export as CSV</span>
          </div>
          <div class="export-option" onclick="exportAnalyticsImage()">
            <i class="fas fa-image"></i>
            <span>Export as Image</span>
          </div>
          <div class="export-option" onclick="exportAnalyticsJSON()">
            <i class="fas fa-file-code"></i>
            <span>Export as JSON</span>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn-secondary" onclick="closeDataAnalyticsModal()"><i class="fas fa-times"></i> Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Device detection
    function isMobileDevice() {
      return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1) || 
             (window.innerWidth <= 768) || (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent));
    }
    
    // Apply device class to body
    if (isMobileDevice()) {
      document.body.classList.add('mobile-device');
    } else {
      document.body.classList.add('desktop-device');
    }
    
    // Define items list with categories and pricing
    const itemsList = [
      {
        category: "Jubah",
        items: [
          { 
            description: "Adult Jubah", 
            price: 250, 
            memberPrice: 220, 
            minOrder: null, 
            freeCap: true 
          },
          { 
            description: "Year 6 Jubah", 
            price: 170, 
            memberPrice: 150, 
            minOrder: 10, 
            freeCap: true 
          },
          { 
            description: "Kindergarten Jubah", 
            price: 110, 
            memberPrice: 99, 
            minOrder: 10, 
            freeCap: true 
          }
        ]
      },
      {
        category: "Accessories & Souvenirs",
        items: [
          { 
            description: "Pluque Arkalic (with name print)", 
            price: 19.90, 
            memberPrice: 17.50, 
            minOrder: null 
          },
          { 
            description: "Cute Medal (Arkalic material)", 
            price: 12.90, 
            memberPrice: 10.90, 
            minOrder: 10 
          },
          { 
            description: "Cute Keychain (Arkalic Sublimation)", 
            price: 5.90, 
            memberPrice: 3.90, 
            minOrder: 10 
          },
          { 
            description: "Attendance Keychain (Acrylic)", 
            price: 4.90, 
            memberPrice: 3.50, 
            minOrder: 10 
          }
        ]
      },
      {
        category: "T-Shirts (Kindergarten)",
        items: [
          { 
            description: "Kindergarten T-Shirt (Microfiber)", 
            price: 29.90, 
            memberPrice: 25.00, 
            minOrder: 20 
          },
          { 
            description: "Kindergarten T-Shirt + Pants Set (Microfiber + Tracksuit)", 
            price: 45.00, 
            memberPrice: 39.90, 
            minOrder: 20 
          }
        ]
      }
    ];
    
    // Function to populate item dropdown
    function populateItemDropdown(selectElement) {
      selectElement.innerHTML = '<option value="">Select an item</option>';
      itemsList.forEach(category => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = category.category;
        category.items.forEach(item => {
          const option = document.createElement('option');
          option.value = JSON.stringify(item);
          option.textContent = item.description;
          optgroup.appendChild(option);
        });
        selectElement.appendChild(optgroup);
      });
    }
    
    // API URL for Google Apps Script
    const API_URL = "https://script.google.com/macros/s/AKfycbyekmbibuQZeerhAHQ8Eva_0nzuO397O0-3PJUtXs5Dfq-tHC3z1vap1hfXu-BvJKb-/exec";
    
    // Initialize data storage
    let cashbills = [];
    let users = [
      { id: '0001', name: 'Danial Danish', role: 'admin', password: 'dd' },
      { id: '0002', name: 'Aidawati', role: 'director', password: 'aida' },
      { id: '0003', name: 'Putri Erinna', role: 'marketing', password: 'putri' },
      { id: '0004', name: 'Farah', role: 'marketing', password: 'farah' }
    ];
    let activityLog = [];
    let notifications = [];
    let systemSettings = {
      companyName: 'PNE ARENA',
      companyAddress: '58, Bandar Laguna Merbok, 08000 Sungai Petani, Kedah',
      currency: 'RM',
      taxRate: 0,
      cashbillTargets: { crew: 10, manager: 20, marketing: 15, admin: 0 },
      revenueTargets: { crew: 5000, manager: 15000, marketing: 10000, admin: 0 }
    };
    let currentUser = null;
    let currentPage = 1;
    const itemsPerPage = 10;
    let filteredCashbills = [];
    let confirmedAction = null;
    let currentViewingCashbill = null;
    
    // Get next invoice number
    function getNextInvoiceNumber() {
      const lastInvoice = localStorage.getItem('lastInvoiceNumber');
      let nextNumber = lastInvoice ? parseInt(lastInvoice) + 1 : 1;
      localStorage.setItem('lastInvoiceNumber', nextNumber);
      return `#INV${nextNumber.toString().padStart(4, '0')}`;
    }
    
    // Log activity
    async function logActivity(userId, username, action, details) {
      const logEntry = {
        id: Date.now(),
        userId,
        username,
        action,
        details,
        timestamp: new Date().toISOString()
      };
      
      try {
        // Add to server
        const response = await fetch(`${API_URL}?action=add&sheet=activityLog&data=${encodeURIComponent(JSON.stringify(logEntry))}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        
        if (result.success) {
          // Update local cache
          activityLog.unshift(logEntry);
          if (activityLog.length > 100) activityLog = activityLog.slice(0, 100);
          
          // Add notification for certain activities
          if (action === 'Create Cashbill' || action === 'Delete Cashbill') {
            addNotification(username, action, details);
          }
        }
      } catch (error) {
        console.error("Error logging activity:", error);
      }
    }
    
    // Add notification
    async function addNotification(username, action, details) {
      const notification = {
        id: Date.now(),
        username,
        action,
        details,
        timestamp: new Date().toISOString(),
        read: false
      };
      
      try {
        // Add to server
        const response = await fetch(`${API_URL}?action=add&sheet=notifications&data=${encodeURIComponent(JSON.stringify(notification))}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        
        if (result.success) {
          // Update local cache
          notifications.unshift(notification);
          if (notifications.length > 20) notifications = notifications.slice(0, 20);
          updateNotificationBadge();
        }
      } catch (error) {
        console.error("Error adding notification:", error);
      }
    }
    
    // Update notification badge
    function updateNotificationBadge() {
      const unreadCount = notifications.filter(n => !n.read).length;
      const badge = document.getElementById('notificationCount');
      
      if (unreadCount > 0) {
        badge.textContent = unreadCount;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }
    
    // Toggle notifications panel
    function toggleNotifications() {
      const panel = document.getElementById('notificationPanel');
      panel.classList.toggle('active');
      
      if (panel.classList.contains('active')) {
        updateNotificationList();
        
        // Mark all notifications as read
        notifications.forEach(n => n.read = true);
        updateNotificationBadge();
      }
    }
    
    // Update notification list
    function updateNotificationList() {
      const list = document.getElementById('notificationList');
      
      if (notifications.length === 0) {
        list.innerHTML = '<div class="notification-item"><div class="notification-title">No notifications</div></div>';
        return;
      }
      
      let html = '';
      notifications.forEach(notification => {
        const date = new Date(notification.timestamp);
        const formattedDate = date.toLocaleDateString();
        const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        html += `
          <div class="notification-item">
            <div class="notification-title">${notification.username} ${notification.action.toLowerCase()}</div>
            <div class="notification-message">${notification.details}</div>
            <div class="notification-time">${formattedDate} at ${formattedTime}</div>
          </div>
        `;
      });
      
      list.innerHTML = html;
    }
    
    // Page navigation
    function showPage(pageId) {
      const pages = document.querySelectorAll('.page');
      pages.forEach(p => p.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
      
      // Update dashboard stats when dashboard is shown
      if (pageId === 'dashboardPage') {
        updateDashboardStats();
        updateActivityLog();
      }
      
      // Update cashbill list when list page is shown
      if (pageId === 'cashbillListPage') {
        updateCashbillListPage();
      }
      
      // Update reports when reports page is shown
      if (pageId === 'reportsPage') {
        updateReportsPage();
      }
      
      // Update admin panel when admin panel page is shown
      if (pageId === 'adminPanelPage') {
        updateAdminPanel();
      }
      
      // Close mobile menu if open
      closeMobileMenu();
    }
    
    // Close mobile menu
    function closeMobileMenu() {
      const navLinks = document.querySelectorAll('.nav-links');
      navLinks.forEach(nav => {
        nav.classList.remove('active');
      });
    }
    
    // Mobile menu toggle
    document.addEventListener('DOMContentLoaded', function() {
      const mobileMenuToggles = document.querySelectorAll('.mobile-nav-toggle');
      
      mobileMenuToggles.forEach(toggle => {
        toggle.addEventListener('click', function() {
          const navLinks = this.closest('nav').querySelector('.nav-links');
          navLinks.classList.toggle('active');
        });
      });
    });
    
    // Login functionality
    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const userId = document.getElementById('userId').value;
      const password = document.getElementById('password').value;
      
      const user = users.find(u => u.id === userId && u.password === password);
      
      if (user) {
        currentUser = user;
        updateCurrentUserUI();
        logActivity(user.id, user.name, 'Login', 'User logged in');
        showPage('dashboardPage');
        document.getElementById('loginError').style.display = 'none';
      } else {
        document.getElementById('loginError').style.display = 'block';
      }
    });
    
    // Update current user UI
    function updateCurrentUserUI() {
      if (!currentUser) return;
      
      // Update username in all pages
      document.getElementById('currentUser').textContent = currentUser.name;
      document.getElementById('currentUser2').textContent = currentUser.name;
      document.getElementById('currentUser3').textContent = currentUser.name;
      document.getElementById('currentUser4').textContent = currentUser.name;
      document.getElementById('currentUser5').textContent = currentUser.name;
      document.getElementById('currentUser6').textContent = currentUser.name;
      document.getElementById('currentUser7').textContent = currentUser.name;
      
      // Update role in all pages
      document.getElementById('currentUserRole').textContent = getRoleDisplayName(currentUser.role);
      document.getElementById('currentUserRole2').textContent = getRoleDisplayName(currentUser.role);
      document.getElementById('currentUserRole3').textContent = getRoleDisplayName(currentUser.role);
      document.getElementById('currentUserRole4').textContent = getRoleDisplayName(currentUser.role);
      document.getElementById('currentUserRole5').textContent = getRoleDisplayName(currentUser.role);
      document.getElementById('currentUserRole6').textContent = getRoleDisplayName(currentUser.role);
      document.getElementById('currentUserRole7').textContent = getRoleDisplayName(currentUser.role);
      
      // Show/hide admin panel link based on role
      const adminPanelLinks = document.querySelectorAll('[id^="adminPanelLink"]');
      adminPanelLinks.forEach(link => {
        link.style.display = currentUser.role === 'admin' ? 'block' : 'none';
      });
      
      // Show/hide activity log card based on role
      document.getElementById('activityLogCard').style.display = currentUser.role === 'admin' ? 'block' : 'none';
      
      // Show/hide role-specific features
      if (currentUser.role === 'crew') {
        document.getElementById('crewFeatures').style.display = 'block';
        document.getElementById('adminFeatures').style.display = 'none';
      } else if (currentUser.role === 'admin') {
        document.getElementById('crewFeatures').style.display = 'none';
        document.getElementById('adminFeatures').style.display = 'block';
      } else {
        document.getElementById('crewFeatures').style.display = 'none';
        document.getElementById('adminFeatures').style.display = 'none';
      }
    }
    
    // Get role display name
    function getRoleDisplayName(role) {
      switch(role) {
        case 'admin': return 'Admin';
        case 'director': return 'Director Head of Business';
        case 'marketing': return 'Marketing Team';
        case 'crew': return 'Crew';
        default: return 'Crew';
      }
    }
    
    // Get payment method display name
    function getPaymentMethodDisplayName(method) {
      switch(method) {
        case 'cash': return 'Cash';
        case 'card': return 'Card';
        case 'qr': return 'QR';
        case 'online_banking': return 'Online Banking';
        default: return method;
      }
    }
    
    // Add item to cashbill form
    function addItem() {
      const itemsContainer = document.getElementById('itemsContainer');
      const newItem = document.createElement('div');
      newItem.className = 'item-row';
      newItem.innerHTML = `
        <div class="form-group">
          <label>Item</label>
          <select class="item-select" required>
            <option value="">Select an item</option>
          </select>
        </div>
        <div class="form-group">
          <label>Quantity</label>
          <input type="number" class="item-quantity" min="1" value="1" required>
          <div class="min-order-note" style="display: none; font-size: 0.8rem; color: var(--warning);">Minimum order: <span class="min-order-value"></span> sets</div>
        </div>
        <div class="form-group">
          <label>Unit Price (RM)</label>
          <input type="number" class="item-price" step="0.01" min="0" required placeholder="0.00">
        </div>
        <div class="form-group">
          <label>Tax (%)</label>
          <input type="number" class="item-tax" step="0.01" min="0" value="0" placeholder="0">
        </div>
        <div class="form-group">
          <label>Discount (RM)</label>
          <input type="number" class="item-discount" step="0.01" min="0" value="0" placeholder="0">
        </div>
        <div>
          <button type="button" class="remove-item-btn" onclick="removeItem(this)"><i class="fas fa-trash"></i> Remove</button>
        </div>
      `;
      itemsContainer.appendChild(newItem);
      
      // Populate the dropdown
      const selectElement = newItem.querySelector('.item-select');
      populateItemDropdown(selectElement);
      
      // Add event listener for item selection
      selectElement.addEventListener('change', function() {
        if (this.value) {
          const item = JSON.parse(this.value);
          const row = this.closest('.item-row');
          const isMember = document.getElementById('isMember').checked;
          const price = isMember ? item.memberPrice : item.price;
          row.querySelector('.item-price').value = price;
          
          // Handle minimum order
          if (item.minOrder) {
            const quantityInput = row.querySelector('.item-quantity');
            quantityInput.min = item.minOrder;
            quantityInput.value = item.minOrder;
            const minOrderNote = row.querySelector('.min-order-note');
            minOrderNote.querySelector('.min-order-value').textContent = item.minOrder;
            minOrderNote.style.display = 'block';
          } else {
            row.querySelector('.min-order-note').style.display = 'none';
          }
          
          // Recalculate totals
          calculateTotals();
        }
      });
      
      // Add event listeners to calculate totals
      newItem.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', calculateTotals);
      });
    }
    
    // Add custom item
    function addCustomItem() {
      const itemName = document.getElementById('customItemName').value;
      const itemPrice = parseFloat(document.getElementById('customItemPrice').value) || 0;
      
      if (!itemName || itemPrice <= 0) {
        alert('Please enter a valid item name and price');
        return;
      }
      
      const itemsContainer = document.getElementById('itemsContainer');
      const newItem = document.createElement('div');
      newItem.className = 'item-row';
      newItem.innerHTML = `
        <div class="form-group">
          <label>Item</label>
          <input type="text" class="item-description" value="${itemName}" required placeholder="Item description">
        </div>
        <div class="form-group">
          <label>Quantity</label>
          <input type="number" class="item-quantity" min="1" value="1" required>
        </div>
        <div class="form-group">
          <label>Unit Price (RM)</label>
          <input type="number" class="item-price" step="0.01" min="0" value="${itemPrice}" required placeholder="0.00">
        </div>
        <div class="form-group">
          <label>Tax (%)</label>
          <input type="number" class="item-tax" step="0.01" min="0" value="0" placeholder="0">
        </div>
        <div class="form-group">
          <label>Discount (RM)</label>
          <input type="number" class="item-discount" step="0.01" min="0" value="0" placeholder="0">
        </div>
        <div>
          <button type="button" class="remove-item-btn" onclick="removeItem(this)"><i class="fas fa-trash"></i> Remove</button>
        </div>
      `;
      itemsContainer.appendChild(newItem);
      
      // Add event listeners to calculate totals
      newItem.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', calculateTotals);
      });
      
      // Clear custom item inputs
      document.getElementById('customItemName').value = '';
      document.getElementById('customItemPrice').value = '';
      
      // Recalculate totals
      calculateTotals();
    }
    
    // Remove item from cashbill form
    function removeItem(button) {
      const itemRow = button.closest('.item-row');
      itemRow.remove();
      calculateTotals();
    }
    
    // Calculate totals
    function calculateTotals() {
      let subtotal = 0;
      let totalTax = 0;
      let totalDiscount = 0;
      
      document.querySelectorAll('.item-row').forEach(row => {
        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const price = parseFloat(row.querySelector('.item-price').value) || 0;
        const taxRate = parseFloat(row.querySelector('.item-tax').value) || 0;
        const discount = parseFloat(row.querySelector('.item-discount').value) || 0;
        
        // Ensure all values are valid numbers
        if (!isNaN(quantity) && !isNaN(price) && !isNaN(taxRate) && !isNaN(discount)) {
          const itemTotal = quantity * price;
          const itemTax = itemTotal * (taxRate / 100);
          
          subtotal += itemTotal;
          totalTax += itemTax;
          totalDiscount += discount;
        }
      });
      
      const grandTotal = subtotal + totalTax - totalDiscount;
      
      // Update display with proper formatting
      document.getElementById('subtotal').textContent = `${systemSettings.currency}${subtotal.toFixed(2)}`;
      document.getElementById('totalTax').textContent = `${systemSettings.currency}${totalTax.toFixed(2)}`;
      document.getElementById('totalDiscount').textContent = `${systemSettings.currency}${totalDiscount.toFixed(2)}`;
      document.getElementById('grandTotal').textContent = `${systemSettings.currency}${grandTotal.toFixed(2)}`;
    }
    
    // Initialize the first item row
    document.addEventListener('DOMContentLoaded', function() {
      // Update the initial item row
      const initialItemRow = document.querySelector('#itemsContainer .item-row');
      if (initialItemRow) {
        // Replace description input with dropdown
        const descriptionGroup = initialItemRow.querySelector('.form-group');
        descriptionGroup.innerHTML = `
          <label>Item</label>
          <select class="item-select" required>
            <option value="">Select an item</option>
          </select>
        `;
        
        // Add minimum order note
        const quantityGroup = initialItemRow.querySelectorAll('.form-group')[1];
        quantityGroup.innerHTML += `
          <div class="min-order-note" style="display: none; font-size: 0.8rem; color: var(--warning);">Minimum order: <span class="min-order-value"></span> sets</div>
        `;
        
        // Populate the dropdown
        const selectElement = initialItemRow.querySelector('.item-select');
        populateItemDropdown(selectElement);
        
        // Add event listener for item selection
        selectElement.addEventListener('change', function() {
          if (this.value) {
            const item = JSON.parse(this.value);
            const row = this.closest('.item-row');
            const isMember = document.getElementById('isMember').checked;
            const price = isMember ? item.memberPrice : item.price;
            row.querySelector('.item-price').value = price;
            
            // Handle minimum order
            if (item.minOrder) {
              const quantityInput = row.querySelector('.item-quantity');
              quantityInput.min = item.minOrder;
              quantityInput.value = item.minOrder;
              const minOrderNote = row.querySelector('.min-order-note');
              minOrderNote.querySelector('.min-order-value').textContent = item.minOrder;
              minOrderNote.style.display = 'block';
            } else {
              row.querySelector('.min-order-note').style.display = 'none';
            }
            
            // Recalculate totals
            calculateTotals();
          }
        });
      }
      
      // Add event listener for member checkbox
      const memberCheckbox = document.getElementById('isMember');
      if (memberCheckbox) {
        memberCheckbox.addEventListener('change', function() {
          // Update all item rows that have a selected item
          document.querySelectorAll('.item-row').forEach(row => {
            const select = row.querySelector('.item-select');
            if (select.value) {
              const item = JSON.parse(select.value);
              const price = this.checked ? item.memberPrice : item.price;
              row.querySelector('.item-price').value = price;
              calculateTotals();
            }
          });
        });
      }
    });
    
    // Add event listeners to initial inputs
    document.querySelectorAll('.item-row input').forEach(input => {
      input.addEventListener('input', calculateTotals);
    });
    
    // Helper function to save cashbill to server with proper serialization
    async function saveCashbillToServer(cashbill) {
      // Create a copy of the cashbill with properly serialized items
      const serializedCashbill = {
        ...cashbill,
        items: JSON.stringify(cashbill.items) // Serialize items array to JSON string
      };
      
      try {
        const response = await fetch(`${API_URL}?action=add&sheet=cashbills&data=${encodeURIComponent(JSON.stringify(serializedCashbill))}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        
        if (result.success) {
          return true;
        } else {
          throw new Error(result.error || "Unknown error");
        }
      } catch (error) {
        console.error("Error saving cashbill:", error);
        throw error;
      }
    }
    
    // Cashbill form submission
    document.getElementById('cashbillForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      showLoading();
      
      // Get form values
      const customerName = document.getElementById('customerName').value;
      const isMember = document.getElementById('isMember').checked;
      const paymentMethod = document.getElementById('paymentMethod').value;
      const status = document.getElementById('status').value;
      const notes = document.getElementById('notes').value;
      
      // Get items
      const items = [];
      document.querySelectorAll('.item-row').forEach(row => {
        const select = row.querySelector('.item-select');
        const descriptionInput = row.querySelector('.item-description');
        
        let description, regularPrice, memberPrice, minOrder, freeCap;
        
        if (select && select.value) {
          // Predefined item
          const itemData = JSON.parse(select.value);
          description = itemData.description;
          regularPrice = itemData.price;
          memberPrice = itemData.memberPrice;
          minOrder = itemData.minOrder;
          freeCap = itemData.freeCap;
        } else if (descriptionInput) {
          // Custom item
          description = descriptionInput.value;
          regularPrice = parseFloat(row.querySelector('.item-price').value) || 0;
          memberPrice = regularPrice;
          minOrder = null;
          freeCap = false;
        } else {
          // Skip if no valid item
          return;
        }
        
        const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
        const unitPrice = parseFloat(row.querySelector('.item-price').value) || 0;
        const taxRate = parseFloat(row.querySelector('.item-tax').value) || 0;
        const discount = parseFloat(row.querySelector('.item-discount').value) || 0;
        
        items.push({
          description,
          quantity,
          unitPrice,
          taxRate,
          discount,
          isMember: isMember,
          memberPrice: memberPrice,
          regularPrice: regularPrice,
          minOrder: minOrder,
          freeCap: freeCap
        });
      });
      
      if (items.length === 0) {
        alert('Please add at least one item');
        hideLoading();
        return;
      }
      
      // Calculate totals
      let subtotal = 0;
      let totalTax = 0;
      let totalDiscount = 0;
      
      items.forEach(item => {
        const itemTotal = item.quantity * item.unitPrice;
        const itemTax = itemTotal * (item.taxRate / 100);
        
        subtotal += itemTotal;
        totalTax += itemTax;
        totalDiscount += item.discount;
      });
      
      const grandTotal = subtotal + totalTax - totalDiscount;
      
      // Create cashbill object
      const cashbill = {
        id: Date.now(),
        invoiceNumber: getNextInvoiceNumber(),
        userId: currentUser.id,
        userName: currentUser.name, // Add userName
        customerName,
        isMember,
        items, // Keep as array for now
        paymentMethod,
        notes,
        subtotal,
        totalTax,
        totalDiscount,
        grandTotal,
        status: status,
        date: new Date().toISOString()
      };
      
      try {
        // Save to server with proper serialization
        await saveCashbillToServer(cashbill);
        
        // Update local cache
        cashbills.push(cashbill);
        
        // Log activity
        logActivity(currentUser.id, currentUser.name, 'Create Cashbill', `Created cashbill ${cashbill.invoiceNumber} for ${customerName}`);
        
        // Display cashbill details
        displayCashbillDetails(cashbill);
        
        // Hide loading
        hideLoading();
        
        // Show success page
        showPage('successPage');
        
        // Reset form
        resetForm();
      } catch (error) {
        console.error("Error saving cashbill:", error);
        alert("Error saving cashbill. Please try again.");
        hideLoading();
      }
    });
    
    // Save draft
    async function saveDraft() {
      showLoading();
      
      // Get form values
      const customerName = document.getElementById('customerName').value;
      const isMember = document.getElementById('isMember').checked;
      const paymentMethod = document.getElementById('paymentMethod').value;
      const notes = document.getElementById('notes').value;
      
      // Get items
      const items = [];
      document.querySelectorAll('.item-row').forEach(row => {
        const select = row.querySelector('.item-select');
        const descriptionInput = row.querySelector('.item-description');
        
        let description, regularPrice, memberPrice, minOrder, freeCap;
        
        if (select && select.value) {
          // Predefined item
          const itemData = JSON.parse(select.value);
          description = itemData.description;
          regularPrice = itemData.price;
          memberPrice = itemData.memberPrice;
          minOrder = itemData.minOrder;
          freeCap = itemData.freeCap;
        } else if (descriptionInput) {
          // Custom item
          description = descriptionInput.value;
          regularPrice = parseFloat(row.querySelector('.item-price').value) || 0;
          memberPrice = regularPrice;
          minOrder = null;
          freeCap = false;
        } else {
          // Skip if no valid item
          return;
        }
        
        const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
        const unitPrice = parseFloat(row.querySelector('.item-price').value) || 0;
        const taxRate = parseFloat(row.querySelector('.item-tax').value) || 0;
        const discount = parseFloat(row.querySelector('.item-discount').value) || 0;
        
        items.push({
          description,
          quantity,
          unitPrice,
          taxRate,
          discount,
          isMember: isMember,
          memberPrice: memberPrice,
          regularPrice: regularPrice,
          minOrder: minOrder,
          freeCap: freeCap
        });
      });
      
      if (items.length === 0) {
        alert('Please add at least one item');
        hideLoading();
        return;
      }
      
      // Calculate totals
      let subtotal = 0;
      let totalTax = 0;
      let totalDiscount = 0;
      
      items.forEach(item => {
        const itemTotal = item.quantity * item.unitPrice;
        const itemTax = itemTotal * (item.taxRate / 100);
        
        subtotal += itemTotal;
        totalTax += itemTax;
        totalDiscount += item.discount;
      });
      
      const grandTotal = subtotal + totalTax - totalDiscount;
      
      // Create cashbill object
      const cashbill = {
        id: Date.now(),
        invoiceNumber: getNextInvoiceNumber(),
        userId: currentUser.id,
        userName: currentUser.name, // Add userName
        customerName,
        isMember,
        items, // Keep as array for now
        paymentMethod,
        notes,
        subtotal,
        totalTax,
        totalDiscount,
        grandTotal,
        status: 'draft',
        date: new Date().toISOString()
      };
      
      try {
        // Save to server with proper serialization
        await saveCashbillToServer(cashbill);
        
        // Update local cache
        cashbills.push(cashbill);
        
        // Log activity
        logActivity(currentUser.id, currentUser.name, 'Save Draft', `Saved draft cashbill ${cashbill.invoiceNumber} for ${customerName}`);
        
        // Hide loading
        hideLoading();
        
        // Show success message
        alert('Draft saved successfully!');
        
        // Reset form
        resetForm();
      } catch (error) {
        console.error("Error saving draft:", error);
        alert("Error saving draft. Please try again.");
        hideLoading();
      }
    }
    
    // Reset form
    function resetForm() {
      document.getElementById('cashbillForm').reset();
      
      // Reset items to just one
      const itemsContainer = document.getElementById('itemsContainer');
      itemsContainer.innerHTML = `
        <div class="item-row">
          <div class="form-group">
            <label>Item</label>
            <select class="item-select" required>
              <option value="">Select an item</option>
            </select>
          </div>
          <div class="form-group">
            <label>Quantity</label>
            <input type="number" class="item-quantity" min="1" value="1" required>
            <div class="min-order-note" style="display: none; font-size: 0.8rem; color: var(--warning);">Minimum order: <span class="min-order-value"></span> sets</div>
          </div>
          <div class="form-group">
            <label>Unit Price (RM)</label>
            <input type="number" class="item-price" step="0.01" min="0" required placeholder="0.00">
          </div>
          <div class="form-group">
            <label>Tax (%)</label>
            <input type="number" class="item-tax" step="0.01" min="0" value="0" placeholder="0">
          </div>
          <div class="form-group">
            <label>Discount (RM)</label>
            <input type="number" class="item-discount" step="0.01" min="0" value="0" placeholder="0">
          </div>
          <div>
            <button type="button" class="remove-item-btn" onclick="removeItem(this)"><i class="fas fa-trash"></i> Remove</button>
          </div>
        </div>
      `;
      
      // Add event listeners
      const selectElement = itemsContainer.querySelector('.item-select');
      populateItemDropdown(selectElement);
      
      selectElement.addEventListener('change', function() {
        if (this.value) {
          const item = JSON.parse(this.value);
          const row = this.closest('.item-row');
          const isMember = document.getElementById('isMember').checked;
          const price = isMember ? item.memberPrice : item.price;
          row.querySelector('.item-price').value = price;
          
          // Handle minimum order
          if (item.minOrder) {
            const quantityInput = row.querySelector('.item-quantity');
            quantityInput.min = item.minOrder;
            quantityInput.value = item.minOrder;
            const minOrderNote = row.querySelector('.min-order-note');
            minOrderNote.querySelector('.min-order-value').textContent = item.minOrder;
            minOrderNote.style.display = 'block';
          } else {
            row.querySelector('.min-order-note').style.display = 'none';
          }
          
          // Recalculate totals
          calculateTotals();
        }
      });
      
      itemsContainer.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', calculateTotals);
      });
      
      // Reset totals
      calculateTotals();
    }
    
    // Display cashbill details on success page
    function displayCashbillDetails(cashbill) {
      const detailsContainer = document.getElementById('cashbillDetails');
      
      let itemsHTML = '';
      cashbill.items.forEach(item => {
        const itemTotal = item.quantity * item.unitPrice;
        const itemTax = itemTotal * (item.taxRate / 100);
        
        itemsHTML += `
          <div class="detail-row">
            <span>${item.description} (x${item.quantity})</span>
            <span>${systemSettings.currency}${itemTotal.toFixed(2)}</span>
          </div>
        `;
      });
      
      detailsContainer.innerHTML = `
        <h3>${cashbill.invoiceNumber} ${cashbill.status === 'draft' ? '<span class="draft-indicator">Draft</span>' : cashbill.status === 'pending' ? '<span class="pending-indicator">Pending</span>' : '<span class="committed-indicator">Committed</span>'}</h3>
        <div class="detail-row">
          <span>Customer Name:</span>
          <span>${cashbill.customerName}</span>
        </div>
        <div class="detail-row">
          <span>Date:</span>
          <span>${new Date(cashbill.date).toLocaleDateString()}</span>
        </div>
        <div class="detail-row">
          <span>Payment Method:</span>
          <span>${getPaymentMethodDisplayName(cashbill.paymentMethod)}</span>
        </div>
        <div class="detail-row">
          <span>Status:</span>
          <span>${cashbill.status === 'draft' ? 'Draft' : cashbill.status === 'pending' ? 'Pending' : 'Committed'}</span>
        </div>
        <div style="margin-top: 1.25rem;">
          <h4>Items:</h4>
          ${itemsHTML}
        </div>
        <div class="detail-row">
          <span>Subtotal:</span>
          <span>${systemSettings.currency}${cashbill.subtotal.toFixed(2)}</span>
        </div>
        <div class="detail-row">
          <span>Tax:</span>
          <span>${systemSettings.currency}${cashbill.totalTax.toFixed(2)}</span>
        </div>
        <div class="detail-row">
          <span>Discount:</span>
          <span>${systemSettings.currency}${cashbill.totalDiscount.toFixed(2)}</span>
        </div>
        <div class="detail-row final">
          <span>Total Amount:</span>
          <span>${systemSettings.currency}${cashbill.grandTotal.toFixed(2)}</span>
        </div>
        ${cashbill.notes ? `<div class="detail-row"><span>Notes:</span><span>${cashbill.notes}</span></div>` : ''}
      `;
    }
    
    // Update dashboard statistics
    function updateDashboardStats() {
      const committedCashbills = cashbills.filter(bill => bill.status === 'committed');
      const draftCashbills = cashbills.filter(bill => bill.status === 'draft');
      const pendingCashbills = cashbills.filter(bill => bill.status === 'pending');
      
      const totalCashbills = committedCashbills.length;
      const totalRevenue = committedCashbills.reduce((sum, bill) => sum + (bill.grandTotal || 0), 0);
      const cashPayments = committedCashbills.filter(bill => bill.paymentMethod === 'cash').length;
      const cardPayments = committedCashbills.filter(bill => bill.paymentMethod === 'card').length;
      const qrPayments = committedCashbills.filter(bill => bill.paymentMethod === 'qr').length;
      const onlineBankingPayments = committedCashbills.filter(bill => bill.paymentMethod === 'online_banking').length;
      
      document.getElementById('totalCashbills').textContent = totalCashbills;
      document.getElementById('totalRevenue').textContent = `${systemSettings.currency}${totalRevenue.toFixed(2)}`;
      document.getElementById('cashPayments').textContent = cashPayments;
      document.getElementById('cardPayments').textContent = cardPayments;
      document.getElementById('qrPayments').textContent = qrPayments;
      document.getElementById('onlineBankingPayments').textContent = onlineBankingPayments;
      
      // Show draft count if any
      if (draftCashbills.length > 0) {
        document.getElementById('draftCount').textContent = draftCashbills.length;
        document.getElementById('dashboardMessage').style.display = 'flex';
      } else {
        document.getElementById('dashboardMessage').style.display = 'none';
      }
      
      // Update crew features
      if (currentUser && currentUser.role === 'crew') {
        updateCrewFeatures();
      }
      
      // Update admin features
      if (currentUser && currentUser.role === 'admin') {
        updateAdminFeatures();
      }
    }
    
    // Update crew features
    function updateCrewFeatures() {
      // Get crew's cashbills
      const myCashbills = cashbills.filter(bill => bill.userId === currentUser.id);
      const myCommittedCashbills = myCashbills.filter(bill => bill.status === 'committed');
      const myDraftCashbills = myCashbills.filter(bill => bill.status === 'draft');
      const myPendingCashbills = myCashbills.filter(bill => bill.status === 'pending');
      const myTotalRevenue = myCommittedCashbills.reduce((sum, bill) => sum + (bill.grandTotal || 0), 0);
      
      // Update performance metrics
      document.getElementById('myCashbillsCount').textContent = myCashbills.length;
      document.getElementById('myRevenueAmount').textContent = `${systemSettings.currency}${myTotalRevenue.toFixed(2)}`;
      
      // Update progress bars
      const cashbillsTarget = systemSettings.cashbillTargets.crew;
      const revenueTarget = systemSettings.revenueTargets.crew;
      const cashbillsProgress = Math.min(100, (myCashbills.length / cashbillsTarget) * 100);
      const revenueProgress = Math.min(100, (myTotalRevenue / revenueTarget) * 100);
      const completionRate = myCashbills.length > 0 ? (myCommittedCashbills.length / myCashbills.length * 100) : 0;
      
      document.getElementById('myCashbillsProgress').style.width = `${cashbillsProgress}%`;
      document.getElementById('myRevenueProgress').style.width = `${revenueProgress}%`;
      document.getElementById('myCompletionProgress').style.width = `${completionRate}%`;
      document.getElementById('myCompletionRate').textContent = `${completionRate.toFixed(1)}%`;
      
      // Update draft count badge
      const draftBadge = document.getElementById('draftCountBadge');
      if (myDraftCashbills.length > 0) {
        draftBadge.textContent = myDraftCashbills.length;
        draftBadge.style.display = 'flex';
      } else {
        draftBadge.style.display = 'none';
      }
      
      // Update recent activity
      updateMyRecentActivity();
    }
    
    // Update admin features
    function updateAdminFeatures() {
      // Update system health
      document.getElementById('totalCashbillsCount').textContent = cashbills.length;
      
      // Update user activity chart
      updateUserActivityChart();
      
      // Update system activity
      updateSystemRecentActivity();
    }
    
    // Update my recent activity
    function updateMyRecentActivity() {
      const container = document.getElementById('myRecentActivity');
      const myActivities = activityLog
        .filter(log => log.userId === currentUser.id)
        .slice(0, 10);
      
      if (myActivities.length === 0) {
        container.innerHTML = '<p>No recent activity.</p>';
        return;
      }
      
      let html = '';
      myActivities.forEach(activity => {
        const date = new Date(activity.timestamp);
        const formattedDate = date.toLocaleDateString();
        const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        let iconClass = '';
        if (activity.action === 'Login') iconClass = 'login';
        else if (activity.action === 'Create Cashbill') iconClass = 'create';
        else if (activity.action === 'Edit Cashbill') iconClass = 'edit';
        else if (activity.action === 'Delete Cashbill') iconClass = 'delete';
        
        html += `
          <div class="activity-item">
            <div class="activity-icon ${iconClass}">
              <i class="fas fa-${getActivityIcon(activity.action)}"></i>
            </div>
            <div class="activity-content">
              <div class="activity-title">${activity.action}</div>
              <div class="activity-time">${formattedDate} at ${formattedTime}</div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    // Update system recent activity
    function updateSystemRecentActivity() {
      const container = document.getElementById('systemRecentActivity');
      const recentActivities = activityLog.slice(0, 10);
      
      if (recentActivities.length === 0) {
        container.innerHTML = '<p>No recent activity.</p>';
        return;
      }
      
      let html = '';
      recentActivities.forEach(activity => {
        const date = new Date(activity.timestamp);
        const formattedDate = date.toLocaleDateString();
        const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        let iconClass = '';
        if (activity.action === 'Login') iconClass = 'login';
        else if (activity.action === 'Create Cashbill') iconClass = 'create';
        else if (activity.action === 'Edit Cashbill') iconClass = 'edit';
        else if (activity.action === 'Delete Cashbill') iconClass = 'delete';
        
        html += `
          <div class="activity-item">
            <div class="activity-icon ${iconClass}">
              <i class="fas fa-${getActivityIcon(activity.action)}"></i>
            </div>
            <div class="activity-content">
              <div class="activity-title">${activity.username} ${activity.action.toLowerCase()}</div>
              <div class="activity-time">${formattedDate} at ${formattedTime}</div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    // Get activity icon
    function getActivityIcon(action) {
      switch(action) {
        case 'Login': return 'sign-in-alt';
        case 'Create Cashbill': return 'plus-circle';
        case 'Edit Cashbill': return 'edit';
        case 'Delete Cashbill': return 'trash';
        case 'Save Draft': return 'save';
        case 'Export Data': return 'file-export';
        case 'Add User': return 'user-plus';
        case 'Reset Password': return 'key';
        case 'Grant Temporary Access': return 'user-clock';
        case 'Revoke Temporary Access': return 'user-times';
        case 'Backup System': return 'download';
        case 'Restore System': return 'upload';
        case 'Update System Settings': return 'cog';
        case 'Generate Report': return 'file-alt';
        default: return 'info-circle';
      }
    }
    
    // Update user activity chart
    function updateUserActivityChart() {
      const container = document.getElementById('userActivityChart');
      container.innerHTML = '';
      
      // Get the last 30 days
      const today = new Date();
      const thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      
      // Filter cashbills in the last 30 days
      const recentCashbills = cashbills.filter(bill => {
        const billDate = new Date(bill.date);
        return billDate >= thirtyDaysAgo && billDate <= today;
      });
      
      // Group by user
      const userActivity = {};
      users.forEach(user => {
        userActivity[user.name] = 0;
      });
      
      recentCashbills.forEach(bill => {
        const user = users.find(u => u.id === bill.userId);
        if (user) {
          userActivity[user.name]++;
        }
      });
      
      // Find max value for scaling
      const maxCount = Math.max(...Object.values(userActivity), 1);
      
      // Create bars
      Object.entries(userActivity).forEach(([username, count]) => {
        const barHeight = (count / maxCount) * 100; // percentage of max
        const bar = document.createElement('div');
        bar.style.flex = '1';
        bar.style.display = 'flex';
        bar.style.flexDirection = 'column';
        bar.style.alignItems = 'center';
        bar.style.position = 'relative';
        bar.innerHTML = `
          <div class="chart-bar" style="height: ${barHeight}%; min-height: 5px;">
            <div class="chart-value">${count}</div>
          </div>
          <div class="chart-label">${username}</div>
        `;
        container.appendChild(bar);
      });
    }
    
    // Update activity log
    function updateActivityLog() {
      const activityLogContainer = document.getElementById('activityLog');
      
      if (activityLog.length === 0) {
        activityLogContainer.innerHTML = '<p>No recent activity.</p>';
        return;
      }
      
      let logHTML = '';
      const recentLogs = activityLog.slice(0, 10); // Show only 10 most recent
      
      recentLogs.forEach(log => {
        const date = new Date(log.timestamp);
        const formattedDate = date.toLocaleDateString();
        const formattedTime = date.toLocaleTimeString();
        
        logHTML += `
          <div class="log-entry">
            <strong>${log.username}</strong> ${log.action}
            ${log.details ? ` - ${log.details}` : ''}
            <div class="log-time">${formattedDate} ${formattedTime}</div>
          </div>
        `;
      });
      
      activityLogContainer.innerHTML = logHTML;
    }
    
    // Show drafts for current user
    function showDrafts() {
      document.getElementById('filterStatus').value = 'draft';
      applyFilters();
      showPage('cashbillListPage');
    }
    
    // Show cashbills for current user
    function showMyCashbills() {
      resetFilters();
      showPage('cashbillListPage');
    }
    
    // Show performance report
    function showPerformanceReport() {
      alert('Performance report feature would be implemented here with detailed analytics and charts.');
    }
    
    // Backup system data
    function backupSystem() {
      showLoading();
      
      const backup = {
        cashbills,
        activityLog,
        notifications,
        systemSettings,
        lastInvoiceNumber: localStorage.getItem('lastInvoiceNumber'),
        timestamp: new Date().toISOString()
      };
      
      const dataStr = JSON.stringify(backup, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = `pne_arena_backup_${new Date().toISOString().split('T')[0]}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
      
      hideLoading();
      
      logActivity(currentUser.id, currentUser.name, 'Backup System', 'Created system data backup');
      alert('Backup created successfully!');
    }
    
    // Show restore modal
    function showRestoreModal() {
      document.getElementById('restoreModal').style.display = 'flex';
    }
    
    // Close restore modal
    function closeRestoreModal() {
      document.getElementById('restoreModal').style.display = 'none';
    }
    
    // Restore system data
    function restoreSystem() {
      const fileInput = document.getElementById('restoreFile');
      if (!fileInput.files.length) {
        alert('Please select a backup file');
        return;
      }
      
      const file = fileInput.files[0];
      const reader = new FileReader();
      
      reader.onload = async function(e) {
        try {
          const backup = JSON.parse(e.target.result);
          
          if (backup.cashbills && backup.activityLog) {
            // Clear existing data
            cashbills = [];
            activityLog = [];
            notifications = [];
            
            // Add cashbills to server
            for (const cashbill of backup.cashbills) {
              await fetch(`${API_URL}?action=add&sheet=cashbills&data=${encodeURIComponent(JSON.stringify(cashbill))}`);
            }
            
            // Add activity log to server
            for (const log of backup.activityLog) {
              await fetch(`${API_URL}?action=add&sheet=activityLog&data=${encodeURIComponent(JSON.stringify(log))}`);
            }
            
            // Add notifications to server
            if (backup.notifications) {
              for (const notification of backup.notifications) {
                await fetch(`${API_URL}?action=add&sheet=notifications&data=${encodeURIComponent(JSON.stringify(notification))}`);
              }
            }
            
            // Update system settings
            if (backup.systemSettings) {
              systemSettings = backup.systemSettings;
              document.querySelector('header h1').textContent = systemSettings.companyName + ' System';
            }
            
            if (backup.lastInvoiceNumber) {
              localStorage.setItem('lastInvoiceNumber', backup.lastInvoiceNumber);
            }
            
            // Reload data
            loadData();
            
            closeRestoreModal();
            
            alert('System restored successfully! The page will now reload.');
            setTimeout(() => location.reload(), 1500);
          } else {
            alert('Invalid backup file');
          }
        } catch (error) {
          alert('Error reading backup file: ' + error.message);
        }
      };
      
      reader.readAsText(file);
    }
    
    // Show system settings modal
    function showSystemSettings() {
      document.getElementById('systemSettingsModal').style.display = 'flex';
      
      // Populate settings
      document.getElementById('settingsCompanyName').value = systemSettings.companyName;
      document.getElementById('settingsCompanyAddress').value = systemSettings.companyAddress;
      document.getElementById('settingsCurrency').value = systemSettings.currency;
      document.getElementById('settingsTaxRate').value = systemSettings.taxRate;
      document.getElementById('settingsCrewTarget').value = systemSettings.cashbillTargets.crew;
      document.getElementById('settingsCrewRevenue').value = systemSettings.revenueTargets.crew;
    }
    
    // Close system settings modal
    function closeSystemSettingsModal() {
      document.getElementById('systemSettingsModal').style.display = 'none';
    }
    
    // Save system settings
    async function saveSystemSettings() {
      systemSettings.companyName = document.getElementById('settingsCompanyName').value;
      systemSettings.companyAddress = document.getElementById('settingsCompanyAddress').value;
      systemSettings.currency = document.getElementById('settingsCurrency').value;
      systemSettings.taxRate = parseFloat(document.getElementById('settingsTaxRate').value);
      systemSettings.cashbillTargets.crew = parseInt(document.getElementById('settingsCrewTarget').value);
      systemSettings.revenueTargets.crew = parseFloat(document.getElementById('settingsCrewRevenue').value);
      
      // Update system settings in Google Sheets
      try {
        const response = await fetch(`${API_URL}?action=update&sheet=systemSettings&id=1&data=${encodeURIComponent(JSON.stringify(systemSettings))}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        
        if (result.success) {
          // Update company name in header
          document.querySelector('header h1').textContent = systemSettings.companyName + ' System';
          
          logActivity(currentUser.id, currentUser.name, 'Update System Settings', 'Updated system configuration');
          
          alert('Settings saved successfully!');
          closeSystemSettingsModal();
        } else {
          throw new Error(result.error || "Unknown error");
        }
      } catch (error) {
        console.error("Error saving settings:", error);
        alert("Error saving settings. Please try again.");
      }
    }
    
    // Generate system report
    function generateReport() {
      showLoading();
      
      const committedCashbills = cashbills.filter(bill => bill.status === 'committed');
      const totalRevenue = committedCashbills.reduce((sum, bill) => sum + (bill.grandTotal || 0), 0);
      
      const paymentMethods = {
        cash: committedCashbills.filter(bill => bill.paymentMethod === 'cash').length,
        card: committedCashbills.filter(bill => bill.paymentMethod === 'card').length,
        qr: committedCashbills.filter(bill => bill.paymentMethod === 'qr').length,
        online_banking: committedCashbills.filter(bill => bill.paymentMethod === 'online_banking').length
      };
      
      const userStats = {};
      users.forEach(user => {
        const userCashbills = cashbills.filter(bill => bill.userId === user.id);
        const userCommitted = userCashbills.filter(bill => bill.status === 'committed');
        const userRevenue = userCommitted.reduce((sum, bill) => sum + (bill.grandTotal || 0), 0);
        
        userStats[user.name] = {
          total: userCashbills.length,
          committed: userCommitted.length,
          revenue: userRevenue
        };
      });
      
      const report = {
        generatedAt: new Date().toISOString(),
        summary: {
          totalCashbills: cashbills.length,
          committedCashbills: committedCashbills.length,
          draftCashbills: cashbills.length - committedCashbills.length,
          totalRevenue: totalRevenue,
          paymentMethods: paymentMethods
        },
        userStats: userStats,
        systemSettings: systemSettings
      };
      
      const dataStr = JSON.stringify(report, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = `pne_arena_report_${new Date().toISOString().split('T')[0]}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
      
      // Log activity
      logActivity(currentUser.id, currentUser.name, 'Generate Report', 'Generated system report');
      
      hideLoading();
      
      alert('Report generated successfully!');
    }
    
    // Show audit log modal
    function showAuditLog() {
      document.getElementById('auditLogModal').style.display = 'flex';
      
      // Populate user dropdown
      const userSelect = document.getElementById('auditUser');
      userSelect.innerHTML = '<option value="">All Users</option>';
      
      users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = user.name;
        userSelect.appendChild(option);
      });
      
      // Load audit log
      loadAuditLog();
    }
    
    // Close audit log modal
    function closeAuditLogModal() {
      document.getElementById('auditLogModal').style.display = 'none';
    }
    
    // Load audit log
    function loadAuditLog() {
      const auditLogContent = document.getElementById('auditLogContent');
      
      if (activityLog.length === 0) {
        auditLogContent.innerHTML = '<p>No audit log entries found.</p>';
        return;
      }
      
      let html = '';
      activityLog.forEach(log => {
        const date = new Date(log.timestamp);
        const formattedDate = date.toLocaleDateString();
        const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        html += `
          <div class="log-entry">
            <strong>${log.username}</strong> ${log.action}
            ${log.details ? ` - ${log.details}` : ''}
            <div class="log-time">${formattedDate} ${formattedTime}</div>
          </div>
        `;
      });
      
      auditLogContent.innerHTML = html;
    }
    
    // Apply audit log filters
    function applyAuditFilters() {
      // In a real application, this would filter the audit log based on selected filters
      loadAuditLog();
    }
    
    // Export audit log
    function exportAuditLog() {
      showLoading();
      
      const auditData = activityLog.map(log => ({
        User: log.username,
        Action: log.action,
        Details: log.details || '',
        Timestamp: new Date(log.timestamp).toISOString()
      }));
      
      const csv = convertToCSV(auditData);
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `audit_log_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      hideLoading();
      
      // Log activity
      logActivity(currentUser.id, currentUser.name, 'Export Data', 'Exported audit log to CSV');
    }
    
    // Show data analytics modal
    function showDataAnalytics() {
      document.getElementById('dataAnalyticsModal').style.display = 'flex';
    }
    
    // Close data analytics modal
    function closeDataAnalyticsModal() {
      document.getElementById('dataAnalyticsModal').style.display = 'none';
    }
    
    // Advanced Analytics Implementation
    let analyticsChart = null;
    let analyticsData = {};
    
    // Initialize analytics when modal is opened
    function initializeAnalytics() {
      const ctx = document.getElementById('analyticsChart').getContext('2d');
      
      // Destroy existing chart if it exists
      if (analyticsChart) {
        analyticsChart.destroy();
      }
      
      // Get selected options
      const period = document.getElementById('analyticsPeriodModal').value;
      const chartType = document.getElementById('analyticsChartType').value;
      const metric = document.getElementById('analyticsMetric').value;
      
      // Show/hide custom date range
      const customDateRange = document.getElementById('customDateRange');
      if (period === 'custom') {
        customDateRange.style.display = 'flex';
        // Set default dates
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - 30);
        
        document.getElementById('analyticsDateFrom').value = startDate.toISOString().split('T')[0];
        document.getElementById('analyticsDateTo').value = endDate.toISOString().split('T')[0];
      } else {
        customDateRange.style.display = 'none';
      }
      
      // Get date range
      let startDate, endDate;
      if (period === 'custom') {
        startDate = new Date(document.getElementById('analyticsDateFrom').value);
        endDate = new Date(document.getElementById('analyticsDateTo').value);
        if (!startDate || !endDate || startDate > endDate) {
          alert('Please select a valid date range');
          return;
        }
      } else {
        endDate = new Date();
        startDate = new Date();
        startDate.setDate(endDate.getDate() - parseInt(period));
      }
      
      // Prepare data based on metric
      let chartData, chartOptions;
      
      switch(metric) {
        case 'revenue':
          chartData = prepareRevenueData(startDate, endDate, chartType);
          chartOptions = getRevenueChartOptions(chartType);
          break;
        case 'cashbills':
          chartData = prepareCashbillsData(startDate, endDate, chartType);
          chartOptions = getCashbillsChartOptions(chartType);
          break;
        case 'users':
          chartData = prepareUsersData(startDate, endDate, chartType);
          chartOptions = getUsersChartOptions(chartType);
          break;
        case 'items':
          chartData = prepareItemsData(startDate, endDate, chartType);
          chartOptions = getItemsChartOptions(chartType);
          break;
        case 'payments':
          chartData = preparePaymentsData(startDate, endDate, chartType);
          chartOptions = getPaymentsChartOptions(chartType);
          break;
        case 'performance':
          chartData = preparePerformanceData(startDate, endDate, chartType);
          chartOptions = getPerformanceChartOptions(chartType);
          break;
      }
      
      // Create chart
      analyticsChart = new Chart(ctx, {
        type: chartType,
        data: chartData,
        options: chartOptions
      });
      
      // Update summary cards
      updateAnalyticsSummary(startDate, endDate, metric);
      
      // Store data for export
      analyticsData = {
        period: period,
        startDate: startDate,
        endDate: endDate,
        metric: metric,
        chartType: chartType,
        data: chartData
      };
    }
    
    // Prepare revenue data
    function prepareRevenueData(startDate, endDate, chartType) {
      // Filter cashbills within period
      const periodCashbills = cashbills.filter(bill => {
        const billDate = new Date(bill.date);
        return billDate >= startDate && billDate <= endDate && bill.status === 'committed';
      });
      
      if (chartType === 'pie' || chartType === 'doughnut' || chartType === 'polarArea') {
        // Group by user
        const revenueByUser = {};
        users.forEach(user => {
          revenueByUser[user.name] = 0;
        });
        
        periodCashbills.forEach(bill => {
          const user = users.find(u => u.id === bill.userId);
          if (user) {
            revenueByUser[user.name] += bill.grandTotal || 0;
          }
        });
        
        return {
          labels: Object.keys(revenueByUser),
          datasets: [{
            label: 'Revenue by User',
            data: Object.values(revenueByUser),
            backgroundColor: [
              'rgba(37, 99, 235, 0.7)',
              'rgba(34, 197, 94, 0.7)',
              'rgba(245, 158, 11, 0.7)',
              'rgba(239, 68, 68, 0.7)',
              'rgba(107, 114, 128, 0.7)'
            ],
            borderColor: [
              'rgba(37, 99, 235, 1)',
              'rgba(34, 197, 94, 1)',
              'rgba(245, 158, 11, 1)',
              'rgba(239, 68, 68, 1)',
              'rgba(107, 114, 128, 1)'
            ],
            borderWidth: 1
          }]
        };
      } else {
        // Group by day
        const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
        const revenueByDay = {};
        
        for (let i = 0; i < days; i++) {
          const date = new Date(startDate);
          date.setDate(startDate.getDate() + i);
          const dateStr = date.toISOString().split('T')[0];
          revenueByDay[dateStr] = 0;
        }
        
        periodCashbills.forEach(bill => {
          const dateStr = new Date(bill.date).toISOString().split('T')[0];
          if (revenueByDay.hasOwnProperty(dateStr)) {
            revenueByDay[dateStr] += bill.grandTotal || 0;
          }
        });
        
        return {
          labels: Object.keys(revenueByDay).map(date => {
            const d = new Date(date);
            return `${d.getDate()}/${d.getMonth() + 1}`;
          }),
          datasets: [{
            label: 'Revenue',
            data: Object.values(revenueByDay),
            backgroundColor: 'rgba(37, 99, 235, 0.2)',
            borderColor: 'rgba(37, 99, 235, 1)',
            borderWidth: 2,
            tension: 0.4,
            fill: true
          }]
        };
      }
    }
    
    // Prepare cashbills data
    function prepareCashbillsData(startDate, endDate, chartType) {
      const periodCashbills = cashbills.filter(bill => {
        const billDate = new Date(bill.date);
        return billDate >= startDate && billDate <= endDate;
      });
      
      if (chartType === 'pie' || chartType === 'doughnut' || chartType === 'polarArea') {
        // Group by status
        const cashbillsByStatus = {
          'Committed': 0,
          'Pending': 0,
          'Draft': 0
        };
        
        periodCashbills.forEach(bill => {
          cashbillsByStatus[bill.status === 'committed' ? 'Committed' : bill.status === 'pending' ? 'Pending' : 'Draft']++;
        });
        
        return {
          labels: Object.keys(cashbillsByStatus),
          datasets: [{
            label: 'Cashbills by Status',
            data: Object.values(cashbillsByStatus),
            backgroundColor: [
              'rgba(34, 197, 94, 0.7)',
              'rgba(59, 130, 246, 0.7)',
              'rgba(245, 158, 11, 0.7)'
            ],
            borderColor: [
              'rgba(34, 197, 94, 1)',
              'rgba(59, 130, 246, 1)',
              'rgba(245, 158, 11, 1)'
            ],
            borderWidth: 1
          }]
        };
      } else {
        // Group by day and status
        const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
        const cashbillsByDay = {
          committed: {},
          pending: {},
          draft: {}
        };
        
        for (let i = 0; i < days; i++) {
          const date = new Date(startDate);
          date.setDate(startDate.getDate() + i);
          const dateStr = date.toISOString().split('T')[0];
          cashbillsByDay.committed[dateStr] = 0;
          cashbillsByDay.pending[dateStr] = 0;
          cashbillsByDay.draft[dateStr] = 0;
        }
        
        periodCashbills.forEach(bill => {
          const dateStr = new Date(bill.date).toISOString().split('T')[0];
          if (cashbillsByDay[bill.status].hasOwnProperty(dateStr)) {
            cashbillsByDay[bill.status][dateStr]++;
          }
        });
        
        return {
          labels: Object.keys(cashbillsByDay.committed).map(date => {
            const d = new Date(date);
            return `${d.getDate()}/${d.getMonth() + 1}`;
          }),
          datasets: [
            {
              label: 'Committed',
              data: Object.values(cashbillsByDay.committed),
              backgroundColor: 'rgba(34, 197, 94, 0.2)',
              borderColor: 'rgba(34, 197, 94, 1)',
              borderWidth: 2
            },
            {
              label: 'Pending',
              data: Object.values(cashbillsByDay.pending),
              backgroundColor: 'rgba(59, 130, 246, 0.2)',
              borderColor: 'rgba(59, 130, 246, 1)',
              borderWidth: 2
            },
            {
              label: 'Draft',
              data: Object.values(cashbillsByDay.draft),
              backgroundColor: 'rgba(245, 158, 11, 0.2)',
              borderColor: 'rgba(245, 158, 11, 1)',
              borderWidth: 2
            }
          ]
        };
      }
    }
    
    // Prepare users data
    function prepareUsersData(startDate, endDate, chartType) {
      const periodActivities = activityLog.filter(log => {
        const logDate = new Date(log.timestamp);
        return logDate >= startDate && logDate <= endDate;
      });
      
      if (chartType === 'radar') {
        // Group by action type
        const actionsByType = {};
        const actionTypes = ['Login', 'Create Cashbill', 'Edit Cashbill', 'Delete Cashbill', 'Save Draft'];
        
        actionTypes.forEach(action => {
          actionsByType[action] = 0;
        });
        
        periodActivities.forEach(log => {
          if (actionsByType.hasOwnProperty(log.action)) {
            actionsByType[log.action]++;
          }
        });
        
        return {
          labels: Object.keys(actionsByType),
          datasets: [{
            label: 'User Activities',
            data: Object.values(actionsByType),
            backgroundColor: 'rgba(37, 99, 235, 0.2)',
            borderColor: 'rgba(37, 99, 235, 1)',
            borderWidth: 2,
            pointBackgroundColor: 'rgba(37, 99, 235, 1)'
          }]
        };
      } else {
        // Group by user
        const userActivity = {};
        users.forEach(user => {
          userActivity[user.name] = 0;
        });
        
        periodActivities.forEach(log => {
          if (userActivity.hasOwnProperty(log.username)) {
            userActivity[log.username]++;
          }
        });
        
        return {
          labels: Object.keys(userActivity),
          datasets: [{
            label: 'Activities',
            data: Object.values(userActivity),
            backgroundColor: [
              'rgba(37, 99, 235, 0.7)',
              'rgba(34, 197, 94, 0.7)',
              'rgba(245, 158, 11, 0.7)',
              'rgba(239, 68, 68, 0.7)',
              'rgba(107, 114, 128, 0.7)'
            ],
            borderColor: [
              'rgba(37, 99, 235, 1)',
              'rgba(34, 197, 94, 1)',
              'rgba(245, 158, 11, 1)',
              'rgba(239, 68, 68, 1)',
              'rgba(107, 114, 128, 1)'
            ],
            borderWidth: 1
          }]
        };
      }
    }
    
    // Prepare items data
    function prepareItemsData(startDate, endDate, chartType) {
      const periodCashbills = cashbills.filter(bill => {
        const billDate = new Date(bill.date);
        return billDate >= startDate && billDate <= endDate && bill.status === 'committed';
      });
      
      // Aggregate item sales
      const itemSales = {};
      
      periodCashbills.forEach(bill => {
        if (bill.items && Array.isArray(bill.items)) {
          bill.items.forEach(item => {
            if (itemSales[item.description]) {
              itemSales[item.description] += item.quantity;
            } else {
              itemSales[item.description] = item.quantity;
            }
          });
        }
      });
      
      // Sort by quantity sold
      const sortedItems = Object.entries(itemSales)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10); // Top 10 items
      
      return {
        labels: sortedItems.map(item => item[0]),
        datasets: [{
          label: 'Quantity Sold',
          data: sortedItems.map(item => item[1]),
          backgroundColor: 'rgba(34, 197, 94, 0.7)',
          borderColor: 'rgba(34, 197, 94, 1)',
          borderWidth: 1
        }]
      };
    }
    
    // Prepare payments data
    function preparePaymentsData(startDate, endDate, chartType) {
      const periodCashbills = cashbills.filter(bill => {
        const billDate = new Date(bill.date);
        return billDate >= startDate && billDate <= endDate && bill.status === 'committed';
      });
      
      // Group by payment method
      const paymentsByMethod = {
        'Cash': 0,
        'Card': 0,
        'QR': 0,
        'Online Banking': 0
      };
      
      periodCashbills.forEach(bill => {
        const method = getPaymentMethodDisplayName(bill.paymentMethod);
        if (paymentsByMethod.hasOwnProperty(method)) {
          paymentsByMethod[method] += bill.grandTotal || 0;
        }
      });
      
      return {
        labels: Object.keys(paymentsByMethod),
        datasets: [{
          label: 'Payment Methods',
          data: Object.values(paymentsByMethod),
          backgroundColor: [
            'rgba(37, 99, 235, 0.7)',
            'rgba(34, 197, 94, 0.7)',
            'rgba(245, 158, 11, 0.7)',
            'rgba(239, 68, 68, 0.7)'
          ],
          borderColor: [
            'rgba(37, 99, 235, 1)',
            'rgba(34, 197, 94, 1)',
            'rgba(245, 158, 11, 1)',
            'rgba(239, 68, 68, 1)'
          ],
          borderWidth: 1
        }]
      };
    }
    
    // Prepare performance data
    function preparePerformanceData(startDate, endDate, chartType) {
      const periodCashbills = cashbills.filter(bill => {
        const billDate = new Date(bill.date);
        return billDate >= startDate && billDate <= endDate;
      });
      
      // Calculate performance metrics for each user
      const userPerformance = {};
      
      users.forEach(user => {
        const userCashbills = periodCashbills.filter(bill => bill.userId === user.id);
        const committedCashbills = userCashbills.filter(bill => bill.status === 'committed');
        const totalRevenue = committedCashbills.reduce((sum, bill) => sum + (bill.grandTotal || 0), 0);
        
        userPerformance[user.name] = {
          cashbills: userCashbills.length,
          committed: committedCashbills.length,
          revenue: totalRevenue,
          completionRate: userCashbills.length > 0 ? 
            (committedCashbills.length / userCashbills.length * 100) : 0
        };
      });
      
      if (chartType === 'radar') {
        return {
          labels: Object.keys(userPerformance),
          datasets: [
            {
              label: 'Cashbills Created',
              data: Object.values(userPerformance).map(p => p.cashbills),
              backgroundColor: 'rgba(37, 99, 235, 0.2)',
              borderColor: 'rgba(37, 99, 235, 1)',
              borderWidth: 2,
              pointBackgroundColor: 'rgba(37, 99, 235, 1)'
            },
            {
              label: 'Completion Rate (%)',
              data: Object.values(userPerformance).map(p => p.completionRate),
              backgroundColor: 'rgba(34, 197, 94, 0.2)',
              borderColor: 'rgba(34, 197, 94, 1)',
              borderWidth: 2,
              pointBackgroundColor: 'rgba(34, 197, 94, 1)'
            }
          ]
        };
      } else {
        return {
          labels: Object.keys(userPerformance),
          datasets: [
            {
              label: 'Revenue',
              data: Object.values(userPerformance).map(p => p.revenue),
              backgroundColor: 'rgba(37, 99, 235, 0.7)',
              borderColor: 'rgba(37, 99, 235, 1)',
              borderWidth: 1
            },
            {
              label: 'Completion Rate',
              data: Object.values(userPerformance).map(p => p.completionRate),
              backgroundColor: 'rgba(34, 197, 94, 0.7)',
              borderColor: 'rgba(34, 197, 94, 1)',
              borderWidth: 1
            }
          ]
        };
      }
    }
    
    // Get chart options for revenue
    function getRevenueChartOptions(chartType) {
      const baseOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Revenue Analysis',
            font: { size: 16 }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `Revenue: ${systemSettings.currency}${context.parsed.y.toFixed(2)}`;
              }
            }
          }
        }
      };
      
      if (chartType !== 'pie' && chartType !== 'doughnut' && chartType !== 'polarArea') {
        baseOptions.scales = {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return systemSettings.currency + value.toFixed(0);
              }
            }
          }
        };
      }
      
      return baseOptions;
    }
    
    // Get chart options for cashbills
    function getCashbillsChartOptions(chartType) {
      const baseOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Cashbills Analysis',
            font: { size: 16 }
          }
        }
      };
      
      if (chartType !== 'pie' && chartType !== 'doughnut' && chartType !== 'polarArea') {
        baseOptions.scales = {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        };
      }
      
      return baseOptions;
    }
    
    // Get chart options for users
    function getUsersChartOptions(chartType) {
      const baseOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'User Activity Analysis',
            font: { size: 16 }
          }
        }
      };
      
      if (chartType !== 'pie' && chartType !== 'doughnut' && chartType !== 'polarArea' && chartType !== 'radar') {
        baseOptions.scales = {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        };
      }
      
      return baseOptions;
    }
    
    // Get chart options for items
    function getItemsChartOptions(chartType) {
      return {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Top Selling Items',
            font: { size: 16 }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        }
      };
    }
    
    // Get chart options for payments
    function getPaymentsChartOptions(chartType) {
      const baseOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Payment Methods Distribution',
            font: { size: 16 }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `${context.label}: ${systemSettings.currency}${context.parsed.toFixed(2)}`;
              }
            }
          }
        }
      };
      
      if (chartType === 'bar') {
        baseOptions.scales = {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return systemSettings.currency + value.toFixed(0);
              }
            }
          }
        };
      }
      
      return baseOptions;
    }
    
    // Get chart options for performance
    function getPerformanceChartOptions(chartType) {
      const baseOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'User Performance',
            font: { size: 16 }
          }
        }
      };
      
      if (chartType !== 'radar') {
        baseOptions.scales = {
          y: {
            beginAtZero: true
          }
        };
      }
      
      return baseOptions;
    }
    
    // Update analytics summary cards
    function updateAnalyticsSummary(startDate, endDate, metric) {
      // Calculate previous period for comparison
      const periodLength = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
      const prevEndDate = new Date(startDate);
      const prevStartDate = new Date(prevEndDate);
      prevStartDate.setDate(prevEndDate.getDate() - periodLength);
      
      // Filter cashbills for current and previous periods
      const currentCashbills = cashbills.filter(bill => {
        const billDate = new Date(bill.date);
        return billDate >= startDate && billDate <= endDate && bill.status === 'committed';
      });
      
      const prevCashbills = cashbills.filter(bill => {
        const billDate = new Date(bill.date);
        return billDate >= prevStartDate && billDate < prevEndDate && bill.status === 'committed';
      });
      
      // Calculate metrics
      const currentRevenue = currentCashbills.reduce((sum, bill) => sum + (bill.grandTotal || 0), 0);
      const prevRevenue = prevCashbills.reduce((sum, bill) => sum + (bill.grandTotal || 0), 0);
      const revenueChange = prevRevenue > 0 ? ((currentRevenue - prevRevenue) / prevRevenue * 100) : 0;
      
      const currentCashbillsCount = currentCashbills.length;
      const prevCashbillsCount = prevCashbills.length;
      const cashbillsChange = prevCashbillsCount > 0 ? ((currentCashbillsCount - prevCashbillsCount) / prevCashbillsCount * 100) : 0;
      
      // Calculate active users
      const activeUsers = new Set(currentCashbills.map(bill => bill.userId));
      const prevActiveUsers = new Set(prevCashbills.map(bill => bill.userId));
      const usersChange = prevActiveUsers.size > 0 ? (activeUsers.size - prevActiveUsers.size) : 0;
      
      // Calculate completion rate
      const allCurrentCashbills = cashbills.filter(bill => {
        const billDate = new Date(bill.date);
        return billDate >= startDate && billDate <= endDate;
      });
      const completionRate = allCurrentCashbills.length > 0 ? 
        (currentCashbillsCount / allCurrentCashbills.length * 100) : 0;
      
      const allPrevCashbills = cashbills.filter(bill => {
        const billDate = new Date(bill.date);
        return billDate >= prevStartDate && billDate < prevEndDate;
      });
      const prevCompletionRate = allPrevCashbills.length > 0 ? 
        (prevCashbillsCount / allPrevCashbills.length * 100) : 0;
      const completionChange = prevCompletionRate > 0 ? ((completionRate - prevCompletionRate) / prevCompletionRate * 100) : 0;
      
      // Update summary cards based on metric
      switch(metric) {
        case 'revenue':
          document.getElementById('summaryValue1').textContent = systemSettings.currency + currentRevenue.toFixed(0);
          document.getElementById('summaryLabel1').textContent = 'Total Revenue';
          document.getElementById('summaryChange1').textContent = 
            (revenueChange >= 0 ? '+' : '') + revenueChange.toFixed(1) + '%';
          document.getElementById('summaryChange1').className = 
            'analytics-summary-change ' + (revenueChange >= 0 ? 'positive' : 'negative');
          
          document.getElementById('summaryValue2').textContent = currentCashbillsCount;
          document.getElementById('summaryLabel2').textContent = 'Cashbills';
          document.getElementById('summaryChange2').textContent = 
            (cashbillsChange >= 0 ? '+' : '') + cashbillsChange.toFixed(1) + '%';
          document.getElementById('summaryChange2').className = 
            'analytics-summary-change ' + (cashbillsChange >= 0 ? 'positive' : 'negative');
          break;
          
        case 'cashbills':
          document.getElementById('summaryValue1').textContent = currentCashbillsCount;
          document.getElementById('summaryLabel1').textContent = 'Total Cashbills';
          document.getElementById('summaryChange1').textContent = 
            (cashbillsChange >= 0 ? '+' : '') + cashbillsChange.toFixed(1) + '%';
          document.getElementById('summaryChange1').className = 
            'analytics-summary-change ' + (cashbillsChange >= 0 ? 'positive' : 'negative');
          
          document.getElementById('summaryValue2').textContent = completionRate.toFixed(1) + '%';
          document.getElementById('summaryLabel2').textContent = 'Completion Rate';
          document.getElementById('summaryChange2').textContent = 
            (completionChange >= 0 ? '+' : '') + completionChange.toFixed(1) + '%';
          document.getElementById('summaryChange2').className = 
            'analytics-summary-change ' + (completionChange >= 0 ? 'positive' : 'negative');
          break;
          
        case 'users':
          document.getElementById('summaryValue1').textContent = activeUsers.size;
          document.getElementById('summaryLabel1').textContent = 'Active Users';
          document.getElementById('summaryChange1').textContent = 
            (usersChange >= 0 ? '+' : '') + usersChange;
          document.getElementById('summaryChange1').className = 
            'analytics-summary-change ' + (usersChange >= 0 ? 'positive' : 'negative');
          
          const avgActivities = currentCashbills.length / activeUsers.size || 0;
          document.getElementById('summaryValue2').textContent = avgActivities.toFixed(1);
          document.getElementById('summaryLabel2').textContent = 'Avg Activities/User';
          document.getElementById('summaryChange2').textContent = '';
          break;
          
        case 'items':
          const totalItems = currentCashbills.reduce((sum, bill) => {
            if (bill.items && Array.isArray(bill.items)) {
              return sum + bill.items.reduce((itemSum, item) => itemSum + item.quantity, 0);
            }
            return sum;
          }, 0);
          
          document.getElementById('summaryValue1').textContent = totalItems;
          document.getElementById('summaryLabel1').textContent = 'Items Sold';
          document.getElementById('summaryChange1').textContent = '';
          
          const avgItemsPerCashbill = currentCashbillsCount > 0 ? totalItems / currentCashbillsCount : 0;
          document.getElementById('summaryValue2').textContent = avgItemsPerCashbill.toFixed(1);
          document.getElementById('summaryLabel2').textContent = 'Avg Items/Cashbill';
          document.getElementById('summaryChange2').textContent = '';
          break;
          
        case 'payments':
          document.getElementById('summaryValue1').textContent = systemSettings.currency + currentRevenue.toFixed(0);
          document.getElementById('summaryLabel1').textContent = 'Total Revenue';
          document.getElementById('summaryChange1').textContent = 
            (revenueChange >= 0 ? '+' : '') + revenueChange.toFixed(1) + '%';
          document.getElementById('summaryChange1').className = 
            'analytics-summary-change ' + (revenueChange >= 0 ? 'positive' : 'negative');
          
          // Most used payment method
          const paymentMethods = {};
          currentCashbills.forEach(bill => {
            const method = getPaymentMethodDisplayName(bill.paymentMethod);
            paymentMethods[method] = (paymentMethods[method] || 0) + 1;
          });
          
          const mostUsedMethod = Object.entries(paymentMethods)
            .sort((a, b) => b[1] - a[1])[0];
          
          document.getElementById('summaryValue2').textContent = mostUsedMethod ? mostUsedMethod[0] : 'N/A';
          document.getElementById('summaryLabel2').textContent = 'Most Used Method';
          document.getElementById('summaryChange2').textContent = '';
          break;
          
        case 'performance':
          document.getElementById('summaryValue1').textContent = completionRate.toFixed(1) + '%';
          document.getElementById('summaryLabel1').textContent = 'Completion Rate';
          document.getElementById('summaryChange1').textContent = 
            (completionChange >= 0 ? '+' : '') + completionChange.toFixed(1) + '%';
          document.getElementById('summaryChange1').className = 
            'analytics-summary-change ' + (completionChange >= 0 ? 'positive' : 'negative');
          
          document.getElementById('summaryValue2').textContent = activeUsers.size;
          document.getElementById('summaryLabel2').textContent = 'Active Users';
          document.getElementById('summaryChange2').textContent = 
            (usersChange >= 0 ? '+' : '') + usersChange;
          document.getElementById('summaryChange2').className = 
            'analytics-summary-change ' + (usersChange >= 0 ? 'positive' : 'negative');
          break;
      }
      
      // Always show active users and completion rate in cards 3 and 4
      document.getElementById('summaryValue3').textContent = activeUsers.size;
      document.getElementById('summaryLabel3').textContent = 'Active Users';
      document.getElementById('summaryChange3').textContent = 
        (usersChange >= 0 ? '+' : '') + usersChange;
      document.getElementById('summaryChange3').className = 
        'analytics-summary-change ' + (usersChange >= 0 ? 'positive' : 'negative');
      
      document.getElementById('summaryValue4').textContent = completionRate.toFixed(1) + '%';
      document.getElementById('summaryLabel4').textContent = 'Completion Rate';
      document.getElementById('summaryChange4').textContent = 
        (completionChange >= 0 ? '+' : '') + completionChange.toFixed(1) + '%';
      document.getElementById('summaryChange4').className = 
        'analytics-summary-change ' + (completionChange >= 0 ? 'positive' : 'negative');
    }
    
    // Refresh analytics
    function refreshAnalytics() {
      initializeAnalytics();
    }
    
    // Export analytics as PDF
    function exportAnalyticsPDF() {
      alert('PDF export functionality would be implemented here using a PDF generation library like jsPDF.');
    }
    
    // Export analytics as CSV
    function exportAnalyticsCSV() {
      if (!analyticsData.data) {
        alert('No data to export. Please generate analytics first.');
        return;
      }
      
      let csv = '';
      
      if (analyticsData.chartType === 'line' || analyticsData.chartType === 'bar') {
        // Time series data
        csv = 'Date,' + analyticsData.data.datasets.map(ds => ds.label).join(',') + '\n';
        
        analyticsData.data.labels.forEach((label, index) => {
          let row = label;
          analyticsData.data.datasets.forEach(dataset => {
            row += ',' + (dataset.data[index] || 0);
          });
          csv += row + '\n';
        });
      } else {
        // Categorical data
        csv = 'Category,Value\n';
        analyticsData.data.labels.forEach((label, index) => {
          csv += label + ',' + analyticsData.data.datasets[0].data[index] + '\n';
        });
      }
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `analytics_${analyticsData.metric}_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      // Log activity
      logActivity(currentUser.id, currentUser.name, 'Export Data', `Exported ${analyticsData.metric} analytics to CSV`);
    }
    
    // Export analytics as Image
    function exportAnalyticsImage() {
      if (!analyticsChart) {
        alert('No chart to export. Please generate analytics first.');
        return;
      }
      
      const canvas = document.getElementById('analyticsChart');
      const url = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url;
      a.download = `analytics_${analyticsData.metric}_${new Date().toISOString().split('T')[0]}.png`;
      a.click();
      
      // Log activity
      logActivity(currentUser.id, currentUser.name, 'Export Data', `Exported ${analyticsData.metric} analytics as image`);
    }
    
    // Export analytics as JSON
    function exportAnalyticsJSON() {
      if (!analyticsData.data) {
        alert('No data to export. Please generate analytics first.');
        return;
      }
      
      const exportData = {
        metadata: {
          period: analyticsData.period,
          startDate: analyticsData.startDate.toISOString(),
          endDate: analyticsData.endDate.toISOString(),
          metric: analyticsData.metric,
          chartType: analyticsData.chartType,
          generatedAt: new Date().toISOString()
        },
        data: analyticsData.data
      };
      
      const dataStr = JSON.stringify(exportData, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const a = document.createElement('a');
      a.href = dataUri;
      a.download = `analytics_${analyticsData.metric}_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      // Log activity
      logActivity(currentUser.id, currentUser.name, 'Export Data', `Exported ${analyticsData.metric} analytics to JSON`);
    }
    
    // Initialize analytics when modal is opened
    document.getElementById('dataAnalyticsModal').addEventListener('shown.bs.modal', function() {
      initializeAnalytics();
    });
    
    // Handle period change
    document.getElementById('analyticsPeriodModal').addEventListener('change', function() {
      const customDateRange = document.getElementById('customDateRange');
      if (this.value === 'custom') {
        customDateRange.style.display = 'flex';
        // Set default dates
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - 30);
        
        document.getElementById('analyticsDateFrom').value = startDate.toISOString().split('T')[0];
        document.getElementById('analyticsDateTo').value = endDate.toISOString().split('T')[0];
      } else {
        customDateRange.style.display = 'none';
      }
      initializeAnalytics();
    });
    
    // Handle date change for custom range
    document.getElementById('analyticsDateFrom').addEventListener('change', initializeAnalytics);
    document.getElementById('analyticsDateTo').addEventListener('change', initializeAnalytics);
    
    // Handle chart type and metric change
    document.getElementById('analyticsChartType').addEventListener('change', initializeAnalytics);
    document.getElementById('analyticsMetric').addEventListener('change', initializeAnalytics);
    
    // Generate analytics report
    function generateAnalyticsReport() {
      // In a real application, this would generate a detailed analytics report
      alert('Analytics report would be generated here with detailed insights.');
    }
    
    // Convert array to CSV
    function convertToCSV(arr) {
      const array = [Object.keys(arr[0])].concat(arr);
      return array.map(row => {
        return Object.values(row).map(String).map(val => {
          return `"${val.replace(/"/g, '""')}"`;
        }).join(',');
      }).join('\n');
    }
    
    // Show add user modal
    function showAddUserModal() {
      document.getElementById('addUserModal').style.display = 'flex';
    }
    
    // Close add user modal
    function closeAddUserModal() {
      document.getElementById('addUserModal').style.display = 'none';
      document.getElementById('addUserForm').reset();
    }
    
    // Add user form submission
    document.getElementById('addUserForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const userId = document.getElementById('newUserId').value;
      const userName = document.getElementById('newUserName').value;
      const userRole = document.getElementById('newUserRole').value;
      const password = document.getElementById('newUserPassword').value;
      const confirmPassword = document.getElementById('newUserConfirmPassword').value;
      
      if (password !== confirmPassword) {
        alert('Passwords do not match');
        return;
      }
      
      // Check if user ID already exists
      if (users.some(u => u.id === userId)) {
        alert('User ID already exists');
        return;
      }
      
      const newUser = {
        id: userId,
        name: userName,
        role: userRole,
        password: password
      };
      
      try {
        // Add to server
        const response = await fetch(`${API_URL}?action=add&sheet=users&data=${encodeURIComponent(JSON.stringify(newUser))}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        
        if (result.success) {
          // Update local cache
          users.push(newUser);
          
          // Log activity
          logActivity(currentUser.id, currentUser.name, 'Add User', `Added new user: ${userName} (${userId})`);
          
          // Close modal and refresh user table
          closeAddUserModal();
          updateUserTable();
          
          alert('User added successfully!');
        } else {
          throw new Error(result.error || "Unknown error");
        }
      } catch (error) {
        console.error("Error adding user:", error);
        alert("Error adding user. Please try again.");
      }
    });
    
    // Show user permissions modal
    function showUserPermissionsModal() {
      document.getElementById('userPermissionsModal').style.display = 'flex';
      
      // Populate user dropdown
      const userSelect = document.getElementById('permissionUser');
      userSelect.innerHTML = '<option value="">Select a user</option>';
      
      users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = `${user.name} (${user.id})`;
        userSelect.appendChild(option);
      });
      
      // Populate role list
      const roleList = document.getElementById('roleList');
      roleList.innerHTML = '';
      
      users.forEach(user => {
        const roleItem = document.createElement('div');
        roleItem.className = 'permission-role-item';
        roleItem.innerHTML = `
          <i class="fas fa-${getRoleIcon(user.role)}"></i>
          <span>${user.name} (${getRoleDisplayName(user.role)})</span>
        `;
        roleItem.onclick = function() {
          document.getElementById('permissionUser').value = user.id;
          loadUserPermissions();
          
          // Update active state
          document.querySelectorAll('.permission-role-item').forEach(item => {
            item.classList.remove('active');
          });
          this.classList.add('active');
        };
        roleList.appendChild(roleItem);
      });
    }
    
    // Close user permissions modal
    function closeUserPermissionsModal() {
      document.getElementById('userPermissionsModal').style.display = 'none';
    }
    
    // Get role icon
    function getRoleIcon(role) {
      switch(role) {
        case 'admin': return 'user-shield';
        case 'director': return 'user-tie';
        case 'marketing': return 'user-tag';
        case 'crew': return 'user';
        default: return 'user';
      }
    }
    
    // Load user permissions
    function loadUserPermissions() {
      const userId = document.getElementById('permissionUser').value;
      if (!userId) return;
      
      const user = users.find(u => u.id === userId);
      if (!user) return;
      
      const permissionsContainer = document.getElementById('permissionsContainer');
      
      // Define permissions based on role
      const rolePermissions = {
        crew: ['Create Cashbills', 'View Own Cashbills', 'Save Drafts'],
        marketing: ['Create Cashbills', 'View Own Cashbills', 'Save Drafts', 'View Reports'],
        director: ['Create Cashbills', 'View All Cashbills', 'Save Drafts', 'View Reports', 'Edit Own Cashbills'],
        admin: ['Create Cashbills', 'View All Cashbills', 'Save Drafts', 'View Reports', 'Edit All Cashbills', 'Delete Cashbills', 'Manage Users', 'System Settings']
      };
      
      let html = `<h4>Permissions for ${user.name} (${user.role})</h4>`;
      html += '<div style="margin-top: 1rem;">';
      
      const permissions = rolePermissions[user.role] || [];
      permissions.forEach(permission => {
        html += `
          <div class="permission-item">
            <input type="checkbox" id="perm_${permission}" checked disabled>
            <label for="perm_${permission}">${permission}</label>
          </div>
        `;
      });
      
      html += '</div>';
      permissionsContainer.innerHTML = html;
    }
    
    // Save user permissions
    function saveUserPermissions() {
      alert('Permissions saved successfully!');
      closeUserPermissionsModal();
    }
    
    // Show user activity modal
    function showUserActivityModal() {
      document.getElementById('userActivityModal').style.display = 'flex';
      
      // Populate user dropdown
      const userSelect = document.getElementById('activityUser');
      userSelect.innerHTML = '<option value="">Select a user</option>';
      
      users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = `${user.name} (${user.id})`;
        userSelect.appendChild(option);
      });
    }
    
    // Close user activity modal
    function closeUserActivityModal() {
      document.getElementById('userActivityModal').style.display = 'none';
    }
    
    // Load user activity
    function loadUserActivity() {
      const userId = document.getElementById('activityUser').value;
      if (!userId) return;
      
      const user = users.find(u => u.id === userId);
      if (!user) return;
      
      const activityContainer = document.getElementById('userActivityContainer');
      
      // Get user's activity
      const userActivity = activityLog.filter(log => log.userId === userId);
      
      if (userActivity.length === 0) {
        activityContainer.innerHTML = '<p>No activity found for this user.</p>';
        return;
      }
      
      // Calculate statistics
      const cashbillsCreated = userActivity.filter(log => log.action === 'Create Cashbill').length;
      const loginsCount = userActivity.filter(log => log.action === 'Login').length;
      const lastActivity = userActivity[0].timestamp;
      
      let html = `
        <div class="user-activity-summary">
          <div class="activity-summary-card">
            <div class="activity-summary-value">${cashbillsCreated}</div>
            <div class="activity-summary-label">Cashbills Created</div>
          </div>
          <div class="activity-summary-card">
            <div class="activity-summary-value">${loginsCount}</div>
            <div class="activity-summary-label">Logins</div>
          </div>
          <div class="activity-summary-card">
            <div class="activity-summary-value">${new Date(lastActivity).toLocaleDateString()}</div>
            <div class="activity-summary-label">Last Activity</div>
          </div>
        </div>
        
        <h4>Activity Timeline</h4>
        <div class="user-activity-timeline">
      `;
      
      userActivity.slice(0, 20).forEach(activity => {
        const date = new Date(activity.timestamp);
        const formattedDate = date.toLocaleDateString();
        const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        html += `
          <div class="timeline-item">
            <div class="timeline-content">
              <div class="timeline-action">${activity.action}</div>
              <div class="timeline-details">${activity.details || ''}</div>
              <div class="timeline-time">${formattedDate} at ${formattedTime}</div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      activityContainer.innerHTML = html;
    }
    
    // Save security settings
    function saveSecuritySettings() {
      const sessionTimeout = document.getElementById('sessionTimeout').value;
      const maxLoginAttempts = document.getElementById('maxLoginAttempts').value;
      
      // In a real application, these would be saved to the server
      alert(`Security settings saved:\nSession Timeout: ${sessionTimeout} minutes\nMax Login Attempts: ${maxLoginAttempts}`);
      
      // Log activity
      logActivity(currentUser.id, currentUser.name, 'Update Security Settings', 'Updated system security configuration');
    }
    
    // Update user table
    function updateUserTable() {
      // Update total users count
      document.getElementById('totalUsersCount').textContent = users.length;
      document.getElementById('activeUsersInfo').textContent = users.length;
      document.getElementById('activeUsersCount').textContent = users.length;
    }
    
    // Update cashbill list page
    function updateCashbillListPage() {
      const cashbillListContent = document.getElementById('cashbillListContent');
      
      // Sort cashbills by date (latest first)
      const sortedCashbills = [...filteredCashbills].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      if (sortedCashbills.length === 0) {
        cashbillListContent.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3>No cashbills found</h3>
            <p>Create your first cashbill to see them here.</p>
          </div>
        `;
        document.getElementById('pagination').innerHTML = '';
        return;
      }
      
      // Pagination
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedCashbills = sortedCashbills.slice(startIndex, endIndex);
      
      let tableHTML = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Invoice #</th>
                <th>Customer</th>
                <th>User</th>
                <th>Date</th>
                <th>Total</th>
                <th>Payment</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      paginatedCashbills.forEach(bill => {
        // Use userName if available, otherwise fall back to finding user by ID
        const userName = bill.userName || (users.find(u => u.id === bill.userId)?.name || 'Unknown');
        const canEdit = currentUser.role === 'admin' || bill.userId === currentUser.id;
        const totalAmount = bill.grandTotal || 0;
        
        let actionsHTML = '';
        
        // For committed cashbills, crew members see "No permission"
        if (bill.status === 'committed' && currentUser.role === 'crew') {
          actionsHTML = '<span class="permission-denied"><i class="fas fa-lock"></i> No permission</span>';
        } else if (canEdit) {
          actionsHTML = `
            <button class="btn-edit" onclick="editCashbill(${bill.id})"><i class="fas fa-edit"></i> Edit</button>
            <button class="btn-delete" onclick="confirmDeleteCashbill(${bill.id})"><i class="fas fa-trash"></i> Delete</button>
          `;
        }
        
        // Add view button for all cashbills
        if (actionsHTML) {
          actionsHTML += `<button class="btn-view" onclick="viewCashbill(${bill.id})"><i class="fas fa-eye"></i> View</button>`;
        } else {
          actionsHTML = `<button class="btn-view" onclick="viewCashbill(${bill.id})"><i class="fas fa-eye"></i> View</button>`;
        }
        
        tableHTML += `
          <tr>
            <td>${bill.invoiceNumber}</td>
            <td>${bill.customerName}</td>
            <td>${userName}</td>
            <td>${new Date(bill.date).toLocaleDateString()}</td>
            <td>${systemSettings.currency}${totalAmount.toFixed(2)}</td>
            <td>${getPaymentMethodDisplayName(bill.paymentMethod)}</td>
            <td>${bill.status === 'draft' ? 'Draft' : bill.status === 'pending' ? 'Pending' : 'Committed'}</td>
            <td>${actionsHTML}</td>
          </tr>
        `;
      });
      
      tableHTML += `
            </tbody>
          </table>
        </div>
      `;
      
      cashbillListContent.innerHTML = tableHTML;
      
      // Update pagination
      updatePagination(sortedCashbills.length);
    }
    
    // View cashbill details
    function viewCashbill(id) {
      const cashbill = cashbills.find(bill => bill.id === id);
      if (!cashbill) return;
      
      currentViewingCashbill = cashbill;
      
      // Populate cashbill view page
      document.getElementById('viewInvoiceNumber').textContent = cashbill.invoiceNumber + 
        (cashbill.status === 'draft' ? ' <span class="draft-indicator">Draft</span>' : 
         cashbill.status === 'pending' ? ' <span class="pending-indicator">Pending</span>' : ' <span class="committed-indicator">Committed</span>');
      document.getElementById('viewCustomerName').textContent = cashbill.customerName;
      document.getElementById('viewDate').textContent = new Date(cashbill.date).toLocaleDateString();
      document.getElementById('viewStatus').textContent = cashbill.status === 'draft' ? 'Draft' : cashbill.status === 'pending' ? 'Pending' : 'Committed';
      document.getElementById('viewPaymentMethod').textContent = getPaymentMethodDisplayName(cashbill.paymentMethod);
      
      // Use userName if available, otherwise fall back to finding user by ID
      const userName = cashbill.userName || (users.find(u => u.id === cashbill.userId)?.name || 'Unknown');
      document.getElementById('viewCreatedBy').textContent = userName;
      
      // Populate items table
      const itemsTableBody = document.getElementById('viewItemsTableBody');
      let itemsHTML = '';
      
      cashbill.items.forEach(item => {
        const itemTotal = item.quantity * item.unitPrice;
        const itemTax = itemTotal * (item.taxRate / 100);
        const itemTotalWithTax = itemTotal + itemTax - item.discount;
        
        itemsHTML += `
          <tr>
            <td>${item.description}</td>
            <td>${item.quantity}</td>
            <td>${systemSettings.currency}${item.unitPrice.toFixed(2)}</td>
            <td>${item.taxRate}%</td>
            <td>${systemSettings.currency}${item.discount.toFixed(2)}</td>
            <td>${systemSettings.currency}${itemTotalWithTax.toFixed(2)}</td>
          </tr>
        `;
      });
      
      itemsTableBody.innerHTML = itemsHTML;
      
      // Update summary
      document.getElementById('viewSubtotal').textContent = `${systemSettings.currency}${cashbill.subtotal.toFixed(2)}`;
      document.getElementById('viewTotalTax').textContent = `${systemSettings.currency}${cashbill.totalTax.toFixed(2)}`;
      document.getElementById('viewTotalDiscount').textContent = `${systemSettings.currency}${cashbill.totalDiscount.toFixed(2)}`;
      document.getElementById('viewGrandTotal').textContent = `${systemSettings.currency}${cashbill.grandTotal.toFixed(2)}`;
      
      // Show/hide notes
      const notesCard = document.getElementById('viewNotesCard');
      if (cashbill.notes) {
        document.getElementById('viewNotes').textContent = cashbill.notes;
        notesCard.style.display = 'block';
      } else {
        notesCard.style.display = 'none';
      }
      
      // Navigate to cashbill view page
      showPage('cashbillViewPage');
    }
    
    // Edit cashbill from view page
    function editCashbillFromView() {
      if (currentViewingCashbill) {
        editCashbill(currentViewingCashbill.id);
      }
    }
    
    // Update pagination
    function updatePagination(totalItems) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      let paginationHTML = '';
      
      if (totalPages > 1) {
        paginationHTML += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i> Previous</button>`;
        
        for (let i = 1; i <= totalPages; i++) {
          paginationHTML += `<button onclick="changePage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
        }
        
        paginationHTML += `<button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next <i class="fas fa-chevron-right"></i></button>`;
      }
      
      document.getElementById('pagination').innerHTML = paginationHTML;
    }
    
    // Change page
    function changePage(page) {
      const totalPages = Math.ceil(filteredCashbills.length / itemsPerPage);
      
      if (page < 1 || page > totalPages) return;
      
      currentPage = page;
      updateCashbillListPage();
    }
    
    // Apply filters
    function applyFilters() {
      showLoading();
      
      const searchCustomer = document.getElementById('searchCustomer').value.toLowerCase();
      const filterStatus = document.getElementById('filterStatus').value;
      const filterPayment = document.getElementById('filterPayment').value;
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      
      filteredCashbills = cashbills.filter(bill => {
        // Customer name filter
        if (searchCustomer && !bill.customerName.toLowerCase().includes(searchCustomer)) {
          return false;
        }
        
        // Status filter
        if (filterStatus && bill.status !== filterStatus) {
          return false;
        }
        
        // Payment method filter
        if (filterPayment && bill.paymentMethod !== filterPayment) {
          return false;
        }
        
        // Date range filter
        const billDate = new Date(bill.date).toISOString().split('T')[0];
        if (dateFrom && billDate < dateFrom) {
          return false;
        }
        if (dateTo && billDate > dateTo) {
          return false;
        }
        
        return true;
      });
      
      currentPage = 1;
      updateCashbillListPage();
      hideLoading();
    }
    
    // Reset filters
    function resetFilters() {
      document.getElementById('searchCustomer').value = '';
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterPayment').value = '';
      document.getElementById('dateFrom').value = '';
      document.getElementById('dateTo').value = '';
      
      filteredCashbills = [...cashbills];
      currentPage = 1;
      updateCashbillListPage();
    }
    
    // Export to CSV
    function exportToCSV() {
      showLoading();
      
      let csv = 'Invoice Number,Customer,User,Date,Subtotal,Tax,Discount,Total,Payment Method,Status\n';
      
      filteredCashbills.forEach(bill => {
        const user = users.find(u => u.id === bill.userId);
        csv += `${bill.invoiceNumber},"${bill.customerName}",${user ? user.name : 'Unknown'},${new Date(bill.date).toLocaleDateString()},${(bill.subtotal || 0).toFixed(2)},${(bill.totalTax || 0).toFixed(2)},${(bill.totalDiscount || 0).toFixed(2)},${(bill.grandTotal || 0).toFixed(2)},${getPaymentMethodDisplayName(bill.paymentMethod)},${bill.status === 'draft' ? 'Draft' : bill.status === 'pending' ? 'Pending' : 'Committed'}\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `cashbills_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      // Log activity
      logActivity(currentUser.id, currentUser.name, 'Export Data', 'Exported cashbills to CSV');
      
      hideLoading();
    }
    
    // Generate cashbill PDF
    function generateCashbillPDF() {
      if (!currentViewingCashbill) {
        alert('No cashbill selected for PDF generation');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Set up document properties
      doc.setProperties({
        title: `Cashbill ${currentViewingCashbill.invoiceNumber}`,
        subject: 'Cashbill',
        author: systemSettings.companyName,
        creator: 'PNE ARENA System'
      });
      
      // Add company header
      doc.setFontSize(18);
      doc.setFont(undefined, 'bold');
      doc.text(systemSettings.companyName, 105, 20, { align: 'center' });
      
      // Add invoice title
      doc.setFontSize(14);
      doc.text('CASHBILL', 105, 30, { align: 'center' });
      
      // Add invoice number
      doc.setFontSize(12);
      doc.text(`Invoice No: ${currentViewingCashbill.invoiceNumber}`, 20, 45);
      
      // Add date
      const date = new Date(currentViewingCashbill.date);
      doc.text(`Date: ${date.toLocaleDateString()}`, 20, 52);
      
      // Add customer info
      doc.text('Bill To:', 20, 65);
      doc.setFont(undefined, 'normal');
      doc.text(currentViewingCashbill.customerName, 20, 72);
      
      // Add payment method and status
      doc.setFont(undefined, 'bold');
      doc.text(`Payment Method: ${getPaymentMethodDisplayName(currentViewingCashbill.paymentMethod)}`, 20, 85);
      doc.text(`Status: ${currentViewingCashbill.status === 'draft' ? 'Draft' : currentViewingCashbill.status === 'pending' ? 'Pending' : 'Committed'}`, 20, 92);
      
      // Add items table header
      doc.setFont(undefined, 'bold');
      doc.text('Items:', 20, 105);
      
      // Table headers
      const headers = ['Description', 'Qty', 'Unit Price', 'Tax %', 'Discount', 'Total'];
      const headerPositions = [20, 80, 110, 140, 160, 180];
      
      doc.setFontSize(10);
      headers.forEach((header, i) => {
        doc.text(header, headerPositions[i], 115);
      });
      
      // Add separator line
      doc.setLineWidth(0.5);
      doc.line(20, 120, 190, 120);
      
      // Add items
      let yPos = 128;
      doc.setFont(undefined, 'normal');
      
      currentViewingCashbill.items.forEach(item => {
        const itemTotal = item.quantity * item.unitPrice;
        const itemTax = itemTotal * (item.taxRate / 100);
        const itemTotalWithTax = itemTotal + itemTax - item.discount;
        
        // Check if we need a new page
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
        
        // Add item row
        doc.text(item.description, 20, yPos);
        doc.text(item.quantity.toString(), headerPositions[1], yPos);
        doc.text(`${systemSettings.currency}${item.unitPrice.toFixed(2)}`, headerPositions[2], yPos);
        doc.text(item.taxRate.toString(), headerPositions[3], yPos);
        doc.text(`${systemSettings.currency}${item.discount.toFixed(2)}`, headerPositions[4], yPos);
        doc.text(`${systemSettings.currency}${itemTotalWithTax.toFixed(2)}`, headerPositions[5], yPos);
        
        yPos += 8;
      });
      
      // Add totals
      yPos += 10;
      doc.setLineWidth(0.5);
      doc.line(20, yPos, 190, yPos);
      yPos += 10;
      
      doc.setFont(undefined, 'bold');
      doc.text('Subtotal:', 140, yPos);
      doc.text(`${systemSettings.currency}${currentViewingCashbill.subtotal.toFixed(2)}`, 160, yPos, { align: 'right' });
      yPos += 8;
      
      doc.text('Tax:', 140, yPos);
      doc.text(`${systemSettings.currency}${currentViewingCashbill.totalTax.toFixed(2)}`, 160, yPos, { align: 'right' });
      yPos += 8;
      
      doc.text('Discount:', 140, yPos);
      doc.text(`${systemSettings.currency}${currentViewingCashbill.totalDiscount.toFixed(2)}`, 160, yPos, { align: 'right' });
      yPos += 8;
      
      doc.setFontSize(12);
      doc.text('Total:', 140, yPos);
      doc.text(`${systemSettings.currency}${currentViewingCashbill.grandTotal.toFixed(2)}`, 160, yPos, { align: 'right' });
      
      // Add notes if any
      if (currentViewingCashbill.notes) {
        yPos += 20;
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text('Notes:', 20, yPos);
        yPos += 8;
        doc.setFont(undefined, 'normal');
        doc.text(currentViewingCashbill.notes, 20, yPos);
      }
      
      // Add footer
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.text(`Generated by ${systemSettings.companyName} System`, 105, 285, { align: 'center' });
        doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
      }
      
      // Save the PDF
      doc.save(`${currentViewingCashbill.invoiceNumber.replace('#', '')}.pdf`);
      
      // Log activity
      logActivity(currentUser.id, currentUser.name, 'Export Data', `Generated PDF for cashbill ${currentViewingCashbill.invoiceNumber}`);
    }
    
    // Edit cashbill
    function editCashbill(id) {
      const cashbill = cashbills.find(bill => bill.id === id);
      if (!cashbill) return;
      
      // Check if crew member is trying to edit a committed cashbill
      if (currentUser.role === 'crew' && cashbill.status === 'committed') {
        alert('Crew members cannot edit committed cashbills.');
        return;
      }
      
      // Populate edit form
      document.getElementById('editCashbillId').value = cashbill.id;
      document.getElementById('editCustomerName').value = cashbill.customerName;
      document.getElementById('editPaymentMethod').value = cashbill.paymentMethod;
      document.getElementById('editStatus').value = cashbill.status;
      document.getElementById('editNotes').value = cashbill.notes || '';
      
      // Populate items
      const itemsContainer = document.getElementById('editItemsContainer');
      itemsContainer.innerHTML = '';
      
      cashbill.items.forEach((item, index) => {
        const itemRow = document.createElement('div');
        itemRow.className = 'edit-item-row';
        itemRow.innerHTML = `
          <div class="form-group">
            <label>Description</label>
            <input type="text" class="edit-item-description" value="${item.description}" required placeholder="Item description">
          </div>
          <div class="form-group">
            <label>Quantity</label>
            <input type="number" class="edit-item-quantity" min="1" value="${item.quantity}" required>
          </div>
          <div class="form-group">
            <label>Unit Price (RM)</label>
            <input type="number" class="edit-item-price" step="0.01" min="0" value="${item.unitPrice}" required placeholder="0.00">
          </div>
          <div class="form-group">
            <label>Tax (%)</label>
            <input type="number" class="edit-item-tax" step="0.01" min="0" value="${item.taxRate}" placeholder="0">
          </div>
          <div class="form-group">
            <label>Discount (RM)</label>
            <input type="number" class="edit-item-discount" step="0.01" min="0" value="${item.discount}" placeholder="0">
          </div>
          <div>
            <button type="button" class="remove-item-btn" onclick="removeEditItem(this)"><i class="fas fa-trash"></i> Remove</button>
          </div>
        `;
        itemsContainer.appendChild(itemRow);
      });
      
      // Add event listeners to calculate totals
      document.querySelectorAll('.edit-item-row input').forEach(input => {
        input.addEventListener('input', calculateEditTotals);
      });
      
      // Calculate initial totals
      calculateEditTotals();
      
      document.getElementById('editModal').style.display = 'flex';
    }
    
    // Add item to edit form
    function addEditItem() {
      const itemsContainer = document.getElementById('editItemsContainer');
      const newItem = document.createElement('div');
      newItem.className = 'edit-item-row';
      newItem.innerHTML = `
        <div class="form-group">
          <label>Description</label>
          <input type="text" class="edit-item-description" required placeholder="Item description">
        </div>
        <div class="form-group">
          <label>Quantity</label>
          <input type="number" class="edit-item-quantity" min="1" value="1" required>
        </div>
        <div class="form-group">
          <label>Unit Price (RM)</label>
          <input type="number" class="edit-item-price" step="0.01" min="0" required placeholder="0.00">
        </div>
        <div class="form-group">
          <label>Tax (%)</label>
          <input type="number" class="edit-item-tax" step="0.01" min="0" value="0" placeholder="0">
        </div>
        <div class="form-group">
          <label>Discount (RM)</label>
          <input type="number" class="edit-item-discount" step="0.01" min="0" value="0" placeholder="0">
        </div>
        <div>
          <button type="button" class="remove-item-btn" onclick="removeEditItem(this)"><i class="fas fa-trash"></i> Remove</button>
        </div>
      `;
      itemsContainer.appendChild(newItem);
      
      // Add event listeners to calculate totals
      newItem.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', calculateEditTotals);
      });
    }
    
    // Remove item from edit form
    function removeEditItem(button) {
      const itemRow = button.closest('.edit-item-row');
      itemRow.remove();
      calculateEditTotals();
    }
    
    // Calculate edit totals
    function calculateEditTotals() {
      let subtotal = 0;
      let totalTax = 0;
      let totalDiscount = 0;
      
      document.querySelectorAll('.edit-item-row').forEach(row => {
        const quantity = parseFloat(row.querySelector('.edit-item-quantity').value) || 0;
        const price = parseFloat(row.querySelector('.edit-item-price').value) || 0;
        const taxRate = parseFloat(row.querySelector('.edit-item-tax').value) || 0;
        const discount = parseFloat(row.querySelector('.edit-item-discount').value) || 0;
        
        // Ensure all values are valid numbers
        if (!isNaN(quantity) && !isNaN(price) && !isNaN(taxRate) && !isNaN(discount)) {
          const itemTotal = quantity * price;
          const itemTax = itemTotal * (taxRate / 100);
          
          subtotal += itemTotal;
          totalTax += itemTax;
          totalDiscount += discount;
        }
      });
      
      const grandTotal = subtotal + totalTax - totalDiscount;
      
      // Update display with proper formatting
      document.getElementById('editSubtotal').textContent = `${systemSettings.currency}${subtotal.toFixed(2)}`;
      document.getElementById('editTotalTax').textContent = `${systemSettings.currency}${totalTax.toFixed(2)}`;
      document.getElementById('editTotalDiscount').textContent = `${systemSettings.currency}${totalDiscount.toFixed(2)}`;
      document.getElementById('editGrandTotal').textContent = `${systemSettings.currency}${grandTotal.toFixed(2)}`;
    }
    
    // Close edit modal
    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
    }
    
    // Edit cashbill form submission
    document.getElementById('editCashbillForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const id = parseInt(document.getElementById('editCashbillId').value);
      const customerName = document.getElementById('editCustomerName').value;
      const paymentMethod = document.getElementById('editPaymentMethod').value;
      const status = document.getElementById('editStatus').value;
      const notes = document.getElementById('editNotes').value;
      
      const cashbillIndex = cashbills.findIndex(bill => bill.id === id);
      if (cashbillIndex === -1) return;
      
      // Check if crew member is trying to commit a cashbill
      if (currentUser.role === 'crew' && status === 'committed' && cashbills[cashbillIndex].status === 'draft') {
        alert('Crew members cannot commit cashbills.');
        return;
      }
      
      // Get items
      const items = [];
      document.querySelectorAll('.edit-item-row').forEach(row => {
        const description = row.querySelector('.edit-item-description').value;
        const quantity = parseInt(row.querySelector('.edit-item-quantity').value) || 0;
        const unitPrice = parseFloat(row.querySelector('.edit-item-price').value) || 0;
        const taxRate = parseFloat(row.querySelector('.edit-item-tax').value) || 0;
        const discount = parseFloat(row.querySelector('.edit-item-discount').value) || 0;
        
        items.push({
          description, // Keep as user entered
          quantity,
          unitPrice,
          taxRate,
          discount
        });
      });
      
      // Calculate totals
      let subtotal = 0;
      let totalTax = 0;
      let totalDiscount = 0;
      
      items.forEach(item => {
        const itemTotal = item.quantity * item.unitPrice;
        const itemTax = itemTotal * (item.taxRate / 100);
        
        subtotal += itemTotal;
        totalTax += itemTax;
        totalDiscount += item.discount;
      });
      
      const grandTotal = subtotal + totalTax - totalDiscount;
      
      // Update cashbill
      const updatedCashbill = {
        customerName,
        paymentMethod,
        status,
        notes,
        items, // Keep as array for now
        subtotal,
        totalTax,
        totalDiscount,
        grandTotal
      };
      
      try {
        // Create a copy with serialized items for the server
        const serializedCashbill = {
          ...updatedCashbill,
          items: JSON.stringify(updatedCashbill.items) // Serialize items array to JSON string
        };
        
        // Update cashbill in server
        const response = await fetch(`${API_URL}?action=update&sheet=cashbills&id=${id}&data=${encodeURIComponent(JSON.stringify(serializedCashbill))}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        
        if (result.success) {
          // Update local cache
          cashbills[cashbillIndex] = {...cashbills[cashbillIndex], ...updatedCashbill};
          
          // Update filtered cache
          const filteredIndex = filteredCashbills.findIndex(bill => bill.id === id);
          if (filteredIndex !== -1) {
            filteredCashbills[filteredIndex] = {...filteredCashbills[filteredIndex], ...updatedCashbill};
          }
          
          // Log activity
          const actionText = status === 'committed' ? 'committed' : status === 'pending' ? 'marked as pending' : 'uncommitted';
          logActivity(currentUser.id, currentUser.name, 'Edit Cashbill', `${actionText} cashbill ${cashbills[cashbillIndex].invoiceNumber}`);
          
          closeEditModal();
          updateCashbillListPage();
          updateDashboardStats();
        } else {
          throw new Error(result.error || "Unknown error");
        }
      } catch (error) {
        console.error("Error updating cashbill:", error);
        alert("Error updating cashbill. Please try again.");
      }
    });
    
    // Confirm delete cashbill
    function confirmDeleteCashbill(id) {
      const cashbill = cashbills.find(bill => bill.id === id);
      if (!cashbill) return;
      
      // Check if crew member is trying to delete a committed cashbill
      if (currentUser.role === 'crew' && cashbill.status === 'committed') {
        alert('Crew members cannot delete committed cashbills.');
        return;
      }
      
      confirmedAction = () => deleteCashbill(id);
      document.getElementById('confirmTitle').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Confirm Delete';
      document.getElementById('confirmMessage').textContent = 'Are you sure you want to delete this cashbill? This action cannot be undone.';
      document.getElementById('confirmModal').style.display = 'flex';
    }
    
    // Delete cashbill
    async function deleteCashbill(id) {
      const cashbill = cashbills.find(bill => bill.id === id);
      if (!cashbill) return;
      
      // Check if crew member is trying to delete a committed cashbill
      if (currentUser.role === 'crew' && cashbill.status === 'committed') {
        alert('Crew members cannot delete committed cashbills.');
        return;
      }
      
      try {
        const response = await fetch(`${API_URL}?action=delete&sheet=cashbills&id=${id}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        
        if (result.success) {
          // Update local cache
          cashbills = cashbills.filter(bill => bill.id !== id);
          filteredCashbills = filteredCashbills.filter(bill => bill.id !== id);
          
          // Log activity
          logActivity(currentUser.id, currentUser.name, 'Delete Cashbill', `Deleted cashbill ${cashbill.invoiceNumber}`);
          
          updateCashbillListPage();
          updateDashboardStats();
          closeConfirmModal();
        } else {
          throw new Error(result.error || "Unknown error");
        }
      } catch (error) {
        console.error("Error deleting cashbill:", error);
        alert("Error deleting cashbill. Please try again.");
      }
    }
    
    // Confirm logout
    function confirmLogout() {
      confirmedAction = logout;
      document.getElementById('confirmTitle').innerHTML = '<i class="fas fa-sign-out-alt"></i> Confirm Logout';
      document.getElementById('confirmMessage').textContent = 'Are you sure you want to logout?';
      document.getElementById('confirmModal').style.display = 'flex';
    }
    
    // Logout function
    function logout() {
      if (currentUser) {
        logActivity(currentUser.id, currentUser.name, 'Logout', 'User logged out');
      }
      
      currentUser = null;
      showPage('loginPage');
      document.getElementById('loginForm').reset();
      closeConfirmModal();
    }
    
    // Close confirmation modal
    function closeConfirmModal() {
      document.getElementById('confirmModal').style.display = 'none';
      confirmedAction = null;
    }
    
    // Execute confirmed action
    function executeConfirmedAction() {
      if (confirmedAction) {
        confirmedAction();
      }
    }
    
    // Show loading spinner
    function showLoading() {
      document.getElementById('loadingSpinner').style.display = 'flex';
    }
    
    // Hide loading spinner
    function hideLoading() {
      document.getElementById('loadingSpinner').style.display = 'none';
    }
    
    // Update admin panel
    function updateAdminPanel() {
      // Update user table
      updateUserTable();
      
      // Update system logs
      updateSystemLogs();
      
      // Populate temporary access user dropdown
      const tempAccessUser = document.getElementById('tempAccessUser');
      if (tempAccessUser) {
        tempAccessUser.innerHTML = '<option value="">Select a user</option>';
        
        users.filter(u => u.role !== 'admin').forEach(user => {
          const option = document.createElement('option');
          option.value = user.id;
          option.textContent = `${user.name} (${user.id})`;
          tempAccessUser.appendChild(option);
        });
      }
      
      // Update system activity log
      const systemActivityLog = document.getElementById('systemActivityLog');
      
      if (activityLog.length === 0) {
        systemActivityLog.innerHTML = '<p>No system activity recorded.</p>';
      } else {
        let html = '';
        const recentLogs = activityLog.slice(0, 20); // Show only 20 most recent
        
        recentLogs.forEach(activity => {
          const date = new Date(activity.timestamp);
          const formattedDate = date.toLocaleDateString();
          const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          
          html += `
            <div class="log-entry">
              <strong>${activity.username}</strong> ${activity.action}
              ${activity.details ? ` - ${activity.details}` : ''}
              <div class="log-time">${formattedDate} ${formattedTime}</div>
            </div>
          `;
        });
        
        systemActivityLog.innerHTML = html;
      }
    }
    
    // Update system logs
    function updateSystemLogs() {
      const systemLogs = document.getElementById('systemLogs');
      
      // Get system-related activities
      const systemActivities = activityLog.filter(log => 
        log.action.includes('System') || 
        log.action.includes('Backup') || 
        log.action.includes('Restore') ||
        log.action.includes('Settings') ||
        log.action.includes('User') ||
        log.action.includes('Security')
      );
      
      if (systemActivities.length === 0) {
        systemLogs.innerHTML = '<p>No system logs available.</p>';
        return;
      }
      
      let html = '';
      systemActivities.slice(0, 10).forEach(activity => {
        const date = new Date(activity.timestamp);
        const formattedDate = date.toLocaleDateString();
        const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        html += `
          <div class="log-entry">
            <strong>${activity.username}</strong> ${activity.action}
            ${activity.details ? ` - ${activity.details}` : ''}
            <div class="log-time">${formattedDate} ${formattedTime}</div>
          </div>
        `;
      });
      
      systemLogs.innerHTML = html;
    }
    
    // Apply log filters
    function applyLogFilters() {
      // In a real application, this would filter the system logs based on selected filters
      updateSystemLogs();
    }
    
    // Update reports page
    function updateReportsPage() {
      const reportsContent = document.getElementById('reportsContent');
      
      if (filteredCashbills.length === 0) {
        reportsContent.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3>No cashbills found</h3>
            <p>Create your first cashbill to see reports here.</p>
          </div>
        `;
        document.getElementById('reportPagination').innerHTML = '';
        return;
      }
      
      // Pagination
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedCashbills = filteredCashbills.slice(startIndex, endIndex);
      
      let tableHTML = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Invoice #</th>
                <th>Customer</th>
                <th>User</th>
                <th>Date</th>
                <th>Total</th>
                <th>Payment</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      paginatedCashbills.forEach(bill => {
        // Use userName if available, otherwise fall back to finding user by ID
        const userName = bill.userName || (users.find(u => u.id === bill.userId)?.name || 'Unknown');
        const totalAmount = bill.grandTotal || 0;
        
        tableHTML += `
          <tr>
            <td>${bill.invoiceNumber}</td>
            <td>${bill.customerName}</td>
            <td>${userName}</td>
            <td>${new Date(bill.date).toLocaleDateString()}</td>
            <td>${systemSettings.currency}${totalAmount.toFixed(2)}</td>
            <td>${getPaymentMethodDisplayName(bill.paymentMethod)}</td>
            <td>${bill.status === 'draft' ? 'Draft' : bill.status === 'pending' ? 'Pending' : 'Committed'}</td>
          </tr>
        `;
      });
      
      tableHTML += `
            </tbody>
          </table>
        </div>
      `;
      
      reportsContent.innerHTML = tableHTML;
      
      // Update pagination
      updateReportPagination(filteredCashbills.length);
    }
    
    // Update report pagination
    function updateReportPagination(totalItems) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      let paginationHTML = '';
      
      if (totalPages > 1) {
        paginationHTML += `<button onclick="changeReportPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i> Previous</button>`;
        
        for (let i = 1; i <= totalPages; i++) {
          paginationHTML += `<button onclick="changeReportPage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
        }
        
        paginationHTML += `<button onclick="changeReportPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next <i class="fas fa-chevron-right"></i></button>`;
      }
      
      document.getElementById('reportPagination').innerHTML = paginationHTML;
    }
    
    // Change report page
    function changeReportPage(page) {
      const totalPages = Math.ceil(filteredCashbills.length / itemsPerPage);
      
      if (page < 1 || page > totalPages) return;
      
      currentPage = page;
      updateReportsPage();
    }
    
    // Apply report filters
    function applyReportFilters() {
      showLoading();
      
      const searchCustomer = document.getElementById('reportSearchCustomer').value.toLowerCase();
      const filterStatus = document.getElementById('reportFilterStatus').value;
      const filterPayment = document.getElementById('reportFilterPayment').value;
      const dateFrom = document.getElementById('reportDateFrom').value;
      const dateTo = document.getElementById('reportDateTo').value;
      
      filteredCashbills = cashbills.filter(bill => {
        // Customer name filter
        if (searchCustomer && !bill.customerName.toLowerCase().includes(searchCustomer)) {
          return false;
        }
        
        // Status filter
        if (filterStatus && bill.status !== filterStatus) {
          return false;
        }
        
        // Payment method filter
        if (filterPayment && bill.paymentMethod !== filterPayment) {
          return false;
        }
        
        // Date range filter
        const billDate = new Date(bill.date).toISOString().split('T')[0];
        if (dateFrom && billDate < dateFrom) {
          return false;
        }
        if (dateTo && billDate > dateTo) {
          return false;
        }
        
        return true;
      });
      
      currentPage = 1;
      updateReportsPage();
      hideLoading();
    }
    
    // Reset report filters
    function resetReportFilters() {
      document.getElementById('reportSearchCustomer').value = '';
      document.getElementById('reportFilterStatus').value = '';
      document.getElementById('reportFilterPayment').value = '';
      document.getElementById('reportDateFrom').value = '';
      document.getElementById('reportDateTo').value = '';
      
      filteredCashbills = [...cashbills];
      currentPage = 1;
      updateReportsPage();
    }
    
    // Export report to CSV
    function exportReportToCSV() {
      showLoading();
      
      let csv = 'Invoice Number,Customer,User,Date,Subtotal,Tax,Discount,Total,Payment Method,Status\n';
      
      filteredCashbills.forEach(bill => {
        const user = users.find(u => u.id === bill.userId);
        csv += `${bill.invoiceNumber},"${bill.customerName}",${user ? user.name : 'Unknown'},${new Date(bill.date).toLocaleDateString()},${(bill.subtotal || 0).toFixed(2)},${(bill.totalTax || 0).toFixed(2)},${(bill.totalDiscount || 0).toFixed(2)},${(bill.grandTotal || 0).toFixed(2)},${getPaymentMethodDisplayName(bill.paymentMethod)},${bill.status === 'draft' ? 'Draft' : bill.status === 'pending' ? 'Pending' : 'Committed'}\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `cashbills_report_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      // Log activity
      logActivity(currentUser.id, currentUser.name, 'Export Data', 'Exported cashbills report to CSV');
      
      hideLoading();
    }
    
    // Load all data from Google Sheets
    async function loadData() {
      try {
        // Load cashbills
        try {
          const cashbillsResponse = await fetch(`${API_URL}?action=get&sheet=cashbills`);
          if (cashbillsResponse.ok) {
            const serverCashbills = await cashbillsResponse.json();
            
            // Process cashbills to parse items
            cashbills = serverCashbills.map(bill => {
              // Ensure userId is a string for proper comparison
              if (bill.userId && typeof bill.userId !== 'string') {
                bill.userId = String(bill.userId);
              }
              
              // Parse items if it's a string
              if (typeof bill.items === 'string') {
                try {
                  bill.items = JSON.parse(bill.items);
                } catch (e) {
                  console.error("Error parsing items for cashbill", bill.invoiceNumber, ":", e);
                  bill.items = [];
                }
              }
              
              return bill;
            });
          } else {
            console.error("Failed to load cashbills:", cashbillsResponse.status);
            cashbills = [];
          }
        } catch (error) {
          console.error("Error loading cashbills:", error);
          cashbills = [];
        }
        
        // Load activity log
        try {
          const activityResponse = await fetch(`${API_URL}?action=get&sheet=activityLog`);
          if (activityResponse.ok) {
            activityLog = await activityResponse.json();
          } else {
            console.error("Failed to load activity log:", activityResponse.status);
            activityLog = [];
          }
        } catch (error) {
          console.error("Error loading activity log:", error);
          activityLog = [];
        }
        
        // Load notifications
        try {
          const notificationsResponse = await fetch(`${API_URL}?action=get&sheet=notifications`);
          if (notificationsResponse.ok) {
            notifications = await notificationsResponse.json();
          } else {
            console.error("Failed to load notifications:", notificationsResponse.status);
            notifications = [];
          }
        } catch (error) {
          console.error("Error loading notifications:", error);
          notifications = [];
        }
        
        // Load system settings
        try {
          const settingsResponse = await fetch(`${API_URL}?action=get&sheet=systemSettings`);
          if (settingsResponse.ok) {
            const settingsData = await settingsResponse.json();
            if (settingsData.length > 0) {
              systemSettings = settingsData[0];
            }
          } else {
            console.error("Failed to load system settings:", settingsResponse.status);
            // Use default systemSettings
          }
        } catch (error) {
          console.error("Error loading system settings:", error);
          // Use default systemSettings
        }
        
        // Load users from server
        try {
          const usersResponse = await fetch(`${API_URL}?action=get&sheet=users`);
          if (usersResponse.ok) {
            const serverUsers = await usersResponse.json();
            if (serverUsers.length > 0) {
              // Update local users array with server data
              users = serverUsers.map(user => ({
                id: String(user.id), // Ensure ID is string
                name: user.name,
                role: user.role,
                password: user.password
              }));
            }
          } else {
            console.error("Failed to load users:", usersResponse.status);
          }
        } catch (error) {
          console.error("Error loading users:", error);
        }
        
        // Initialize filtered cashbills
        filteredCashbills = [...cashbills];
        
        // Update UI
        updateDashboardStats();
        updateNotificationBadge();
      } catch (error) {
        console.error("Error in loadData:", error);
        alert("Error loading data from server. Some features may not work properly.");
      }
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Only apply shortcuts if not in an input field
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
        return;
      }
      
      switch(e.key.toLowerCase()) {
        case 'n':
          if (currentUser) showPage('newCashbillPage');
          break;
        case 'd':
          if (currentUser) showPage('dashboardPage');
          break;
        case 'l':
          if (currentUser) showPage('cashbillListPage');
          break;
        case 'r':
          if (currentUser) showPage('reportsPage');
          break;
      }
    });
    
    // Initialize the app
    window.addEventListener('load', async function() {
      // Load system settings
      document.querySelector('header h1').textContent = systemSettings.companyName + ' System';
      
      // Load data from server
      await loadData();
      
      // Update notification badge
      updateNotificationBadge();
    });
  </script>
</body>
</html>